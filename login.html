<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­ Vlog | å­¦å‘˜ç™»å½•</title>
    <!-- 1. ç”µè„‘æµè§ˆå™¨æ ‡ç­¾é¡µå›¾æ ‡ -->
<link rel="icon" type="image/png" href="logo.png">

<!-- 2. è‹¹æœ/å®‰å“æ‰‹æœºâ€œæ·»åŠ åˆ°æ¡Œé¢â€åçš„å›¾æ ‡ -->
<link rel="apple-touch-icon" href="logo.png">

<!-- 3. è®¾ç½®ç§»åŠ¨ç«¯çŠ¶æ€æ é¢œè‰²ï¼ˆè®©å®ƒæ›´åƒ Appï¼‰ -->
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- å¼•å…¥ä¿å®‰è„šæœ¬ -->
    <script src="auth.js"></script>
    
    <style>
        body { margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center; background: #f3f4f6; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            width: 320px; 
            text-align: center; 
        }

        .logo { 
            font-size: 24px; 
            font-weight: 800; 
            color: #8B3A3A; 
            margin-bottom: 30px; 
        }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        
        label { 
            display: block; 
            font-size: 13px; 
            color: #666; 
            margin-bottom: 8px; 
            font-weight: bold; 
        }
        
        input { 
            width: 100%; padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            box-sizing: border-box; 
            outline: none; 
            transition: border 0.2s;
            font-size: 14px;
        }
        input:focus { border-color: #6CAD9C; background: #fcfcfc; }
        
        .btn { 
            width: 100%; padding: 12px; 
            background: #6CAD9C; 
            color: white; border: none; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 15px; 
            font-size: 16px; 
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background: #ccc; cursor: not-allowed; } 
        
        .footer { 
            margin-top: 25px; 
            font-size: 12px; 
            color: #aaa; 
            line-height: 1.6; /* å¢åŠ è¡Œé«˜ï¼Œå¤šè¡Œæ˜¾ç¤ºä¸æ‹¥æŒ¤ */
        }
        #msg { color: #ef4444; font-size: 13px; margin-top: 15px; min-height: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="login-box">
        <div class="logo">ğŸ¼ æ±‰è¯­ Vlog è¯¾å ‚</div>
        
        <div class="input-group">
            <!-- ğŸŸ¢ æ ‡ç­¾ç›´æ¥åŒ…å«ä¸‰è¯­ -->
            <label>è´¦å· / Email / ĞĞºĞºĞ°ÑƒĞ½Ñ‚</label>
            <input type="email" id="email" placeholder="student@vip.com">
        </div>
        <div class="input-group">
            <!-- ğŸŸ¢ æ ‡ç­¾ç›´æ¥åŒ…å«ä¸‰è¯­ -->
            <label>å¯†ç  / Password / ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>

        <!-- ğŸŸ¢ æŒ‰é’®ç›´æ¥åŒ…å«ä¸‰è¯­ -->
        <button class="btn" onclick="handleLogin()" id="loginBtn">ç™»å½• / Login / Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>

        <div id="msg"></div>

        <!-- ğŸŸ¢ åº•éƒ¨æç¤ºä¸‰è¯­ -->
        <div class="footer">
            ä»…é™ä¼šå‘˜è®¿é—® Â· Members Only<br>
            Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
        </div>
    </div>

    <script>
        // ==========================================
        // Supabase é…ç½® (é€»è¾‘ä¿æŒä¸å˜)
        // ==========================================
        const LOGIN_URL = 'https://bwweaohahsafbecogist.supabase.co'; 
        const LOGIN_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3d2Vhb2hhaHNhZmJlY29naXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTk3MjMsImV4cCI6MjA4NDMzNTcyM30.ZqViPiwlvzzaqkWLMzejjpgHXeztkD0K0ne32kfGhWw';
        
        let loginClient = null;
        if (typeof window.supabase !== 'undefined') {
            loginClient = window.supabase.createClient(LOGIN_URL, LOGIN_KEY);
        }

        let isLoggingIn = false;

        async function handleLogin() {
            if (isLoggingIn) return; 
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('msg');
            const btn = document.getElementById('loginBtn');

            if(!email || !password) {
                msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç  / Please enter email & password";
                return;
            }

            isLoggingIn = true;
            btn.innerText = "éªŒè¯ä¸­ / Verifying..."; 
            btn.disabled = true;
            msg.innerText = "";

            try {
                if (!loginClient) throw new Error("System Error: Supabase not loaded");

                // 1. éªŒè¯
                const { data, error } = await loginClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // 2. äº’è¸¢é€»è¾‘
                const newToken = Date.now() + "_" + Math.random();
                const { error: updateError } = await loginClient
                    .from('profiles')
                    .upsert({ id: data.user.id, session_token: newToken });

                if (!updateError) {
                    localStorage.setItem('my_session_token', newToken);
                }

                // 3. æ‹‰å–å­˜æ¡£
                try {
                    const { data: profile } = await loginClient
                        .from('profiles')
                        .select('progress, access_tags')
                        .eq('id', data.user.id)
                        .maybeSingle();

                    if (profile) {
                        if(profile.progress) {
                            Object.keys(profile.progress).forEach(k => localStorage.setItem(k, profile.progress[k]));
                        }
                        if(profile.access_tags) {
                            localStorage.setItem('my_access_tags', JSON.stringify(profile.access_tags));
                        }
                    }
                } catch(e) { console.error("Sync Error", e); }

                // 4. è·³è½¬
                localStorage.setItem('login_immunity_time', Date.now());
                msg.style.color = 'green';
                msg.innerText = "âœ… æˆåŠŸ / Success! \næ­£åœ¨è·³è½¬...";
                
                setTimeout(() => {
                    window.location.href = 'home.html?from_login=1';
                }, 1000);

            } catch (err) {
                msg.style.color = 'red';
                let errMsg = err.message;
                if(errMsg === "Invalid login credentials") errMsg = "å¯†ç é”™è¯¯ / Wrong Password";
                msg.innerText = "Error: " + errMsg;
                
                isLoggingIn = false;
                btn.innerText = "ç™»å½• / Login / Ğ’Ğ¾Ğ¹Ñ‚Ğ¸"; 
                btn.disabled = false;
            }
        }

        document.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') handleLogin();
        });
    </script>
</body>
</html>
