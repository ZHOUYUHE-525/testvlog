<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 1. å¼•å…¥ Supabase (å¿…é¡»åœ¨æœ€å‰) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 2. ğŸ”´ åŠ ä¸Šè¿™è¡Œï¼è¿™å°±æ˜¯é”ï¼ -->
    <script src="auth.js"></script>
    
    <!-- 3. å¼•å…¥è¯¾ç¨‹æ•°æ® -->
    <script src="lesson_001.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6CAD9C; --dark-red: #612321; --brown: #A77046; --yellow: #E5CC84; --bg: #F9F7F2; --white: #FFFFFF; --highlight: #EAF6F4; --word-hover: #ffecb3; }
        body { margin: 0; padding: 0; font-family: "PingFang SC", sans-serif; background-color: var(--bg); height: 100vh; display: flex; flex-direction: column; color: var(--dark-red); }
        header { background: var(--white); padding: 0 40px; height: 60px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid var(--yellow); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-size: 20px; font-weight: 800; color: var(--dark-red); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .main-container { display: flex; flex: 1; padding: 20px 40px; gap: 30px; overflow: hidden; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; transition: all 0.3s ease; }
        body.focus-mode .subtitle-section { display: none; } body.focus-mode .video-section { flex: 1; max-width: 1000px; margin: 0 auto; }
        .video-section { flex: 7; display: flex; flex-direction: column; gap: 20px; min-width: 0; transition: all 0.3s ease; }
        .video-wrapper { background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 25px rgba(97, 35, 33, 0.15); border: 4px solid #fff; aspect-ratio: 16/9; position: relative; }
        video { width: 100%; height: 100%; display: block; outline: none; }
        .lang-switch { cursor: pointer; padding: 6px 12px; border-radius: 20px; background: #eee; font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .lang-switch:hover { background: #e0f2fe; color: var(--primary); }
        .audio-visualizer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4A3B32 0%, #2c241f 100%); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .audio-visualizer.active { display: flex; }
        .wave-container { display: flex; gap: 6px; height: 60px; align-items: center; }
        .wave-bar { width: 8px; background: var(--yellow); border-radius: 4px; animation: wave 1s infinite ease-in-out; }
        .wave-bar:nth-child(odd) { background: var(--primary); } .wave-bar:nth-child(1) { height: 20px; animation-delay: 0.1s; } .wave-bar:nth-child(2) { height: 40px; animation-delay: 0.2s; } .wave-bar:nth-child(3) { height: 50px; animation-delay: 0.3s; } .wave-bar:nth-child(4) { height: 30px; animation-delay: 0.4s; } .wave-bar:nth-child(5) { height: 40px; animation-delay: 0.5s; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(1.5); } }
        .tools-panel { background: var(--white); padding: 15px; border-radius: 12px; display: flex; flex-wrap: wrap; gap: 10px; border: 1px solid rgba(167, 112, 70, 0.1); justify-content: center; }
        .control-row { width: 100%; display: flex; justify-content: space-between; gap: 10px; }
        .control-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60px; flex: 1; border: 2px solid #eee; border-radius: 10px; background: white; color: var(--text-main); cursor: pointer; transition: all 0.2s; font-size: 12px; gap: 4px; min-width: 60px; }
        .control-btn:hover { border-color: var(--primary); color: var(--primary); }
        .btn-play { background: var(--primary); border-color: var(--primary); color: white; flex: 1.5; } .btn-play:hover { background: var(--primary-dark); }
        .control-btn.active { background: var(--highlight); border-color: var(--primary); color: var(--primary); }
        .speed-select { height: 60px; padding: 0 10px; border: 2px solid #eee; border-radius: 10px; background: white; font-weight: bold; color: var(--brown); outline: none; cursor: pointer; flex: 0.8; text-align: center;}
        .practice-btn { width: 100%; height: 55px; margin-top: 5px; border: none; border-radius: 12px; background: linear-gradient(90deg, #E5CC84 0%, #d4b158 100%); color: #4A3B32; font-weight: 800; font-size: 16px; letter-spacing: 1px; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 10px rgba(229, 204, 132, 0.4); }
        .practice-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(229, 204, 132, 0.6); } .practice-btn i { font-size: 22px; }
        .subtitle-section { flex: 4; background: var(--white); border-radius: 12px; display: flex; flex-direction: column; height: 100%; border: 1px solid rgba(167, 112, 70, 0.1); }
        .sub-header { padding: 20px; border-bottom: 2px solid var(--bg); display: flex; justify-content: space-between; align-items: center; }
        .sub-title { font-weight: 800; font-size: 16px; color: var(--dark-red); max-width: 50%; }
        .header-actions { display: flex; gap: 10px; }
        .toggle-circle { width: 36px; height: 36px; border-radius: 50%; background: #eee; color: #999; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .toggle-circle.on { background: var(--primary); color: white; } .toggle-circle:hover { transform: scale(1.1); }
        .subtitle-list { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; position: relative; }
        .sub-item { padding: 16px; margin-bottom: 12px; border-radius: 8px; cursor: pointer; border-left: 4px solid transparent; background: #fff; transition: all 0.2s; }
        .sub-item:hover { background-color: var(--bg); }
        .sub-item.active { background-color: var(--highlight); border-left-color: var(--primary); transform: scale(1.02); }
        .pinyin { font-size: 14px; color: var(--brown); margin-bottom: 4px; font-family: "Courier New", monospace; }
        .chinese { font-size: 20px; color: var(--dark-red); font-weight: 800; margin-bottom: 6px; line-height: 1.5; }
        .trans { font-size: 13px; color: #888; font-style: italic; }
        .hide-py .pinyin { opacity: 0; } .hide-py .sub-item:hover .pinyin { opacity: 1; } .hide-cn .chinese { opacity: 0; } .hide-cn .sub-item:hover .chinese { opacity: 1; } .hide-trans .trans { opacity: 0; } .hide-trans .sub-item:hover .trans { opacity: 1; }
        body.word-mode .sub-item { cursor: default; } body.word-mode .sub-item:hover { background-color: white; }
        .word-span { border-radius: 4px; padding: 0 2px; transition: all 0.2s; cursor: pointer; } body.word-mode .word-span:hover { background-color: var(--yellow); color: var(--dark-red); }
        .dict-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 2px solid var(--primary); z-index: 1000; display: none; text-align: center; }
        .dict-modal.show { display: block; animation: popIn 0.3s; }
        @keyframes popIn { from {opacity:0; transform:translate(-50%, -40%);} to {opacity:1; transform:translate(-50%, -50%);} }
        .dict-word { font-size: 32px; font-weight: bold; color: var(--dark-red); margin-bottom: 5px; } .dict-pinyin { font-size: 16px; color: var(--brown); margin-bottom: 15px; font-family: "Courier New"; } .dict-meaning { font-size: 16px; color: #555; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px; text-align: left; } .dict-btn { padding: 8px 20px; background: var(--primary); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; } .dict-close { position: absolute; top: 10px; right: 15px; cursor: pointer; color: #999; font-size: 20px; } .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:999; display:none; } .overlay.show { display: block; }
        /* å¼¹çª—æŒ‰é’®æ ·å¼ */
        .dict-btn-link, .dict-btn-add {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 8px 0; border-radius: 8px; font-size: 13px; font-weight: bold;
            text-decoration: none; cursor: pointer; border: none; transition: all 0.2s;
        }
        /* BKRS æŒ‰é’® (è“è‰²) */
        .dict-btn-link { background: #e0f2fe; color: #0369a1; }
        .dict-btn-link:hover { background: #bae6fd; }
        
        /* ç”Ÿè¯æœ¬æŒ‰é’® (é»„è‰²) */
        .dict-btn-add { background: #fef3c7; color: #b45309; }
        .dict-btn-add:hover { background: #fde68a; }
        /* === ğŸ“± è§†é¢‘é¡µæ‰‹æœºç«¯ï¼šç€‘å¸ƒæµå¼å¸ƒå±€ (å­—å¹•é“ºæ»¡) === */
        /* === ğŸ“± æ‰‹æœºç‰ˆï¼šä¸ŠåŠéƒ¨åˆ†å›ºå®šï¼Œä¸‹åŠéƒ¨åˆ†æ»šåŠ¨ === */
        @media (max-width: 768px) {
            /* 1. é”æ­»å¤§ç½‘é¡µï¼Œç¦æ­¢æ™ƒåŠ¨ */
            body { 
                height: 100vh !important; 
                overflow: hidden !important; 
                display: flex;
                flex-direction: column;
            }

            /* 2. å®¹å™¨æ’‘æ»¡å±å¹• */
            .main-container { 
                flex: 1; 
                display: flex !important; 
                flex-direction: column !important;
                padding: 0 !important; 
                overflow: hidden !important; 
            }

            /* 3. è§†é¢‘åŒºï¼šå›ºå®šé«˜åº¦ */
            .video-section { flex: none !important; width: 100%; padding: 0; }
            .video-wrapper { border-radius: 0; border: none; aspect-ratio: 16/9; }

            /* --- 4. æç®€åŠŸèƒ½é”®æ ï¼š8ä¸ªæŒ‰é’®æŒ¤æˆä¸€è¡Œï¼ˆæ¸…ç†é‡å ç‰ˆï¼‰ --- */
            .tools-panel { 
                /* ã€é—´è·è°ƒèŠ‚ã€‘ç¬¬ä¸€ä¸ªæ•°å­— 0px æ§åˆ¶è§†é¢‘ä¸æŒ‰é’®çš„è·ç¦» */
                padding: 0px 6px !important; 
                border: none; 
                background: #f9f9f9; 
                gap: 0 !important; 
            }
            .control-row { 
                display: grid !important; 
                /* åˆ’åˆ† 8 ä¸ªç­‰å®½åº§ä½ */
                grid-template-columns: repeat(8, 1fr) !important; 
                /* æŒ‰é’®ä¹‹é—´çš„å·¦å³è·ç¦» */
                gap: 2px !important; 
                width: 100% !important;
                margin: 0 !important;
            }
            
            /* æŒ‰é’®ç»Ÿä¸€å°ºå¯¸ */
            .control-btn, .practice-btn { 
                height: 32px !important; /* ğŸ‘ˆ æ§åˆ¶æŒ‰é’®é«˜çŸ® */
                padding: 0 !important; 
                font-size: 14px !important; /* å›¾æ ‡å¤§å° */
                border-radius: 6px !important;
                box-shadow: none !important;
                margin: 0 !important;
                flex: none !important;
                width: 100% !important;
            }
            /* å¼ºåˆ¶éšè—æ–‡å­— */
            .control-btn span, .practice-btn span { display: none !important; }

            /* ğŸ”´ é‡æ–°æ’åº§ï¼ˆè¿™æ˜¯æ‚¨è¦çš„å¯¹ç§°æ•ˆæœï¼‰ ğŸ”´ */

            /* 1. å¾ªç¯æŒ‰é’®ï¼šåç¬¬ 1 ä½ */
            #loopBtn { 
                grid-row: 1 !important; 
                grid-column: 1 / 2 !important; 
            }

            /* 2. ç»ƒä¹ æŒ‰é’®ï¼ˆé»„è‰²çš„ï¼‰ï¼šåç¬¬ 7 ä½ */
            .practice-btn { 
                grid-row: 1 !important; 
                grid-column: 7 / 8 !important; 
            }
            
            /* 3. é€Ÿåº¦æŒ‰é’®ï¼ˆ1.0xï¼‰ï¼šåç¬¬ 8 ä½ï¼ˆæœ€å³è¾¹ï¼‰ */
            .speed-select { 
                grid-row: 1 !important; 
                grid-column: 8 / 9 !important; 
                height: 32px !important; 
                width: 100% !important; 
                font-size: 10px !important; 
                padding: 0 !important;
                margin: 0 !important;
                border: 1px solid #eee;
                border-radius: 6px;
            }

            /* ä¸­é—´é‚£ 5 ä¸ªæ’­æ”¾æ§åˆ¶é”®ä¼šè‡ªåŠ¨ååœ¨ 2,3,4,5,6 è¿™å‡ ä¸ªä½ç½® */
            /* ä¸­é—´é‚£ 5 ä¸ªæ’­æ”¾æ§åˆ¶é”®ï¼ˆä¸Šä¸€å¥ã€-5sç­‰ï¼‰ä¼šè‡ªåŠ¨å¡«æ»¡ç¬¬ 2 åˆ°ç¬¬ 6 ä¸ªä½ç½® */
            
            /* æŒ‰é’®ç¼©å°ï¼šå»æ‰æ–‡å­—ï¼Œåªç•™å›¾æ ‡ */
            .control-btn, .practice-btn { 
                height: 26px !important; 
                padding: 0 !important; 
                font-size: 12px !important;
                border-radius: 6px !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
        
            
        

            /* 5. ğŸ”´ å¤§é¢ç§¯å­—å¹•åŒºï¼šå æ®ä¸‹æ–¹æ‰€æœ‰ç©ºé—´ */
            .subtitle-section { 
                flex: 1 !important; 
                display: flex !important;
                flex-direction: column !important;
                min-height: 0; 
                margin: 0 !important;
                border: none !important;
                background: #fff !important;
                width: 100% !important;
                max-width: 100% !important;
                position: relative !important;
                top: 0 !important;
                transform: none !important;
                box-shadow: none !important;
            }

            /* æ ‡é¢˜æ å›ºå®š */
            .sub-header {
                flex: none !important;
                padding: 0px 15px;
                border-bottom: 1px solid #eee;
                background: #fff;
            }

            /* å­—å¹•åˆ—è¡¨ï¼šå½»åº•å¼€å¯ï¼Œèƒ½çœ‹å¤šå°‘çœ‹å¤šå°‘ */
            .subtitle-list { 
                flex: 1 !important;
                overflow-y: auto !important; 
                padding: 10px 15px !important; 
                height: auto !important;
                max-height: none !important; /* ğŸ‘ˆ è§£é™¤å•è¡Œé™åˆ¶ */
            }

            /* å­—å¹•é¡¹ï¼šé—´è·å›å½’æ­£å¸¸ */
            .sub-item {
                margin-bottom: 20px !important; 
                padding: 5px !important;
                text-align: center;
                border-bottom: 1px solid #f5f5f5;
            }
            
            /* æŸ¥è¯æ¡†é€‚é… */
            .dict-modal { width: 90% !important; }
        }
        /* --- ğŸ”´ åªåœ¨å¼€å¯ä¸Šä¸‹å¸ƒå±€æ¨¡å¼æ—¶ç”Ÿæ•ˆçš„â€œè¡¥ä¸â€ --- */

/* --- ğŸ”´ å¼¹æ€§ç­‰é«˜ç‰ˆï¼šä¸Šä¸‹å¸ƒå±€æ¨¡å¼ --- */

/* --- è€å¸ˆä¸“å±ï¼šåŠŸèƒ½é”®æ‹‰é«˜ç¾åŒ–ç‰ˆ --- */

body.vertical-mode .video-section {
    position: fixed;
    top: 60px;
    left: 0;
    width: 100%;
    z-index: 1000;
    background: #fff; 
    display: flex; 
    flex-direction: row; 
    padding: 10px 25px;
    gap: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.06);
    box-sizing: border-box;
    /* ğŸ‘ˆ å…³é”®ï¼šè®©å³ä¾§é¢æ¿çš„é«˜åº¦å¼ºåˆ¶ç­‰äºå·¦ä¾§è§†é¢‘é«˜åº¦ */
    align-items: stretch; 
    justify-content: center;
}

body.vertical-mode .video-wrapper {
    flex: 1; 
    max-width: 1000px; /* å®½å±ä¸‹å…è®¸è§†é¢‘æ›´å¤§ */
    min-width: 0;
    border-radius: 12px;
}

body.vertical-mode .tools-panel {
    flex: 0 0 160px; /* å›ºå®šä¸€ä¸ªåˆé€‚çš„å®½åº¦ */
    background: #fdfaf5;
    padding: 12px;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    /* ğŸ‘ˆ å…³é”®ï¼šè®©å†…éƒ¨çš„æŒ‰é’®å®¹å™¨å æ®æ‰€æœ‰é«˜åº¦ */
    justify-content: space-between; 
    box-sizing: border-box;
}

body.vertical-mode .control-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    /* ğŸ‘ˆ å…³é”®ï¼šè®©è¿™ä¸ªå®¹å™¨å¡«æ»¡ tools-panel å‰©ä¸‹çš„ç©ºé—´ */
    flex: 1; 
    justify-content: space-between; 
}

/* ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šå¤§å¹…å¢åŠ æŒ‰é’®é«˜åº¦ */
body.vertical-mode .control-btn {
    width: 100%;
    /* ğŸ‘ˆ ä½¿ç”¨ flex: 1 è®©æŒ‰é’®è‡ªåŠ¨ç“œåˆ†é«˜åº¦ï¼Œä½†é™åˆ¶ä¸€ä¸ªæœ€å¤§å€¼é˜²æ­¢å˜æˆç –å¤´ */
    flex: 1;
    min-height: 45px; 
    max-height: 65px; 
    
    background: white;
    border: 1px solid #eee;
    border-radius: 12px;
    flex-direction: row;
    justify-content: flex-start;
    padding: 0 15px;
    gap: 12px;
    font-size: 14px;
    color: var(--dark-red);
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}

body.vertical-mode .btn-play {
    background: var(--primary);
    color: white;
    border: none;
    justify-content: center;
    max-height: 80px; /* æ’­æ”¾æŒ‰é’®å¯ä»¥æ›´é«˜ä¸€ç‚¹ */
}

/* ç»ƒä¹ æŒ‰é’®ä¹Ÿæ‹‰é«˜ */
body.vertical-mode .practice-btn {
    height: 60px; /* å›ºå®šä¸€ä¸ªæ¯”è¾ƒå¤§çš„é«˜åº¦ */
    flex: none;
    margin-top: 10px;
    font-size: 15px;
    border-radius: 12px;
}

/* é€Ÿåº¦é€‰æ‹©æ¡† */
body.vertical-mode .speed-select {
    width: 100%;
    height: 45px;
    flex: none;
    border-radius: 10px;
    border: 1px solid #eee;
}

/* é’ˆå¯¹çª„å±çš„ä¿æŠ¤é€»è¾‘ä¿æŒä¸å˜ */
@media (max-width: 1150px) {
    body.vertical-mode .tools-panel { flex: 0 0 70px; padding: 10px 5px; }
    body.vertical-mode .control-btn span, body.vertical-mode .practice-btn span { display: none; }
    body.vertical-mode .control-btn { justify-content: center; padding: 0; }
}

/* --- ğŸ”´ è€å¸ˆä¸“ç”¨ï¼šä¸Šä¸‹æ¨¡å¼â€œå•è¡Œçª—å£â€è¡¥ä¸ --- */

/* 1. å¼€å¯ä¸Šä¸‹æ¨¡å¼æ—¶ï¼Œé”æ­»ç½‘é¡µï¼Œç¦æ­¢æ•´é¡µæ»šåŠ¨ */
body.vertical-mode { 
    height: 100vh; 
    overflow: hidden; 
}

/* --- ğŸ”´ åªæ”¹åŠ¨è¿™ä¸€å—ï¼šè°ƒæ•´ç›’å­ä½ç½®ã€å®½åº¦å’Œå¼ºåˆ¶æ˜¾ç¤ºå¼€å…³ --- */
body.vertical-mode .subtitle-section {
    position: fixed;
    top: 650px; /* ğŸ‘ˆ å¾€ä¸Šæä¸€ç‚¹ï¼Œç¡®ä¿ä¸æŒ¡ä½æ ‡é¢˜å’Œå¼€å…³ */
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 1600px;
    height: 160px; /* ğŸ‘ˆ ç›’å­ç»™å¤Ÿ 320px é«˜åº¦ï¼Œä¿è¯ç¿»è¯‘ç»å¯¹èƒ½è£…ä¸‹ */
    background: white;
    z-index: 900;
    display: flex !important;
    flex-direction: column;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* --- ğŸ”´ ä¿®æ­£ï¼šç”¨æ™ºèƒ½å¯¹é½å–ä»£æ­»æ•°å­— gapï¼Œå®ç°éšå±ç¼©çŸ­ --- */
body.vertical-mode .sub-header {
    display: flex !important;
    visibility: visible !important;
    /* å·¦å³å†…è¾¹è·ï¼šå’Œé¡¶éƒ¨çš„ Header ä¿æŒä¸€è‡´ï¼Œè¿™æ ·å¼€å…³å°±æ­£å¥½åœ¨å³ä¾§åŠŸèƒ½é”®ä¸‹æ–¹ */
    padding: 5px 30px !important; 
    background: #fff;
    border-bottom: 1px solid #eee;

    /* 1. ğŸ‘ˆ æ ¸å¿ƒä¿®æ”¹ï¼šå¤§å±åˆ†å±…ä¸¤ä¾§ï¼Œå°å±è‡ªåŠ¨ç¼©çŸ­ä¸­é—´ç©ºéš™ */
    justify-content: space-between !important; 
    
    /* 2. ğŸ‘ˆ ç¡®ä¿å‚ç›´å±…ä¸­å¯¹é½ */
    align-items: center !important;
    
    /* 3. ğŸ‘ˆ é˜²æ­¢æ–‡å­—è¢«æŒ¤å‹æˆç«–æ’ */
    white-space: nowrap !important;
    gap: 20px; /* ä¿è¯æœ€æŒ¤çš„æ—¶å€™ä¹Ÿæœ‰ 20px çš„ç¼éš™ */
}

/* ä¿æŠ¤æ ‡é¢˜ï¼Œé˜²æ­¢æ ‡é¢˜å¤ªé•¿æŒ¤æ‰å¼€å…³ */
body.vertical-mode .sub-title {
    max-width: 70%;
    overflow: hidden;
    text-overflow: ellipsis; /* æ ‡é¢˜å¤ªé•¿æ˜¾ç¤ºçœç•¥å· */
    white-space: nowrap;
}

/* --- 3. å†…éƒ¨æ»šåŠ¨åŒºåŸŸï¼ˆå­—å¹•åœ¨é‡Œé¢è·‘çš„é‚£ä¸ªç©ºé—´ï¼‰ --- */
body.vertical-mode .subtitle-list {
    flex: 1 !important;
    overflow-y: auto !important;
    /* ã€å†…è¾¹è·ã€‘ç¬¬ä¸€ä¸ª10æ˜¯ä¸Šä¸‹ï¼Œç¬¬äºŒä¸ª1æ˜¯å·¦å³ã€‚
       å¦‚æœæƒ³è®©ç¬¬ä¸€å¥å­—å¹•å‡ºç°æ—¶ä¸è¦æ­»è´´ç€æ ‡é¢˜æ ï¼ŒæŠŠç¬¬ä¸€ä¸ª10æ”¹å¤§ï¼ˆå¦‚ 30ï¼‰ */
    padding: 5px 1px !important; 
    scroll-behavior: smooth;
}

/* 4. å­—å¹•é¡¹åœ¨ç›’å­é‡Œé—´è·æ‹‰å¤§ï¼Œç¡®ä¿ä¸€æ¬¡åªçœ‹ä¸€å¥ */
/* --- ğŸ”´ åªæ”¹åŠ¨è¿™ä¸€å—ï¼šå‹ç¼©å­—å¹•å—å†…éƒ¨é—´è·ï¼Œè®©ç¿»è¯‘éœ²å‡ºæ¥ --- */
body.vertical-mode .sub-item {
    /* ğŸ‘ˆ é‡ç‚¹ï¼šæ¯ä¸€å¥ä¹‹é—´ç©ºå‡º 100pxï¼Œç¡®ä¿æ»šåŠ¨æ—¶ç›’å­é‡Œåªå‰©è¿™ä¸€å¥ */
    
    margin-bottom: 80px !important; 
    
    /* ğŸ‘ˆ é‡ç‚¹ï¼šå‹ç¼©å†…éƒ¨ï¼Œè®©æ‹¼éŸ³ã€æ±‰å­—ã€ç¿»è¯‘æŠ±å¾—æ›´ç´§ï¼Œä¸ç•™ç©ºä½ */
    padding: 0 !important; 
    padding-left: 0% !important; 
    padding-right: 15% !important; 
    box-sizing: border-box !important; 
    background: transparent !important;
    text-align: center;
    display: flex;
    flex-direction: column;  
    gap: 1px; /* ğŸ‘ˆ æ‹¼éŸ³æ±‰å­—ç¿»è¯‘ä¹‹é—´çš„å¾®å°ç¼éš™ */
}
/* --- ğŸ”´ å­—å¹•å†…å®¹é†’ç›®åŒ–è¡¥ä¸ --- */
body.vertical-mode .sub-item {
    margin-bottom: 180px !important; /* ğŸ‘ˆ é—´è·æ‹‰å¤§åˆ° 150ï¼Œé˜²æ­¢å¤§å­—ä½“å¹²æ‰° */
    padding-right: 12% !important; 
    box-sizing: border-box !important; 
    text-align: center;
    display: flex;
    flex-direction: column;  
    gap: 1px !important; /* ğŸ‘ˆ è°ƒå¤§åˆ° 8pxï¼Œé˜²æ­¢æ‹¼éŸ³å’Œæ±‰å­—æŒ¤åœ¨ä¸€èµ· */
}

/* --- ğŸ”´ ä¸‹é¢æ˜¯æ–°å¢çš„å­—ä½“æ§åˆ¶ï¼š --- */

/* æ±‰å­—ï¼šå®£ä¼ è§†é¢‘çš„ä¸»è§’ï¼Œè¦æœ€å¤§ã€æœ€é»‘ */
body.vertical-mode .sub-item .chinese {
    font-size: 36px !important; /* ğŸ‘ˆ è°ƒå¤§å­—å·ï¼Œå»ºè®® 32px - 40px ä¹‹é—´ */
    font-weight: 800 !important; /* ğŸ‘ˆ åŠ ç²—åˆ°æè‡´ */
    color: var(--dark-red); /* ä¿æŒä½ çš„æ·±çº¢è‰²ï¼Œéå¸¸é†’ç›® */
    line-height: 1.2;
}

/* æ‹¼éŸ³ï¼šè¾…åŠ©é˜…è¯»ï¼Œé€‚ä¸­å¤§å° */
body.vertical-mode .sub-item .pinyin {
    font-size: 18px !important; /* ğŸ‘ˆ è°ƒå¤§åˆ° 18px */
    font-weight: 500;
    color: var(--brown);
}

/* ç¿»è¯‘ï¼šå®£ä¼ è§†é¢‘ä¹Ÿè¦çœ‹æ¸…æ„æ€ */
body.vertical-mode .sub-item .trans {
    font-size: 16px !important; /* ğŸ‘ˆ è°ƒå¤§åˆ° 16px */
    color: #666; /* ç°è‰²ç¨å¾®åŠ æ·±ä¸€ç‚¹ */
    font-style: italic;
}
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.href='home.html'"><i class="fas fa-chevron-left"></i> <span data-i18n="back">è¿”å›è¯¾ç¨‹å¤§å…</span></div>
        <div style="display:flex; gap:15px;">
            <button class="control-btn" onclick="toggleWordMode()" id="wordModeBtn" style="width:auto; height:40px; padding:0 15px; flex-direction:row;">
                <i class="fas fa-book-open"></i> <span data-i18n="word_mode">æŸ¥è¯æ¨¡å¼: å…³</span>
            </button>
            <button class="control-btn" onclick="toggleAudioMode()" id="audioModeBtn" style="width:auto; height:40px; padding:0 15px; flex-direction:row;">
                <i class="fas fa-headphones"></i> <span data-i18n="audio_mode">éŸ³é¢‘æ¨¡å¼</span>
            </button>
            <button class="control-btn" onclick="toggleFullscreen()" id="fullscreenBtn" style="width:auto; height:40px; padding:0 15px; flex-direction:row; background:var(--bg); border:none;"><i class="fas fa-expand"></i></button>
            <button class="control-btn" onclick="toggleDesktopLayout()" id="layoutToggleBtn" style="width:auto; height:40px; padding:0 15px; flex-direction:row; margin-right:10px;">
    <i class="fas fa-columns"></i> <span id="layoutText">å·¦å³å¸ƒå±€</span>
</button>
            <div class="lang-switch" onclick="toggleLang()"><i class="fas fa-globe"></i> <span id="langLabel">RU</span></div>
        </div>
    </header>

    <div class="main-container">
        <div class="video-section">
            <div class="video-wrapper">
                <video id="myVideo" controls><source src="" type="video/mp4"></video>
                <div class="audio-visualizer" id="audioVisualizer"><div class="wave-container"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div><div class="audio-text">Playing...</div></div>
            </div>
            <div class="tools-panel">
                <div class="control-row">
                    <button class="control-btn" onclick="seekRelative(-1)"><i class="fas fa-step-backward"></i><span data-i18n="prev">ä¸Šä¸€å¥</span></button>
                    <button class="control-btn" onclick="video.currentTime -= 5"><i class="fas fa-undo"></i><span>-5s</span></button>
                    <button class="control-btn btn-play" onclick="togglePlay()"><i class="fas fa-play" id="playIcon"></i></button>
                    <button class="control-btn" onclick="video.currentTime += 5"><i class="fas fa-redo"></i><span>+5s</span></button>
                    <button class="control-btn" onclick="seekRelative(1)"><i class="fas fa-step-forward"></i><span data-i18n="next">ä¸‹ä¸€å¥</span></button>
                    <button class="control-btn" id="loopBtn" onclick="toggleLoop()"><i class="fas fa-sync-alt"></i><span data-i18n="loop">å¾ªç¯</span></button>
                    <select class="speed-select" onchange="changeSpeed(this.value)"><option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1.0" selected>1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option></select>
                </div>
                <button class="practice-btn" onclick="goToPractice()"><i class="fas fa-graduation-cap"></i><span data-i18n="start_practice">å¼€å§‹æœ¬è¯¾ç»ƒä¹ </span></button>
            </div>
        </div>
        <div class="subtitle-section" id="subContainer">
            <div class="sub-header">
                <div class="sub-title" id="lessonTitle">Loading...</div>
                <div class="header-actions">
                    <div class="toggle-circle on" onclick="toggleVisibility('py', this)">æ‹¼</div>
                    <div class="toggle-circle on" onclick="toggleVisibility('cn', this)">æ±‰</div>
                    <div class="toggle-circle on" id="transToggle" onclick="toggleVisibility('trans', this)">RU</div>
                </div>
            </div>
            <div class="subtitle-list" id="subtitleList"></div>
        </div>
    </div>

    <!-- 1. å…³é”®ï¼šå¼•å…¥ä¸­å¤®æ•°æ®åº“ -->
    <!-- 1. å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2. å¼•å…¥äº‘ç«¯åŠ è½½å™¨ -->
    <script src="lesson_001.js"></script>
    <script src="lesson_002.js"></script> 
    <script src="lesson_003.js"></script>
    <script src="lesson_004.js"></script>
    <script src="lesson_005.js"></script>
    <script src="lesson_006.js"></script>
    <script src="lesson_007.js"></script> 
    <script src="lesson_008.js"></script>
    <script src="lesson_009.js"></script>
    <script src="lesson_010.js"></script>
    <script src="lesson_011.js"></script>
    <script src="lesson_012.js"></script>
    <script src="lesson_013.js"></script>
    <script src="lesson_014.js"></script>
    <script src="lesson_015.js"></script>
    <script src="lesson_016.js"></script>
    <script src="lesson_017.js"></script>
    
    <script src="lesson_401.js"></script>
    <script src="lesson_402.js"></script>
    <script src="lesson_403.js"></script>
    <script src="lesson_404.js"></script>
    <script src="lesson_405.js"></script>
    <script src="lesson_406.js"></script>
    <script src="lesson_407.js"></script>
    
    <!-- === è¡¥ä¸ 1ï¼šæŸ¥è¯å¼¹çª— (æ’å…¥åœ¨ </body> ä¹‹å‰) === -->
    <div class="overlay" id="overlay" onclick="closeDict()"></div>
    <div class="dict-modal" id="dictModal">
        <div class="dict-close" onclick="closeDict()">Ã—</div>
        <div class="dict-word" id="d-word">åŠ è½½ä¸­...</div>
        <div class="dict-pinyin" id="d-pinyin">...</div>
        <div class="dict-meaning" id="d-mean">
            <i class="fas fa-spinner fa-spin"></i> AI æ­£åœ¨æ€è€ƒ...
        </div>
    </div>

    <script>
        // === 2. ä½¿ç”¨æ•°æ®åº“ ===
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id') || "1";
        
        // ç¡®ä¿æ•°æ®åº“å·²åŠ è½½
        let lesson = null;
        if (window.lessonDatabase) {
            lesson = window.lessonDatabase[id];
        } else {
            alert("Error: data.js not found!");
        }

        const video = document.getElementById('myVideo');
        const list = document.getElementById('subtitleList');
        const container = document.getElementById('subContainer');
        const playIcon = document.getElementById('playIcon');
        let loopEnabled = false, activeIndex = -1, isAudioMode = false, isWordMode = false;
        let currentLang = 'ru'; 
        // === è¡¥ä¸ 2ï¼šæŸ¥è¯æ ¸å¿ƒé€»è¾‘ (æ’å…¥åœ¨ let currentLang = 'ru'; ä¸‹é¢) ===
        
        // ğŸ”´ğŸ”´ğŸ”´ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ API Key ğŸ”´ğŸ”´ğŸ”´
        const API_KEY = "sk-..."; 

        function toggleWordMode() {
            isWordMode = !isWordMode;
            const btn = document.getElementById('wordModeBtn');
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            if (isWordMode) {
                btn.classList.add('active');
                btn.innerHTML = `<i class="fas fa-book-open"></i> ${uiDict[currentLang].word_mode_on || "æŸ¥è¯: å¼€"}`;
            } else {
                btn.classList.remove('active');
                btn.innerHTML = `<i class="fas fa-book-open"></i> ${uiDict[currentLang].word_mode || "æŸ¥è¯: å…³"}`;
            }
            // é‡æ–°æ¸²æŸ“å­—å¹•ï¼ŒæŠŠæ–‡å­—å˜æˆå¯ç‚¹å‡»çš„çŠ¶æ€
            renderSubtitles();
        }

        // === ğŸŸ¢ ç»ˆæä¿®å¤ç‰ˆï¼šæŸ¥è¯å¼¹çª— (åŒè¯­æ˜¾ç¤º + åŒè¯å…¸) ===
        function lookupWord(word, event) {
            event.stopPropagation(); 
            video.pause(); 

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('overlay').classList.add('show');
            document.getElementById('dictModal').classList.add('show');
            document.getElementById('d-word').innerText = word;
            
            // è·å–æœ¬åœ°æ•°æ®
            const dictData = lesson.dictionary && lesson.dictionary[word];

            let html = '';

            if (dictData) {
                // 1. æ‹¼éŸ³
                document.getElementById('d-pinyin').innerText = dictData.py || "";
                
                // 2. ä¿„è¯­å«ä¹‰ (ä¸»é‡Šä¹‰ï¼ŒåŠ ç²—å¤§å­—)
                html += `<div style="font-weight:bold; font-size:18px; color:#333; margin-bottom:4px;">${dictData.mean}</div>`;
                
                // 3. âœ… æ‰¾å›è‹±è¯­å«ä¹‰ (å¦‚æœæœ‰ï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹)
                if (dictData.mean_en) {
                    html += `<div style="font-size:14px; color:#666; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">ğŸ‡ºğŸ‡¸ ${dictData.mean_en}</div>`;
                } else {
                    html += `<div style="margin-bottom:10px;"></div>`; // å ä½
                }
                
                // 4. è¯ç»„
                if(dictData.phrases && dictData.phrases.length > 0) {
                    html += `<div style="font-size:13px; color:#555; margin-bottom:8px; background:#f3f4f6; padding:6px; border-radius:6px;">
                        ğŸ”¹ ${dictData.phrases.join(', ')}
                    </div>`;
                }
                
                // 5. ä¾‹å¥
                if(dictData.ex) {
                    const exText = dictData.ex.replace(/\n/g, '<br>');
                    html += `<div style="font-size:13px; color:#444; background:#fffbeb; padding:8px; border-radius:6px; border-left:3px solid #f59e0b; line-height:1.4;">
                        ${exText}
                    </div>`;
                }
            } else {
                document.getElementById('d-pinyin').innerText = "---";
                html += `<div style="color:#999; margin-bottom:10px;">(è¯¥è¯æ±‡æœªæ”¶å½•åœ¨ç¦»çº¿è¯å…¸ä¸­)</div>`;
            }

            // 6. âœ… åº•éƒ¨æŒ‰é’®åŒº (ä¸¤æ’å¸ƒå±€)
            html += `
                <div style="margin-top:15px; display:flex; gap:8px;">
                    <!-- ä¿„è¯­è¯å…¸ BKRS -->
                    <a href="https://bkrs.info/slovo.php?ch=${word}" target="_blank" class="dict-btn-link" style="flex:1; background:#e0f2fe; color:#0369a1;">
                        ğŸ‡·ğŸ‡º BKRS
                    </a>
                    <!-- è‹±è¯­è¯å…¸ MDBG -->
                    <a href="https://www.mdbg.net/chinese/dictionary?page=worddict&wdrst=0&wdq=${word}" target="_blank" class="dict-btn-link" style="flex:1; background:#fce7f3; color:#be185d;">
                        ğŸ‡ºğŸ‡¸ MDBG
                    </a>
                </div>
                <!-- æ”¶è—æŒ‰é’® -->
                <div style="margin-top:8px;">
                    <button onclick="addToNotebook('${word}')" class="dict-btn-add" style="width:100%;">
                        â­ åŠ å…¥ç”Ÿè¯æœ¬
                    </button>
                </div>
            `;

            document.getElementById('d-mean').innerHTML = html;
        }

        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šåŠ å…¥ç”Ÿè¯æœ¬ (åŒæ—¶åˆå§‹åŒ–å¤ä¹ è¿›åº¦) ===
        function addToNotebook(word) {
            // 1. è¯»å–æ—§åˆ—è¡¨
            let vocabList = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
            
            // 2. æŸ¥é‡
            if (vocabList.includes(word)) {
                alert(`"${word}" å·²ç»åœ¨ä½ çš„ç”Ÿè¯æœ¬é‡Œå•¦ï¼`);
                return;
            }
            
            // 3. ä¿å­˜åˆ°åˆ—è¡¨
            vocabList.push(word);
            localStorage.setItem('my_vocab_list', JSON.stringify(vocabList));

            // 4. ğŸŸ¢ å…³é”®ï¼šåŒæ—¶åˆå§‹åŒ–â€œå…ƒæ•°æ®â€ (è®©å¤ä¹ é¡µèƒ½ç«‹å³è¯†åˆ«)
            let vocabMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
            const now = Date.now();
            // å¦‚æœ Meta é‡Œæ²¡æœ‰è¿™ä¸ªè¯ï¼Œå°±åˆå§‹åŒ–å®ƒ
            if (!vocabMeta[word]) {
                vocabMeta[word] = { 
                    created: now,      // åˆ›å»ºæ—¶é—´
                    nextReview: now,   // ä¸‹æ¬¡å¤ä¹ æ—¶é—´ (ç«‹å³)
                    level: 0,          // è®°å¿†ç­‰çº§ 0
                    note: ""           // ç¬”è®°
                };
                localStorage.setItem('my_vocab_meta', JSON.stringify(vocabMeta));
            }
            
            // 5. åé¦ˆ
            alert(`âœ… å·²å°† "${word}" åŠ å…¥ç”Ÿè¯æœ¬ï¼\n(å½“å‰å…± ${vocabList.length} ä¸ªè¯)`);
        }

        function closeDict() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('dictModal').classList.remove('show');
        }

        const uiDict = {
            ru: { back: "ĞĞ°Ğ·Ğ°Ğ´", word_mode: "Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ", word_mode_on: "Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€ÑŒ", audio_mode: "ĞÑƒĞ´Ğ¸Ğ¾", prev: "ĞŸÑ€ĞµĞ´.", next: "Ğ¡Ğ»ĞµĞ´.", loop: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€", start_practice: "ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ¶Ğ½ĞµĞ½Ğ¸Ñ", trans_label: "RU" },
            en: { back: "Back", word_mode: "Dictionary", word_mode_on: "Dictionary", audio_mode: "Audio Mode", prev: "Prev", next: "Next", loop: "Loop", start_practice: "Start Practice", trans_label: "EN" },
            cn: { back: "è¿”å›", word_mode: "è¯å…¸", word_mode_on: "è¯å…¸", audio_mode: "éŸ³é¢‘æ¨¡å¼", prev: "ä¸Šä¸€å¥", next: "ä¸‹ä¸€å¥", loop: "å¾ªç¯", start_practice: "å¼€å§‹æœ¬è¯¾ç»ƒä¹ ", trans_label: "è¯‘" }
        };

        if(lesson) {
            document.getElementById('lessonTitle').innerText = lesson.title;
            video.src = lesson.video;
            window.currentSubtitles = lesson.subs; 
            updateLanguage();

            // ğŸŸ¢ æ–°å¢ï¼šæ–­ç‚¹ç»­æ’­ (è¯»å–æœ¬åœ°è¿›åº¦)
            const savedTimePercent = localStorage.getItem('progress_' + id);
            if (savedTimePercent && parseInt(savedTimePercent) > 0 && parseInt(savedTimePercent) < 100) {
                // ç­‰è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œå†è·³è½¬ï¼Œé˜²æ­¢é»‘å±
                video.addEventListener('loadedmetadata', () => {
                    const jumpTime = video.duration * (parseInt(savedTimePercent) / 100);
                    if(jumpTime > 0) {
                        video.currentTime = jumpTime;
                        console.log(`å·²æ¢å¤è¿›åº¦åˆ°: ${parseInt(savedTimePercent)}%`);
                    }
                }, { once: true }); // åªæ‰§è¡Œä¸€æ¬¡
            }
        }

        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en'; else if (currentLang === 'en') currentLang = 'cn'; else currentLang = 'ru';
            updateLanguage();
        }
        function toggleDesktopLayout() {
    const container = document.body; // æˆ‘ä»¬ç›´æ¥ç»™ body åŠ  classï¼Œè¿™æ ·å…¨å±€éƒ½èƒ½æ§åˆ¶
    const btnText = document.getElementById('layoutText');
    const btnIcon = document.querySelector('#layoutToggleBtn i');

    if (container.classList.contains('vertical-mode')) {
        // æ¢å¤å·¦å³å¸ƒå±€
        container.classList.remove('vertical-mode');
        btnText.innerText = "å·¦å³å¸ƒå±€";
        btnIcon.className = "fas fa-columns";
        localStorage.setItem('pref_layout', 'side');
    } else {
        // è¿›å…¥ä¸Šä¸‹å¸ƒå±€
        container.classList.add('vertical-mode');
        btnText.innerText = "ä¸Šä¸‹å¸ƒå±€";
        btnIcon.className = "fas fa-grip-lines";
        localStorage.setItem('pref_layout', 'vertical');
    }
    // å¼ºåˆ¶åˆ·æ–°ä¸€ä¸‹é«˜äº®ä½ç½®
    activeIndex = -1;
}

// é¡µé¢åŠ è½½æ—¶æ¢å¤ç”¨æˆ·å–œæ¬¢çš„å¸ƒå±€
window.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('pref_layout') === 'vertical') {
        toggleDesktopLayout();
    }
});

        function updateLanguage() {
            let label = 'ğŸ‡·ğŸ‡º RU';
            if (currentLang === 'en') label = 'ğŸ‡ºğŸ‡¸ EN';
            if (currentLang === 'cn') label = 'ğŸ‡¨ğŸ‡³ CN';
            document.getElementById('langLabel').innerText = label;
            document.getElementById('transToggle').innerText = uiDict[currentLang].trans_label;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (uiDict[currentLang][key]) el.innerText = uiDict[currentLang][key];
            });
            renderSubtitles();
        }

        function renderSubtitles() {
            list.innerHTML = '';
            window.currentSubtitles.forEach((sub, index) => {
                const div = document.createElement('div');
                div.className = 'sub-item';
                div.id = 'sub-' + index;

                let transText = sub.ru;
                if (currentLang === 'en') transText = sub.en || sub.ru;
                if (currentLang === 'cn') transText = `${sub.ru} <br> ${sub.en || ''}`;

                let chineseContent = sub.cn;
                if (isWordMode && window.Intl && Intl.Segmenter) {
                    const segmenter = new Intl.Segmenter('zh-CN', { granularity: 'word' });
                    const segments = segmenter.segment(sub.cn);
                    chineseContent = '';
                    for (const segment of segments) {
                        chineseContent += `<span class="word-span" onclick="lookupWord('${segment.segment}', event)">${segment.segment}</span>`;
                    }
                }
                div.innerHTML = `<div class="pinyin">${sub.py}</div><div class="chinese">${chineseContent}</div><div class="trans">${transText}</div>`;
                div.onclick = () => { if (!isWordMode) { video.currentTime = sub.start; video.play(); } };
                list.appendChild(div);
            });
        }

        // ... (çœç•¥ AI æŸ¥è¯å’Œæ’­æ”¾é€»è¾‘ï¼Œä¿æŒä¸å˜) ...
        // ä¸ºäº†ç¡®ä¿èƒ½è¿è¡Œï¼Œæˆ‘æŠŠåŸºç¡€æ’­æ”¾é€»è¾‘è¡¥å…¨ï¼š
        
        // === ä¿®æ”¹åçš„æ’­æ”¾é€»è¾‘ (è‡ªåŠ¨ä¿å­˜è¿›åº¦) ===
        video.ontimeupdate = () => {
            const time = video.currentTime;
            const duration = video.duration;
            const subs = window.currentSubtitles;

            // 1. è®¡ç®—å¹¶ä¿å­˜è¿›åº¦ (æ–°åŠŸèƒ½)
            if (duration > 0) {
                const percent = Math.floor((time / duration) * 100);
                
                // åªæœ‰è¿›åº¦å˜äº†æ‰ä¿å­˜ï¼Œå‡å°‘æ€§èƒ½æ¶ˆè€—
                // Key çš„æ ¼å¼æ˜¯: 'progress_è¯¾ç¨‹ID'
                const oldPercent = localStorage.getItem('progress_' + id);
                if (percent > (oldPercent || 0)) {
                    localStorage.setItem('progress_' + id, percent);
                    
                    // å¦‚æœè¶…è¿‡ 90%ï¼Œæ ‡è®°ä¸ºâ€œå·²å®Œæˆâ€
                    if (percent >= 90) {
                        localStorage.setItem('done_' + id, 'true');
                    }
                }
            }

            // 2. å¾ªç¯é€»è¾‘ (ä¿æŒä¸å˜)
            if (loopEnabled && activeIndex !== -1 && time >= subs[activeIndex].end) {
                video.currentTime = subs[activeIndex].start; video.play();
            }

            // 3. é«˜äº®é€»è¾‘ (ä¿æŒä¸å˜)
            const currentIndex = subs.findIndex(s => time >= s.start && time < s.end);
            if (currentIndex !== -1 && currentIndex !== activeIndex) {
                if (activeIndex !== -1) document.getElementById('sub-' + activeIndex)?.classList.remove('active');
                const activeItem = document.getElementById('sub-' + currentIndex);
                if (activeItem) { 
            activeItem.classList.add('active'); 
            
            // æ— è®ºå“ªç§æ¨¡å¼ï¼Œéƒ½è®©å½“å‰å­—å¹•æ»šåŠ¨åˆ°å®¹å™¨ï¼ˆå°çª—å£ï¼‰çš„æ­£ä¸­é—´
            activeItem.scrollIntoView({ behavior: "smooth", block: "center" }); 
        }
                activeIndex = currentIndex;
            }
        };

        function seekRelative(offset) {
            let target = activeIndex + offset;
            if (target < 0) target = 0; if (target >= window.currentSubtitles.length) target = window.currentSubtitles.length - 1;
            if (window.currentSubtitles[target]) { video.currentTime = window.currentSubtitles[target].start; video.play(); }
        }
        function togglePlay() { if (video.paused) { video.play(); playIcon.className = 'fas fa-pause'; } else { video.pause(); playIcon.className = 'fas fa-play'; } }
        function changeSpeed(rate) { video.playbackRate = rate; }
        function toggleLoop() { loopEnabled = !loopEnabled; document.getElementById('loopBtn').classList.toggle('active'); }
        function toggleAudioMode() { isAudioMode = !isAudioMode; document.getElementById('audioVisualizer').classList.toggle('active'); document.getElementById('audioModeBtn').classList.toggle('active'); }
        function toggleFullscreen() { document.body.classList.toggle('focus-mode'); }
        function toggleVisibility(type, btn) { const cls = 'hide-' + type; if (container.classList.contains(cls)) { container.classList.remove(cls); btn.classList.add('on'); } else { container.classList.add(cls); btn.classList.remove('on'); } }
        function goToPractice() { location.href = 'practice.html?id=' + id; }
        
        video.onplay = () => playIcon.className = 'fas fa-pause';
        video.onpause = () => playIcon.className = 'fas fa-play';
    </script>
</body>
</html>
