<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè¯å¤ä¹ æœ¬</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 1. å¼•å…¥å¿…è¦åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 2. å¼•å…¥ Auth -->
    <script src="auth.js"></script>
    
    <!-- 3. ğŸ”´ å…³é”®ï¼šå¼•å…¥æ‰€æœ‰è¯¾ç¨‹æ•°æ® (ä¸ºäº†æŸ¥å­—å…¸) -->
    <script src="lesson_001.js"></script>
    <script src="lesson_002.js"></script> 
    <script src="lesson_003.js"></script>
    <script src="lesson_004.js"></script>
    <script src="lesson_005.js"></script>
    <script src="lesson_006.js"></script>
    <script src="lesson_007.js"></script> 
    <script src="lesson_008.js"></script>
    <script src="lesson_009.js"></script>
    <script src="lesson_010.js"></script>
    <script src="lesson_011.js"></script>
    <script src="lesson_012.js"></script>
    
    <script src="lesson_401.js"></script>
    <script src="lesson_402.js"></script>
    <script src="lesson_403.js"></script>
    <script src="lesson_404.js"></script>

    <!-- 4. é…ç½® Supabase (è§£å†³å˜é‡å†²çª) -->
    <script>
        const SUPABASE_URL = 'https://tcrayyqmozfqrfagvusp.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjcmF5eXFtb3pmcXJmYWd2dXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTY0NjYsImV4cCI6MjA4MTgzMjQ2Nn0.G4ei36j_DgvIRaa3wzO89YI8lj67MQs9ZbrsDFzxi1M';

        let supabaseClient = null;
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    </script>

    <style>
        :root { 
            --primary: #6CAD9C;   
            --red: #9F2E2E;       
            --yellow: #E5CC84;    
            --blue: #14507D;      
            --bg: #F9F7F2;        
            --card-bg: #FFFFFF;
            --text: #4A3B32;
        }

        body { margin: 0; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: var(--card-bg); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .logo { font-size: 18px; font-weight: 800; color: var(--red); margin-bottom: 40px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .nav-btn { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            border-radius: 8px; cursor: pointer; color: #666; margin-bottom: 8px; transition: 0.2s; font-size: 14px;
            border: 1px solid transparent;
        }
        .nav-btn:hover { background: #fdfdfd; border-color: #eee; color: var(--blue); }
        .nav-btn.active { background: var(--yellow); color: #5a3a1a; font-weight: bold; box-shadow: 2px 4px 10px rgba(229, 204, 132, 0.3); }
        .badge { margin-left: auto; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; color: inherit; }

        /* ä¸»å†…å®¹ */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 26px; font-weight: 900; color: var(--blue); letter-spacing: 1px; }
        
        .lang-switch { 
            cursor: pointer; padding: 6px 14px; border-radius: 20px; 
            background: #e8e4db; color: var(--text); font-size: 13px; font-weight: bold; 
            display: flex; align-items: center; gap: 6px; transition: 0.2s; border: 1px solid #dcdcdc;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-card { 
            background: var(--card-bg); border-radius: 16px; padding: 25px; 
            border: 1px solid rgba(0,0,0,0.03); margin-bottom: 30px; max-width: 900px; margin: 0 auto 30px auto;
            box-shadow: 4px 6px 20px rgba(0,0,0,0.02);
        }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .chart-legend-custom { display: flex; gap: 20px; justify-content: center; margin-top: 20px; font-size: 12px; color: #666; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 3px; border-radius: 2px; }

        .quote-banner {
            margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;
            font-size: 13px; color: #666; line-height: 1.6;
            display: flex; gap: 10px; text-align: justify;
        }
        .quote-icon { font-size: 20px; color: var(--primary); opacity: 0.5; }

        .list-header { max-width: 900px; margin: 0 auto 15px auto; display: flex; justify-content: space-between; align-items: flex-end; }
        .list-title { font-size: 18px; font-weight: bold; color: var(--text); }

        /* å•è¯åˆ—è¡¨ */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 900px; margin: 0 auto; }
        
        .word-card { 
            background: var(--card-bg); border-radius: 12px; padding: 20px; 
            box-shadow: 2px 4px 12px rgba(0,0,0,0.03); 
            display: flex; flex-direction: column; gap: 12px;
            border-top: 4px solid #ddd; transition: transform 0.2s;
        }
        .word-card:hover { transform: translateY(-3px); box-shadow: 4px 8px 20px rgba(0,0,0,0.06); }
        
        .status-new { border-top-color: var(--primary); } 
        .status-due { border-top-color: var(--red); } 
        .status-master { border-top-color: var(--yellow); } 
        
        .wc-top { display: flex; justify-content: space-between; align-items: baseline; }
        .wc-hz { font-size: 24px; font-weight: bold; color: var(--text); font-family: "Songti SC", serif; }
        .wc-py { color: #888; font-family: monospace; font-size: 14px; }
        .wc-mean { font-size: 14px; color: #555; background: #fbfbfb; padding: 8px; border-radius: 6px; border: 1px dashed #eee; }
        
        .note-area { 
            width: 100%; border: none; background: #fffdf5; 
            border-radius: 0; border-bottom: 2px solid #f0e6d2; 
            padding: 10px; box-sizing: border-box;
            font-size: 13px; color: #8d704f; resize: none; height: 50px;
            font-family: inherit; transition: 0.2s;
        }
        .note-area:focus { outline: none; border-bottom-color: var(--yellow); background: #fff; }

        .wc-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 12px; color: #999; }
        
        .btn-check { 
            background: var(--red); color: white; border: none; 
            padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; letter-spacing: 1px;
        }
        .btn-check:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-check.checked { background: #e5e7eb; color: #999; cursor: default; transform: none; }

        .empty { grid-column: 1 / -1; text-align: center; color: #aaa; margin-top: 50px; }

        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow-y: auto; background: var(--bg); }
            .sidebar { 
                width: 100%; padding: 12px; 
                border-right: none; border-bottom: 1px solid rgba(0,0,0,0.05); 
                flex-direction: row; overflow-x: auto; align-items: center; gap: 8px;
                background: white; position: sticky; top: 0; z-index: 999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            }
            .logo { display: none; }
            .nav-btn { 
                padding: 6px 12px; font-size: 13px; 
                white-space: nowrap; margin-bottom: 0; flex-shrink: 0; 
                background: #f5f5f5; border-radius: 20px;
            }
            .nav-btn.active { background: var(--yellow); }
            .main { padding: 15px; overflow: visible; }
            .chart-card { padding: 15px; margin-bottom: 25px; }
            .chart-wrapper { height: 200px; }
            .vocab-grid { grid-template-columns: 1fr; gap: 15px; }
            .word-card { padding: 15px; }
        }
        /* ğŸ”´ æ–°å¢ï¼šåˆ é™¤æŒ‰é’®æ ·å¼ */
        .btn-trash {
            color: #ccc;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            margin-left: 10px; /* å’Œå–‡å­æ‹‰å¼€ç‚¹è·ç¦» */
        }
        .btn-trash:hover {
            color: var(--red); /* æ‚¬åœå˜çº¢ */
            transform: scale(1.2);
        }
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='home.html'">
            <i class="fas fa-chevron-left"></i> è¿”å›èƒŒå•è¯
        </div>
        
        <div class="nav-btn active" onclick="filterList('all', this)">
            <i class="fas fa-layer-group"></i> <span data-i18n="filter_all">æ”¶è—çš„å•è¯</span>
            <span class="badge" id="badge-all">0</span>
        </div>
        <div class="nav-btn" onclick="filterList('due', this)">
            <i class="fas fa-clock"></i> <span data-i18n="filter_due">ä»Šæ—¥éœ€å¤ä¹ </span>
            <span class="badge" id="badge-due" style="background:var(--red); color:white">0</span>
        </div>
        <div class="nav-btn" onclick="filterList('master', this)">
            <i class="fas fa-medal"></i> <span data-i18n="filter_master">å·²æŒæ¡</span>
            <span class="badge" id="badge-master" style="background:var(--yellow); color:#5a3a1a">0</span>
        </div>
    </div>

    <div class="main">
        <div class="header-area">
            <div class="page-title"><span data-i18n="page_title">æˆ‘çš„è‰¾å®¾æµ©æ–¯æ›²çº¿</span></div>
            <div class="lang-switch" onclick="toggleLang()">
                <i class="fas fa-globe"></i> <span id="langLabel">RU</span>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-wrapper">
                <canvas id="ebbinghausChart"></canvas>
            </div>
            <div class="chart-legend-custom">
                <div class="legend-item"><div class="dot" style="background:#6CAD9C"></div> <span data-i18n="legend_mine">æˆ‘çš„é—å¿˜æ›²çº¿</span></div>
                <div class="legend-item"><div class="dot" style="background:#E5CC84"></div> <span data-i18n="legend_std">è‰¾å®¾æµ©æ–¯æ ‡å‡†æ›²çº¿</span></div>
            </div>
            
            <div class="quote-banner">
                <i class="fas fa-quote-left quote-icon"></i>
                <div data-i18n="chart_desc">
                    æ›²çº¿è§£è¯»ï¼šæ ¹æ®æ‚¨æœ€è¿‘çš„å­¦ä¹ é¢‘ç‡ï¼Œè®¡ç®—äº†ä½ çš„é—å¿˜æ›²çº¿ã€‚åšæŒä½¿ç”¨æœ¬å¹³å°èƒŒå•è¯çš„é¢‘ç‡è¶Šé«˜ï¼Œä½ çš„é—å¿˜æ›²çº¿ç»Ÿè®¡å°±è¶Šç²¾å‡†ï¼Œè€Œä¸”ä½ çš„é—å¿˜ç‡ä¼šè¶Šæ¥è¶Šä½ã€‚
                </div>
            </div>
        </div>

        <div class="list-header">
            <div class="list-title" id="list-title">åˆ—è¡¨</div>
        </div>
        
        <div id="grid" class="vocab-grid">
            <div style="text-align:center; color:#999; margin-top:50px;">
                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...
            </div>
        </div>
    </div>

    <script>
        let myChart = null; 
        let myVocab = [];
        let vocabMeta = {};
        let currentFilter = 'all';
        let currentLang = 'ru'; 

        const REVIEW_INTERVALS = [5*60*1000, 24*60*60*1000, 3*24*60*60*1000, 7*24*60*60*1000, 15*24*60*60*1000];

        // è¯­è¨€å­—å…¸
        const uiDict = {
            ru: {
                page_title: "ĞšÑ€Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ", 
                filter_all: "Ğ’ÑĞµ ÑĞ»Ğ¾Ğ²Ğ°", filter_due: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", filter_master: "Ğ’Ñ‹ÑƒÑ‡ĞµĞ½Ğ¾",
                legend_mine: "ĞœĞ¾Ñ ĞºÑ€Ğ¸Ğ²Ğ°Ñ", legend_std: "Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚ Ğ­Ğ±Ğ±Ğ¸Ğ½Ğ³Ğ°ÑƒĞ·Ğ°",
                chart_desc: "Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ: ĞšÑ€Ğ¸Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ğ°ÑˆĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ. Ğ§ĞµĞ¼ Ñ‡Ğ°Ñ‰Ğµ Ğ²Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñƒ, Ñ‚ĞµĞ¼ Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ½Ğ¸Ğ¶Ğµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ.",
                list_title_all: "ĞœĞ¾Ğ¹ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ", list_title_due: "ĞÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", list_title_master: "Ğ’Ñ‹ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°",
                btn_check: "Ğ£Ñ‡Ğ¸Ñ‚ÑŒ", 
                axis_0:"Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", axis_1:"1Ğ´", axis_2:"2Ğ´", axis_3:"3Ğ´", axis_4:"4Ğ´", axis_5:"5Ğ´", axis_6:"6Ğ´", axis_7:"7Ğ´", axis_15:"15Ğ´",
                times_label: "Ñ€Ğ°Ğ·",
                msg_empty: "ğŸ‰ ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾! Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· Ğ²Ğ¸Ğ´ĞµĞ¾." 
            },
            en: {
                page_title: "Forgetting Curve", 
                filter_all: "All Words", filter_due: "Review Due", filter_master: "Mastered",
                legend_mine: "My Curve", legend_std: "Ebbinghaus Standard",
                chart_desc: "Interpretation: Calculated based on your learning frequency. The more you use this platform, the more accurate your curve becomes, and your forgetting rate will decrease.",
                list_title_all: "Collection", list_title_due: "Review Today", list_title_master: "Mastered Words",
                btn_check: "Check",
                axis_0:"Today", axis_1:"1d", axis_2:"2d", axis_3:"3d", axis_4:"4d", axis_5:"5d", axis_6:"6d", axis_7:"7d", axis_15:"15d",
                times_label: "times",
                msg_empty: "ğŸ‰ Empty here! Go collect words from videos."
            },
            cn: {
                page_title: "æˆ‘çš„è‰¾å®¾æµ©æ–¯æ›²çº¿", 
                filter_all: "æ”¶è—çš„å•è¯", filter_due: "ä»Šæ—¥éœ€å¤ä¹ ", filter_master: "å·²æŒæ¡",
                legend_mine: "æˆ‘çš„é—å¿˜æ›²çº¿", legend_std: "è‰¾å®¾æµ©æ–¯æ ‡å‡†æ›²çº¿",
                chart_desc: "æ›²çº¿è§£è¯»ï¼šæ ¹æ®æ‚¨æœ€è¿‘çš„å­¦ä¹ é¢‘ç‡ï¼Œè®¡ç®—äº†ä½ çš„é—å¿˜æ›²çº¿ã€‚åšæŒä½¿ç”¨æœ¬å¹³å°èƒŒå•è¯çš„é¢‘ç‡è¶Šé«˜ï¼Œä½ çš„é—å¿˜æ›²çº¿ç»Ÿè®¡å°±è¶Šç²¾å‡†ï¼Œè€Œä¸”ä½ çš„é—å¿˜ç‡ä¼šè¶Šæ¥è¶Šä½ã€‚",
                list_title_all: "å•è¯åˆ—è¡¨", list_title_due: "ä»Šæ—¥æ€¥éœ€å¤ä¹ ", list_title_master: "å·²æŒæ¡çš„å•è¯",
                btn_check: "æ‰“å¡å¤ä¹ ",
                axis_0:"ä»Šå¤©", axis_1:"1å¤©", axis_2:"2å¤©", axis_3:"3å¤©", axis_4:"4å¤©", axis_5:"5å¤©", axis_6:"6å¤©", axis_7:"7å¤©", axis_15:"15å¤©",
                times_label: "æ¬¡",
                msg_empty: "ğŸ‰ ç©ºç©ºå¦‚ä¹Ÿï¼å¿«å»è§†é¢‘é‡Œç‚¹å‡»å•è¯æ”¶è—å§ï¼"
            }
        };

        // ğŸŸ¢ 1. é¡µé¢åŠ è½½ï¼šå…ˆåŒæ­¥ï¼Œå†æ¸²æŸ“
        document.addEventListener('DOMContentLoaded', async () => {
            updateLanguage(); 
            initChart();      
            
            // æ ¸å¿ƒä¿®å¤ï¼šç­‰å¾…äº‘ç«¯åŒæ­¥å®Œæˆåå†æ¸²æŸ“
            await syncFromCloud();
            loadLocalData();
            render();
        });

        // ğŸŸ¢ 2. ä»äº‘ç«¯æ‹‰å–ç”Ÿè¯å¹¶åˆå¹¶
        async function syncFromCloud() {
            if (!supabaseClient) return;
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            try {
                const { data } = await supabaseClient
                    .from('user_progress')
                    .select('data')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (data && data.data) {
                    // åˆå¹¶é€»è¾‘ï¼šäº‘ç«¯ + æœ¬åœ°å»é‡
                    const cloudList = JSON.parse(data.data['my_vocab_list'] || '[]');
                    const localList = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
                    const mergedList = [...new Set([...cloudList, ...localList])];
                    localStorage.setItem('my_vocab_list', JSON.stringify(mergedList));
                    
                    // åˆå¹¶å…ƒæ•°æ® (ä¿ç•™æœ€æ–°çš„è®°å½•)
                    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥åˆå¹¶ï¼Œæœ¬åœ°è¦†ç›–äº‘ç«¯æ—§å€¼
                    const cloudMeta = JSON.parse(data.data['my_vocab_meta'] || '{}');
                    const localMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
                    const mergedMeta = { ...cloudMeta, ...localMeta };
                    localStorage.setItem('my_vocab_meta', JSON.stringify(mergedMeta));
                    
                    console.log("âœ… å¤ä¹ æœ¬å·²ä¸äº‘ç«¯åˆå¹¶");
                }
            } catch (e) { console.error("åŒæ­¥å‡ºé”™:", e); }
        }

        // ğŸŸ¢ 3. åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            myVocab = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
            vocabMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
            const now = Date.now();
            myVocab.forEach(word => {
                if (!vocabMeta[word]) {
                    vocabMeta[word] = { created: now, nextReview: now, level: 0, note: "" };
                }
            });
            saveMeta(false); // è¿™ä¸€æ­¥åªä¿å­˜æœ¬åœ°ï¼Œä¸è§¦å‘ä¸Šä¼ ï¼Œé¿å…å¾ªç¯
        }

        // ğŸŸ¢ 4. ä¿å­˜æ•°æ® (æ“ä½œåä¸Šä¼ )
        async function saveMeta(upload = true) { 
            localStorage.setItem('my_vocab_meta', JSON.stringify(vocabMeta));
            localStorage.setItem('my_vocab_list', JSON.stringify(myVocab)); // åˆ—è¡¨ä¹Ÿå¯èƒ½å˜
            
            // é¡ºæ‰‹å­˜åˆ°äº‘ç«¯
            if (upload && supabaseClient) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    try {
                        // è¯»å–ç°æœ‰äº‘ç«¯å¤§åŒ…
                        const { data } = await supabaseClient
                            .from('user_progress')
                            .select('data')
                            .eq('user_id', user.id)
                            .maybeSingle();
                        
                        const currentData = data ? data.data : {};
                        
                        // æ›´æ–°è¿™ä¸¤ä¸ªå­—æ®µ
                        currentData['my_vocab_list'] = localStorage.getItem('my_vocab_list');
                        currentData['my_vocab_meta'] = localStorage.getItem('my_vocab_meta');
                        
                        // æ¨é€
                        await supabaseClient
                            .from('user_progress')
                            .upsert({ 
                                user_id: user.id, 
                                data: currentData,
                                updated_at: new Date().toISOString() 
                            });
                        console.log("âœ… æ“ä½œå·²åŒæ­¥åˆ°äº‘ç«¯");
                    } catch (e) { console.error(e); }
                }
            }
        }

        function markReviewed(word, btn) {
            const meta = vocabMeta[word];
            if(!meta) return;
            
            meta.level = Math.min(meta.level + 1, REVIEW_INTERVALS.length);
            meta.nextReview = Date.now() + (REVIEW_INTERVALS[meta.level] || 30*24*60*60*1000);
            
            // ä¿å­˜å¹¶ä¸Šä¼ 
            saveMeta(true);
            
            btn.classList.add('checked');
            btn.innerHTML = '<i class="fas fa-check"></i> OK';
            btn.disabled = true;
            setTimeout(render, 500); 
        }
        
        function saveUserNote(word, el) { 
            if(vocabMeta[word]) { 
                vocabMeta[word].note = el.value; 
                saveMeta(true); // ç¬”è®°ä¿®æ”¹ä¹Ÿè¦ä¸Šä¼ 
            } 
        }

        function filterList(type, btn) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = type;
            render();
        }

        function render() {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            const now = Date.now();
            let countTotal = 0, countDue = 0, countMaster = 0;

            const listToShow = myVocab.filter(word => {
                const meta = vocabMeta[word];
                countTotal++;
                
                const isDue = meta.nextReview <= now;
                const isMaster = meta.level >= 4; 

                if (isDue) countDue++;
                if (isMaster) countMaster++;

                if (currentFilter === 'due') return isDue;
                if (currentFilter === 'master') return isMaster;
                return true;
            });

            document.getElementById('badge-all').innerText = countTotal;
            document.getElementById('badge-due').innerText = countDue;
            document.getElementById('badge-master').innerText = countMaster;

            const titleKey = 'list_title_' + currentFilter;
            document.getElementById('list-title').innerText = uiDict[currentLang][titleKey] || "List";

            if (listToShow.length === 0) {
                const emptyText = uiDict[currentLang].msg_empty;
                container.innerHTML = `<div class="empty">${emptyText}</div>`;
                return;
            }

            listToShow.forEach(word => {
                const meta = vocabMeta[word];
                const isDue = meta.nextReview <= now;
                const isMaster = meta.level >= 4;
                
                // ğŸ” æŸ¥å­—å…¸ï¼šéå†æ‰€æœ‰ lesson æ–‡ä»¶
                let details = { py: "", mean: "" };
                if (window.lessonDatabase) {
                    for (let id in window.lessonDatabase) {
                        const dict = window.lessonDatabase[id].dictionary;
                        if (dict && dict[word]) { details = dict[word]; break; }
                    }
                }

                const card = document.createElement('div');
                let statusClass = 'status-new';
                if (isDue) statusClass = 'status-due';
                if (isMaster) statusClass = 'status-master';
                card.className = `word-card ${statusClass}`;
                
                const unit = uiDict[currentLang].times_label; 
                const countDisplay = `<i class="fas fa-check-double"></i> ${meta.level} ${unit}`;

                card.innerHTML = `
                    card.innerHTML = `
                    <!-- ğŸ‘‡ è¿™ä¸€è¡Œæ˜¯æ–°å¢çš„åˆ é™¤æŒ‰é’® -->
                    <div class="trash-btn" onclick="deleteWord('${word}')"><i class="fas fa-trash-alt"></i></div>
                    
                    <div class="wc-top">
                        <span class="wc-hz">${word}</span>
                        <i class="fas fa-volume-up" style="color:#ccc; cursor:pointer" onclick="speak('${word}')"></i>
                    </div>
                    <div class="wc-mean">${details.mean || '...'}</div>
                    <textarea class="note-area" placeholder="âœï¸..." onchange="saveUserNote('${word}', this)">${meta.note || ''}</textarea>
                    
                    <div class="wc-foot">
                        <span style="color:#888; font-size:11px;">${countDisplay}</span>
                        ${isDue ? 
                            `<button class="btn-check" onclick="markReviewed('${word}', this)">${uiDict[currentLang].btn_check}</button>` 
                            : 
                            `<span style="color:#ccc; font-size:11px;">${new Date(meta.nextReview).getMonth()+1}/${new Date(meta.nextReview).getDate()}</span>`
                        }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-CN'; speechSynthesis.speak(u); }
        
        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en'; else if (currentLang === 'en') currentLang = 'cn'; else currentLang = 'ru';
            updateLanguage();
            initChart(); 
            render();
        }

        function updateLanguage() {
            let label = 'ğŸ‡·ğŸ‡º RU'; if (currentLang === 'en') label = 'ğŸ‡ºğŸ‡¸ EN'; if (currentLang === 'cn') label = 'ğŸ‡¨ğŸ‡³ CN';
            document.getElementById('langLabel').innerText = label;
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (uiDict[currentLang][key]) el.innerText = uiDict[currentLang][key];
            });
        }

        function initChart() {
            const ctx = document.getElementById('ebbinghausChart').getContext('2d');
            const labels = [
                uiDict[currentLang].axis_0, uiDict[currentLang].axis_1, uiDict[currentLang].axis_2,
                uiDict[currentLang].axis_3, uiDict[currentLang].axis_4, uiDict[currentLang].axis_5,
                uiDict[currentLang].axis_6, uiDict[currentLang].axis_7, uiDict[currentLang].axis_15
            ];

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mine',
                            data: [100, 65, 55, 48, 42, 38, 36, 35, 33],
                            borderColor: '#6CAD9C',
                            backgroundColor: 'rgba(108, 173, 156, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6CAD9C',
                            pointRadius: 5,
                            tension: 0.4, fill: true
                        },
                        {
                            label: 'Standard',
                            data: [100, 40, 30, 25, 23, 21, 20, 19, 18],
                            borderColor: '#E5CC84',
                            borderWidth: 2,
                            pointRadius: 0,
                            borderDash: [5, 5],
                            tension: 0.4, fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }
        // === ğŸ”´ æ–°å¢ï¼šå½»åº•åˆ é™¤å•è¯é€»è¾‘ ===
        function deleteWord(word) {
            // 1. äºŒæ¬¡ç¡®è®¤é˜²æ­¢æ‰‹æ»‘
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”Ÿè¯ "${word}" å—ï¼Ÿ\nåˆ é™¤åå¤ä¹ è¿›åº¦ä¹Ÿå°†æ¸…ç©ºã€‚`)) return;

            // 2. ä»å†…å­˜æ•°ç»„ä¸­ç§»é™¤
            myVocab = myVocab.filter(item => item !== word);
            
            // 3. ä»å…ƒæ•°æ®å¯¹è±¡ä¸­ç§»é™¤
            if (vocabMeta[word]) {
                delete vocabMeta[word];
            }

            // 4. ğŸŸ¢ å…³é”®ï¼šç«‹å³ä¿å­˜åˆ°æœ¬åœ° + å¼ºåˆ¶åŒæ­¥åˆ°äº‘ç«¯
            // è¿™æ ·äº‘ç«¯çš„æ•°æ®ä¹Ÿä¼šå˜æˆâ€œä¸åŒ…å«è¯¥è¯â€çš„æ–°çŠ¶æ€
            saveMeta(true);

            // 5. é‡æ–°æ¸²æŸ“ç•Œé¢
            render();
            
            // 6. ç¨å¾®æ›´æ–°ä¸€ä¸‹ç»Ÿè®¡å›¾
            initChart();
        }
    </script>
</body>
</html>
