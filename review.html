<script src="lesson_013.js"></script><!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿè¯å¤ä¹ æœ¬</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 1. å¼•å…¥å¿…è¦åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 2. å¼•å…¥ Auth -->
    <script src="auth.js"></script>
    
    <!-- 3. å¼•å…¥æ‰€æœ‰è¯¾ç¨‹æ•°æ® -->
    <script src="lesson_001.js"></script>
    <script src="lesson_002.js"></script> 
    <script src="lesson_003.js"></script>
    <script src="lesson_004.js"></script>
    <script src="lesson_005.js"></script>
    <script src="lesson_006.js"></script>
    <script src="lesson_007.js"></script> 
    <script src="lesson_008.js"></script>
    <script src="lesson_009.js"></script>
    <script src="lesson_010.js"></script>
    <script src="lesson_011.js"></script>
    <script src="lesson_012.js"></script>
    <script src="lesson_013.js"></script>
    <script src="lesson_014.js"></script>
    <script src="lesson_015.js"></script>
    <script src="lesson_016.js"></script>
    <script src="lesson_017.js"></script>
    
    <script src="lesson_401.js"></script>
    <script src="lesson_402.js"></script>
    <script src="lesson_403.js"></script>
    <script src="lesson_404.js"></script>
    <script src="lesson_405.js"></script>
    <script src="lesson_406.js"></script>

    <!-- 4. é…ç½® Supabase -->
    <script>
        const SUPABASE_URL = 'https://tcrayyqmozfqrfagvusp.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjcmF5eXFtb3pmcXJmYWd2dXNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNTY0NjYsImV4cCI6MjA4MTgzMjQ2Nn0.G4ei36j_DgvIRaa3wzO89YI8lj67MQs9ZbrsDFzxi1M';

        let supabaseClient = null;
        if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        }
    </script>

    <style>
        :root { 
            --primary: #6CAD9C;   
            --red: #9F2E2E;       
            --yellow: #E5CC84;    
            --blue: #14507D;      
            --bg: #F9F7F2;        
            --card-bg: #FFFFFF;
            --text: #4A3B32;
        }

        body { margin: 0; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: var(--card-bg); border-right: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .logo { font-size: 18px; font-weight: 800; color: var(--red); margin-bottom: 40px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .nav-btn { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            border-radius: 8px; cursor: pointer; color: #666; margin-bottom: 8px; transition: 0.2s; font-size: 14px;
            border: 1px solid transparent;
        }
        .nav-btn:hover { background: #fdfdfd; border-color: #eee; color: var(--blue); }
        .nav-btn.active { background: var(--yellow); color: #5a3a1a; font-weight: bold; box-shadow: 2px 4px 10px rgba(229, 204, 132, 0.3); }
        .badge { margin-left: auto; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; color: inherit; }

        /* ä¸»å†…å®¹ */
        .main { flex: 1; padding: 30px; overflow-y: auto; background: var(--bg); }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 26px; font-weight: 900; color: var(--blue); letter-spacing: 1px; }
        
        .lang-switch { 
            cursor: pointer; padding: 6px 14px; border-radius: 20px; 
            background: #e8e4db; color: var(--text); font-size: 13px; font-weight: bold; 
            display: flex; align-items: center; gap: 6px; transition: 0.2s; border: 1px solid #dcdcdc;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-card { 
            background: var(--card-bg); border-radius: 16px; padding: 25px; 
            border: 1px solid rgba(0,0,0,0.03); margin-bottom: 30px; max-width: 900px; margin: 0 auto 30px auto;
            box-shadow: 4px 6px 20px rgba(0,0,0,0.02);
        }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }
        .chart-legend-custom { display: flex; gap: 20px; justify-content: center; margin-top: 20px; font-size: 12px; color: #666; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 3px; border-radius: 2px; }

        .quote-banner {
            margin-top: 20px; padding-top: 15px; border-top: 1px dashed #eee;
            font-size: 13px; color: #666; line-height: 1.6;
            display: flex; gap: 10px; text-align: justify;
        }
        .quote-icon { font-size: 20px; color: var(--primary); opacity: 0.5; }

        .list-header { max-width: 900px; margin: 0 auto 15px auto; display: flex; justify-content: space-between; align-items: flex-end; }
        .list-title { font-size: 18px; font-weight: bold; color: var(--text); }

        /* å•è¯åˆ—è¡¨ */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 900px; margin: 0 auto; }
        
        .word-card { 
            background: var(--card-bg); border-radius: 12px; padding: 20px; 
            box-shadow: 2px 4px 12px rgba(0,0,0,0.03); 
            display: flex; flex-direction: column; gap: 12px;
            border-top: 4px solid #ddd; transition: transform 0.2s;
            position: relative; 
        }
        .word-card:hover { transform: translateY(-3px); box-shadow: 4px 8px 20px rgba(0,0,0,0.06); }
        
        .status-new { border-top-color: var(--primary); } 
        .status-due { border-top-color: var(--red); } 
        .status-master { border-top-color: var(--yellow); } 
        
        .wc-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; /* åº•éƒ¨å¯¹é½ï¼Œæ‹¼éŸ³æ›´å¥½çœ‹ */
        }
        
        .wc-hz { font-size: 24px; font-weight: bold; color: var(--text); font-family: "Songti SC", serif; }
        .wc-py { color: #888; font-family: monospace; font-size: 14px; margin-left: 10px; }
        .wc-mean { font-size: 14px; color: #555; background: #fbfbfb; padding: 8px; border-radius: 6px; border: 1px dashed #eee; }
        
        .note-area { 
            width: 100%; border: none; background: #fffdf5; 
            border-radius: 0; border-bottom: 2px solid #f0e6d2; 
            padding: 10px; box-sizing: border-box;
            font-size: 13px; color: #8d704f; resize: none; height: 50px;
            font-family: inherit; transition: 0.2s;
        }
        .note-area:focus { outline: none; border-bottom-color: var(--yellow); background: #fff; }

        .wc-foot { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; font-size: 12px; color: #999; }
        
        .btn-check { 
            background: var(--red); color: white; border: none; 
            padding: 6px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; gap: 5px; letter-spacing: 1px;
        }
        .btn-check:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-check.checked { background: #e5e7eb; color: #999; cursor: default; transform: none; }

        .empty { grid-column: 1 / -1; text-align: center; color: #aaa; margin-top: 50px; }

        /* å›¾æ ‡é€šç”¨ */
        .icon-btn { cursor: pointer; font-size: 16px; transition: all 0.2s; color: #ccc; }
        .icon-btn:hover { color: var(--primary); transform: scale(1.2); }
        
        /* ğŸ”´ ä¿®å¤ï¼šåƒåœ¾æ¡¶ç§»åˆ°å·¦ä¸‹è§’ */
        .btn-trash {
            font-size: 13px;
            color: #e5e7eb; /* é»˜è®¤ææ·¡ */
        }
        .btn-trash:hover {
            color: var(--red) !important; /* æ‚¬åœå˜çº¢ */
        }

       @media (max-width: 768px) {
    /* 1. å¼ºåˆ¶å‰§æœ¬é¦†å°é¢å˜ä¸ºä¸€è¡Œä¸¤ä¸ª */
    .library-compact-grid {
        grid-template-columns: 1fr 1fr !important; /* æ ¸å¿ƒï¼šå¹³åˆ†ä¸ºä¸¤åˆ— */
        gap: 10px !important;
    }
    
    /* 2. ç›¸åº”ç¼©å°å°é¢å›¾ç‰‡é«˜åº¦ï¼Œé˜²æ­¢æ‹‰ä¼¸ */
    .library-card img {
        height: 100px !important;
    }

    /* 3. åœ¨æ‰‹æœºä¸Šæ˜¾ç¤ºåˆšæ‰åŠ çš„æç¤ºè¯­ */
    #mobile-notice {
        display: block !important;
    }

    /* 4. ä¼˜åŒ–æ‰‹æœºç«¯é˜…è¯»å™¨æ’ç‰ˆï¼Œé˜²æ­¢é‡å  */
    .sidebar { width: 100%; padding: 12px; border-right: none; flex-direction: row; overflow-x: auto; background: white; position: sticky; top: 0; z-index: 999; }
    .logo { display: none; }
    .main { padding: 15px; }
    #reader-modal .profile-card > div:last-child { flex-direction: column !important; overflow-y: auto !important; }
    #script-content, .reader-note-sidebar { width: 100% !important; border-right: none !important; }
    .reader-tools { flex-direction: column !important; align-items: flex-start !important; gap: 8px !important; }
}
        @media print {
    /* 1. è§£é™¤â€œåªæ˜¾ç¤ºè¯¾æ–‡â€çš„å°å° */
    body * { visibility: visible !important; }
    
    /* 2. éšè—ä¸éœ€è¦çš„ç½‘é¡µæ‚è´¨ */
    .sidebar, .header-area, .chart-card, .list-header, .vocab-grid, 
    .modal-close, .reader-tools, .library-tools, .btn-check, #readerTransLabel {
        display: none !important;
    }

    /* 3. å»æ‰é»‘èƒŒæ™¯å’Œå¼¹çª—å®šä½ï¼Œè®©å®ƒåƒæ™®é€šæ–‡æ¡£ä¸€æ ·æ’åˆ— */
    .modal-overlay {
    background: white !important;
    display: flex;
    justify-content: center;
    align-items: flex-start; /* æ”¹ä¸ºä»é¡¶éƒ¨å¼€å§‹ï¼Œæ›´åƒæ–‡æ¡£ */
    padding-top: 20px;
}

/* 2. è®©é˜…è¯»å™¨åŒºåŸŸç¨å¾®æ·±ä¸€ç‚¹ç‚¹è¾¹æ¡†ï¼Œé˜²æ­¢å…¨ç™½åˆ†ä¸æ¸…è¾¹ç¼˜ */
#reader-modal .profile-card {
    border: 1px solid #f0f0f0 !important;
    box-shadow: 0 0 20px rgba(0,0,0,0.02) !important;
    width: 100% !important;
    max-width: 1200px !important; /* é™åˆ¶ä¸€ä¸‹æœ€å¤§å®½åº¦ï¼Œåˆ«æ’‘å¾—å¤ªæ­» */
    height: 95vh !important;
}

/* 3. é‡ç‚¹ï¼šè°ƒæ•´é‚£ä¸ªå…³é—­æŒ‰é’® 'X' çš„é¢œè‰²å’Œä½ç½® */
/* å› ä¸ºèƒŒæ™¯å˜ç™½äº†ï¼Œ'X' å¿…é¡»æ˜¯æ·±è‰²çš„æ‰èƒ½çœ‹è§ */
.modal-close {
    color: #666 !important;
    font-size: 32px !important;
    top: 10px !important;
    right: 20px !important;
    font-weight: normal !important;
}

.modal-close:hover {
    color: #ff4d4f !important; /* é¼ æ ‡æŒ‡ä¸Šå»å˜çº¢ï¼Œæ–¹ä¾¿æ“ä½œ */
}

    /* 4. ç¬”è®°æ‰“å°é€»è¾‘ï¼šè—èµ·è¾“å…¥æ¡†ï¼Œæ˜¾ç¤ºåˆ†èº« */
    #lesson-note-area { display: none !important; }
    #note-print-clone { 
        display: block !important; 
        white-space: pre-wrap !important; 
        color: black !important;
        font-size: 14pt !important;
        border: 1px solid #eee !important;
        padding: 15px !important;
    }

    /* 5. å·¦å³æ’ç‰ˆ */
    #script-content { width: 60% !important; float: left !important; border-right: 1px solid #eee; }
    .reader-note-sidebar { width: 35% !important; float: right !important; }
    
    /* ä»…æ‰“å°ç¬”è®°æ¨¡å¼ */
    body.print-notes-only #script-content { display: none !important; }
    body.print-notes-only .reader-note-sidebar { width: 100% !important; float: none !important; }
}
/* é˜…è¯»å™¨æ˜¾éšæ§åˆ¶ */
.hide-reader-py .script-py { display: none; }
.hide-reader-cn .script-cn { display: none; }
.hide-reader-trans .script-trans { display: none; }

/* å¤ç”¨è§†é¢‘é¡µçš„åœ†åœˆæ ·å¼ï¼ˆå¦‚æœ review é¡µæ²¡æœ‰çš„è¯è¯·åŠ ä¸Šï¼‰ */
.toggle-circle { 
    width: 36px; height: 36px; border-radius: 50%; background: #eee; color: #999; 
    display: inline-flex; align-items: center; justify-content: center; 
    font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; 
}
.toggle-circle.on { background: var(--primary); color: white; }
/* ç²¾è¯»è¯¾æ–‡é…è‰²æ–¹æ¡ˆ */
.script-py {
    color: #A77046 !important; /* æ‹¼éŸ³ï¼šå…¸é›…æ£• */
    font-family: "Courier New", monospace;
    font-size: 15px;
    margin-bottom: 4px;
    font-weight: 500;
}

.script-cn {
    color: #2c3e50 !important; /* æ±‰å­—ï¼šæ·±çŸ³æ¿è‰²ï¼Œæ¯”çº¯é»‘æ›´é«˜çº§ */
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 8px;
    line-height: 1.4;
}

.script-trans {
    color: #7f8c8d !important; /* ç¿»è¯‘ï¼šçƒŸç°è‰² */
    font-size: 14px;
    font-style: italic;
    font-weight: normal;
}

/* åºå·æ•°å­—çš„æ ·å¼ */
.script-num {
    font-size: 12px;
    color: #cbd5e1;
    margin-bottom: 5px;
    font-family: Arial, sans-serif;
}
/* ç´§å‡‘å‹å‰§æœ¬é¦†ç½‘æ ¼ */
.library-compact-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* ç¼©å°åˆ°200pxä¸€æ ¼ */
    gap: 15px;
    max-width: 900px;
    margin: 0 auto;
}

.library-card {
    background: white;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #eee;
    transition: 0.2s;
    cursor: pointer;
}

.library-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.library-card img {
    width: 100%;
    height: 120px; /* å›ºå®šå°é¢é«˜åº¦ï¼Œé˜²æ­¢é”™ä½ */
    object-fit: cover;
}

.library-card-info {
    padding: 10px;
}

.library-card-title {
    font-size: 14px;
    font-weight: bold;
    color: var(--text);
    display: -webkit-box;
    -webkit-line-clamp: 2; /* æœ€å¤šæ˜¾ç¤ºä¸¤è¡Œæ ‡é¢˜ */
    line-clamp: 2; 
    -webkit-box-orient: vertical;
    overflow: hidden;
    height: 40px; /* å›ºå®šæ ‡é¢˜é«˜åº¦ */
}
@media print {
    /* 1. è§£å¼€æ‰€æœ‰å®¹å™¨çš„é«˜åº¦å°å°ï¼Œå…è®¸æº¢å‡ºåˆ†é¡µ */
    html, body {
        height: auto !important;
        overflow: visible !important;
    }

    .main {
        height: auto !important;
        overflow: visible !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* 2. éšè—ä¸éœ€è¦æ‰“å°çš„æ‚é¡¹ */
    .sidebar, .header-area, .chart-card, .list-header, .vocab-grid, 
    #library-view, .library-tools, .modal-close, .reader-tools, .btn-check, #readerTransLabel {
        display: none !important;
    }

    /* 3. ä¿®å¤é˜…è¯»å™¨å®¹å™¨ï¼šä¸èƒ½æ˜¯ fixed ä¹Ÿä¸å¯ä»¥æ˜¯ 90vh */
    .modal-overlay {
        position: static !important;
        display: block !important;
        background: white !important;
        padding: 0 !important;
    }

    #reader-modal {
        position: static !important;
        display: block !important;
        height: auto !important;
        width: 100% !important;
        overflow: visible !important;
    }

    .profile-card {
        position: static !important;
        display: block !important; /* æ‰“å°æ—¶å¼ƒç”¨ flexï¼Œé˜²æ­¢åˆ†é¡µå¤±æ•ˆ */
        height: auto !important;
        width: 100% !important;
        max-width: none !important;
        border: none !important;
        box-shadow: none !important;
        overflow: visible !important;
    }

    /* 4. æ’ç‰ˆè°ƒæ•´ï¼šä¸ºäº†æ”¯æŒå¤šé¡µï¼Œæˆ‘ä»¬è®©ç¬”è®°æ’åœ¨è¯¾æ–‡ä¸‹æ–¹ï¼Œæˆ–è€…é€šè¿‡æµ®åŠ¨æ§åˆ¶ */
    #script-content {
        width: 65% !important;
        float: left !important;
        display: block !important;
        height: auto !important;
        overflow: visible !important;
        border-right: 1px solid #eee;
        padding-right: 20px !important;
    }

    .reader-note-sidebar {
        width: 30% !important;
        float: right !important;
        display: block !important;
        height: auto !important;
        overflow: visible !important;
        background: none !important;
    }

    /* 5. ç¬”è®°åˆ†èº«æ˜¾ç¤º */
    #lesson-note-area { display: none !important; }
    #note-print-clone {
        display: block !important;
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
        color: black !important;
        font-size: 14pt !important;
        line-height: 1.6;
        border: 1px dashed #ccc;
        padding: 10px;
    }

    /* ä»…æ‰“å°ç¬”è®°æ¨¡å¼ */
    body.print-notes-only #script-content { display: none !important; }
    body.print-notes-only .reader-note-sidebar { 
        width: 100% !important; 
        float: none !important; 
    }

    /* æ¸…é™¤æµ®åŠ¨ï¼Œç¡®ä¿åˆ†é¡µæ­£å¸¸ */
    .profile-card::after {
        content: "";
        display: table;
        clear: both;
    }
}
    </style>
</head>
<body>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='home.html'">
            <i class="fas fa-chevron-left"></i> è¿”å›èƒŒå•è¯
        </div>
        
        <div class="nav-btn active" onclick="filterList('all', this)">
            <i class="fas fa-layer-group"></i> <span data-i18n="filter_all">æ”¶è—çš„å•è¯</span>
            <span class="badge" id="badge-all">0</span>
        </div>
        <div class="nav-btn" onclick="filterList('due', this)">
            <i class="fas fa-clock"></i> <span data-i18n="filter_due">ä»Šæ—¥éœ€å¤ä¹ </span>
            <span class="badge" id="badge-due" style="background:var(--red); color:white">0</span>
        </div>
        <div class="nav-btn" onclick="filterList('master', this)">
            <i class="fas fa-medal"></i> <span data-i18n="filter_master">å·²æŒæ¡</span>
            <span class="badge" id="badge-master" style="background:var(--yellow); color:#5a3a1a">0</span>
        </div>
        <div class="nav-btn" onclick="showLibrary(this)">
    <i class="fas fa-file-alt"></i> <span data-i18n="menu_library">ç²¾è¯»å‰§æœ¬é¦†</span>
</div>
    </div>

    <div class="main">
        <!-- å‰§æœ¬é¦†ä¸»ç•Œé¢ -->
<div id="library-view" style="display:none;">
    <!-- ğŸŸ¢ æ–°å¢ï¼šæœç´¢å·¥å…·æ  -->
    <div class="library-tools" style="max-width: 900px; margin: 0 auto 20px auto; display: flex; gap: 10px;">
        <div class="search-box" style="flex: 1; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 12px; top: 12px; color: #999;"></i>
            <input type="text" id="librarySearchInput" 
                   style="width: 100%; padding: 10px 10px 10px 35px; border-radius: 10px; border: 1px solid #ddd; outline: none;" 
                   placeholder="æœç´¢è¯¾ç¨‹æ ‡é¢˜æˆ–å…³é”®è¯..." 
                   oninput="renderLibraryGrid()">
        </div>
    </div>

    <!-- ğŸŸ¢ ä¿®æ”¹ï¼šå°† grid çš„ ID æ¢ä¸€ä¸ªï¼Œä»¥ä¾¿åº”ç”¨æ›´ç´§å‡‘çš„æ ·å¼ -->
    <div style="max-height: 480px; overflow-y: auto; padding: 10px; border: 1px solid #f0f0f0; border-radius: 12px; background: #fafafa;">
        <div id="library-grid" class="library-compact-grid">
            <!-- è‡ªåŠ¨å¡«å…… -->
        </div>
    </div>
</div>

<!-- å‰§æœ¬é˜…è¯»å™¨å¼¹çª— (æ”¾åœ¨ main é‡Œé¢æœ€åé¢å³å¯) -->
<div id="reader-modal" class="modal-overlay" style="display:none; background: white; z-index: 9999; overflow: auto;">
    <div class="profile-card" style="width: 95%; max-width: 1100px; height: 90vh; background: white; display:flex; flex-direction:column; padding:0; overflow:hidden;">
        <div class="modal-close" onclick="closeReader()" style="top:10px; right:20px; z-index:100;">Ã—</div>
        
        <div class="reader-tools" style="padding: 15px 25px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#fdfdfd;">
    <div id="reader-title" style="font-weight:bold; font-size:18px; color:var(--blue);">è¯¾ç¨‹æ ‡é¢˜</div>
    
    <!-- ğŸŸ¢ æ–°å¢ï¼šä¸‰è¯­åˆ‡æ¢å¼€å…³ -->
    <div style="display:flex; gap:10px; align-items:center;">
        <div class="toggle-circle on" onclick="toggleReaderVisibility('py', this)" style="width:30px; height:30px; line-height:30px; cursor:pointer;">æ‹¼</div>
        <div class="toggle-circle on" onclick="toggleReaderVisibility('cn', this)" style="width:30px; height:30px; line-height:30px; cursor:pointer;">æ±‰</div>
        <div class="toggle-circle on" onclick="toggleReaderVisibility('trans', this)" id="readerTransLabel" style="width:30px; height:30px; line-height:30px; cursor:pointer;">RU</div>
        
        <div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>
        
        <div style="display:flex; gap:8px;">
    <button class="btn-check" onclick="printLibrary('all')" data-i18n="btn_print_all" style="background:#6CAD9C; padding:6px 12px; font-size:12px; height:auto;">
    <i class="fas fa-print"></i> æ‰“å°å…¨è¯¾
</button>
    <!-- ä»…æ‰“å°ç¬”è®° -->
    <button class="btn-check" onclick="printLibrary('notes')" data-i18n="btn_print_notes" style="background:#A77046; padding:6px 12px; font-size:12px; height:auto;">
    <i class="fas fa-pen"></i> ä»…æ‰“å°ç¬”è®°
</button>
</div>
    </div>
</div>

        <div style="flex:1; display:flex; overflow:hidden;">
            <!-- å·¦ä¾§ï¼šå°è¯æ–‡æœ¬ -->
            <div id="script-content" style="flex:1.5; padding:40px; overflow-y:auto; line-height:2.5; font-size:18px; border-right:1px solid #eee; background: white;">
                <!-- è‡ªåŠ¨å¡«å……å°è¯ -->
            </div>
            <!-- å³ä¾§ï¼šå­¦ä¹ ç¬”è®° -->
            <div class="reader-note-sidebar" style="flex:0.8; padding:25px; background:#F9F7F2; display:flex; flex-direction:column;">
                <h4 style="margin-top:0; color:var(--blue);">
    <i class="fas fa-pen-fancy"></i> <span data-i18n="my_notes_title">æˆ‘çš„ç²¾è¯»ç¬”è®°</span>
</h4>
<div id="mobile-notice" data-i18n="mobile_tip" style="display:none; color:#999; font-size:12px; line-height:1.4; margin-bottom:12px; padding:10px; background:#fff; border:1px solid #eee; border-radius:8px;"></div>
                <textarea id="lesson-note-area" style="flex:1; width:100%; padding:15px; border:1px solid #e0e0e0; border-radius:12px; resize:none; font-size:14px; line-height:1.6; background:white;" placeholder="è®°å½•ä¸‹ä½ åœ¨è¿™æ®µ Vlog é‡Œå­¦åˆ°çš„åœ°é“è¡¨è¾¾..."></textarea>
                <div id="note-print-clone" style="display:none; white-space: pre-wrap; text-align: left; color: black;">
    <!-- æ‰“å°æ—¶ä¼šè‡ªåŠ¨åœ¨ç¬”è®°å‰åŠ ä¸Šè¿™ä¸ªå°æ ‡é¢˜ -->
    <h3 style="border-bottom: 2px solid #6CAD9C; padding-bottom: 5px; color: #14507D;">æˆ‘çš„ç¬”è®°ï¼š</h3>
    <div id="note-text-placeholder"></div>
</div>
                <button class="btn-check" style="margin-top:15px; width:100%; height:45px; background:var(--blue);" onclick="saveCurrentNote()" data-i18n="save_notes_btn">
    ä¿å­˜å¹¶åŒæ­¥ç¬”è®°
</button>
            </div>
        </div>
    </div>
</div>
        <div class="header-area">
            <div class="page-title"><span data-i18n="page_title">æˆ‘çš„è‰¾å®¾æµ©æ–¯æ›²çº¿</span></div>
            <div class="lang-switch" onclick="toggleLang()">
                <i class="fas fa-globe"></i> <span id="langLabel">RU</span>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-wrapper">
                <canvas id="ebbinghausChart"></canvas>
            </div>
            <div class="chart-legend-custom">
                <div class="legend-item"><div class="dot" style="background:#6CAD9C"></div> <span data-i18n="legend_mine">æˆ‘çš„é—å¿˜æ›²çº¿</span></div>
                <div class="legend-item"><div class="dot" style="background:#E5CC84"></div> <span data-i18n="legend_std">è‰¾å®¾æµ©æ–¯æ ‡å‡†æ›²çº¿</span></div>
            </div>
            
            <div class="quote-banner">
                <i class="fas fa-quote-left quote-icon"></i>
                <div data-i18n="chart_desc">
                    æ›²çº¿è§£è¯»ï¼šæ ¹æ®æ‚¨æœ€è¿‘çš„å­¦ä¹ é¢‘ç‡ï¼Œè®¡ç®—äº†ä½ çš„é—å¿˜æ›²çº¿ã€‚åšæŒä½¿ç”¨æœ¬å¹³å°èƒŒå•è¯çš„é¢‘ç‡è¶Šé«˜ï¼Œä½ çš„é—å¿˜æ›²çº¿ç»Ÿè®¡å°±è¶Šç²¾å‡†ï¼Œè€Œä¸”ä½ çš„é—å¿˜ç‡ä¼šè¶Šæ¥è¶Šä½ã€‚
                </div>
            </div>
        </div>

        <div class="list-header">
            <div class="list-title" id="list-title">åˆ—è¡¨</div>
        </div>
        
        <div id="grid" class="vocab-grid">
            <div style="text-align:center; color:#999; margin-top:50px;">
                <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...
            </div>
        </div>
    </div>

    <script>
        let myChart = null; 
        let myVocab = [];
        let vocabMeta = {};
        let currentFilter = 'all';
        let currentLang = 'ru'; 

        const REVIEW_INTERVALS = [5*60*1000, 24*60*60*1000, 3*24*60*60*1000, 7*24*60*60*1000, 15*24*60*60*1000];

        const uiDict = {
            ru: {
                page_title: "ĞšÑ€Ğ¸Ğ²Ğ°Ñ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ", 
                filter_all: "Ğ’ÑĞµ ÑĞ»Ğ¾Ğ²Ğ°", filter_due: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", filter_master: "Ğ’Ñ‹ÑƒÑ‡ĞµĞ½Ğ¾",
                legend_mine: "ĞœĞ¾Ñ ĞºÑ€Ğ¸Ğ²Ğ°Ñ", legend_std: "Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚ Ğ­Ğ±Ğ±Ğ¸Ğ½Ğ³Ğ°ÑƒĞ·Ğ°",
                chart_desc: "Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ: ĞšÑ€Ğ¸Ğ²Ğ°Ñ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ½Ğ° Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ²Ğ°ÑˆĞµĞ¹ Ñ‡Ğ°ÑÑ‚Ğ¾Ñ‚Ñ‹ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ. Ğ§ĞµĞ¼ Ñ‡Ğ°Ñ‰Ğµ Ğ²Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñƒ, Ñ‚ĞµĞ¼ Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ½Ğ¸Ğ¶Ğµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ.",
                list_title_all: "ĞœĞ¾Ğ¹ ÑĞ»Ğ¾Ğ²Ğ°Ñ€ÑŒ", list_title_due: "ĞÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", list_title_master: "Ğ’Ñ‹ÑƒÑ‡ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ»Ğ¾Ğ²Ğ°",
                btn_check: "Ğ£Ñ‡Ğ¸Ñ‚ÑŒ", 
                axis_0:"Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ", axis_1:"1Ğ´", axis_2:"2Ğ´", axis_3:"3Ğ´", axis_4:"4Ğ´", axis_5:"5Ğ´", axis_6:"6Ğ´", axis_7:"7Ğ´", axis_15:"15Ğ´",
                times_label: "Ñ€Ğ°Ğ·",
                msg_empty: "ğŸ‰ ĞŸĞ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾! Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑĞ»Ğ¾Ğ²Ğ° Ğ¸Ğ· Ğ²Ğ¸Ğ´ĞµĞ¾." ,
                btn_print: "ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ",
                menu_library: "Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²",
    reader_sentences: "Ñ„Ñ€Ğ°Ğ·Ñ‹",
    trans_label: "RU",
    btn_print_all: "ĞŸĞµÑ‡Ğ°Ñ‚ÑŒ ÑƒÑ€Ğ¾ĞºĞ°",
        btn_print_notes: "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸",
        my_notes_title: "ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸",
        save_notes_btn: "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸",
        mobile_tip: "Ğ˜Ğ·-Ğ·Ğ° Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ€Ğ°Ğ½ÑÑ‚Ğ²Ğ° Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ½Ğ° Ğ¿Ğ»Ğ°Ğ½ÑˆĞµÑ‚Ğµ Ğ¸Ğ»Ğ¸ ĞºĞ¾Ğ¼Ğ¿ÑŒÑÑ‚ĞµÑ€Ğµ. ĞĞ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼."
            },
            en: {
                page_title: "Forgetting Curve", 
                filter_all: "All Words", filter_due: "Review Due", filter_master: "Mastered",
                legend_mine: "My Curve", legend_std: "Ebbinghaus Standard",
                chart_desc: "Interpretation: Calculated based on your learning frequency. The more you use this platform, the more accurate your curve becomes, and your forgetting rate will decrease.",
                list_title_all: "Collection", list_title_due: "Review Today", list_title_master: "Mastered Words",
                btn_check: "Check",
                axis_0:"Today", axis_1:"1d", axis_2:"2d", axis_3:"3d", axis_4:"4d", axis_5:"5d", axis_6:"6d", axis_7:"7d", axis_15:"15d",
                times_label: "times",
                msg_empty: "ğŸ‰ Empty here! Go collect words from videos.",
                btn_print: "Print",
                 menu_library: "Script Library",
    reader_sentences: "sentences",
    trans_label: "EN",
    btn_print_all: "Print Lesson",
        btn_print_notes: "Notes Only",
        my_notes_title: "My Notes",
        save_notes_btn: "Save & Sync",
        mobile_tip: "Limited screen space. For a better note-taking experience, please use a tablet or computer, or switch to landscape mode."
            },
            cn: {
                page_title: "æˆ‘çš„è‰¾å®¾æµ©æ–¯æ›²çº¿", 
                filter_all: "æ”¶è—çš„å•è¯", filter_due: "ä»Šæ—¥éœ€å¤ä¹ ", filter_master: "å·²æŒæ¡",
                legend_mine: "æˆ‘çš„é—å¿˜æ›²çº¿", legend_std: "è‰¾å®¾æµ©æ–¯æ ‡å‡†æ›²çº¿",
                chart_desc: "æ›²çº¿è§£è¯»ï¼šæ ¹æ®æ‚¨æœ€è¿‘çš„å­¦ä¹ é¢‘ç‡ï¼Œè®¡ç®—äº†ä½ çš„é—å¿˜æ›²çº¿ã€‚åšæŒä½¿ç”¨æœ¬å¹³å°èƒŒå•è¯çš„é¢‘ç‡è¶Šé«˜ï¼Œä½ çš„é—å¿˜æ›²çº¿ç»Ÿè®¡å°±è¶Šç²¾å‡†ï¼Œè€Œä¸”ä½ çš„é—å¿˜ç‡ä¼šè¶Šæ¥è¶Šä½ã€‚",
                list_title_all: "å•è¯åˆ—è¡¨", list_title_due: "ä»Šæ—¥æ€¥éœ€å¤ä¹ ", list_title_master: "å·²æŒæ¡çš„å•è¯",
                btn_check: "æ‰“å¡å¤ä¹ ",
                axis_0:"ä»Šå¤©", axis_1:"1å¤©", axis_2:"2å¤©", axis_3:"3å¤©", axis_4:"4å¤©", axis_5:"5å¤©", axis_6:"6å¤©", axis_7:"7å¤©", axis_15:"15å¤©",
                times_label: "æ¬¡",
                msg_empty: "ğŸ‰ ç©ºç©ºå¦‚ä¹Ÿï¼å¿«å»è§†é¢‘é‡Œç‚¹å‡»å•è¯æ”¶è—å§ï¼",
                btn_print: "æ‰“å°è¯¾æ–‡",
                menu_library: "ç²¾è¯»å‰§æœ¬é¦†",
    reader_sentences: "å¥ç²¾é€‰å°è¯",
    trans_label: "è¯‘",
    btn_print_all: "æ‰“å°å…¨è¯¾",
        btn_print_notes: "ä»…æ‰“å°ç¬”è®°",
        my_notes_title: "æˆ‘çš„ç²¾è¯»ç¬”è®°",
        save_notes_btn: "ä¿å­˜å¹¶åŒæ­¥ç¬”è®°",
        mobile_tip: "å› æ‰‹æœºé¡µé¢ç©ºé—´æœ‰é™ï¼Œå»ºè®®åœ¨å¹³æ¿æˆ–ç”µè„‘ä¸Šåšç¬”è®°ã€‚å¦‚éœ€åœ¨æ‰‹æœºä¸Šä½¿ç”¨ï¼Œå»ºè®®æ¨ªå±ã€‚"
            }
        };

        // 1. åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            updateLanguage(); 
            initChart();      
            
            // await syncFromCloud(); // <--- æˆ‘æŠŠå®ƒåˆ æ‰äº†ï¼Œä¸å†è‡ªåŠ¨æ‹‰å–æ—§æ•°æ®
            
            loadLocalData(); // åªè¯»å–æœ¬åœ°æœ€æ–°çš„çŠ¶æ€
            render();
        });

        // 2. äº‘ç«¯åŒæ­¥
        async function syncFromCloud() {
            if (!supabaseClient) return;
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            try {
                const { data } = await supabaseClient
                    .from('user_progress')
                    .select('data')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (data && data.data) {
                    const cloudList = JSON.parse(data.data['my_vocab_list'] || '[]');
                    const localList = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
                    const mergedList = [...new Set([...cloudList, ...localList])];
                    localStorage.setItem('my_vocab_list', JSON.stringify(mergedList));
                    
                    const cloudMeta = JSON.parse(data.data['my_vocab_meta'] || '{}');
                    const localMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
                    const mergedMeta = { ...cloudMeta, ...localMeta };
                    localStorage.setItem('my_vocab_meta', JSON.stringify(mergedMeta));
                    console.log("âœ… å¤ä¹ æœ¬å·²ä¸äº‘ç«¯åˆå¹¶");
                }
            } catch (e) { console.error("åŒæ­¥å‡ºé”™:", e); }
        }

        // 3. åŠ è½½æœ¬åœ°
        function loadLocalData() {
            myVocab = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
            vocabMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
            const now = Date.now();
            myVocab.forEach(word => {
                if (!vocabMeta[word]) {
                    vocabMeta[word] = { created: now, nextReview: now, level: 0, note: "" };
                }
            });
            saveMeta(false); 
        }

        // 4. ä¿å­˜
        async function saveMeta(upload = true) { 
            localStorage.setItem('my_vocab_meta', JSON.stringify(vocabMeta));
            localStorage.setItem('my_vocab_list', JSON.stringify(myVocab)); 
            
            if (upload && supabaseClient) {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    try {
                        const { data } = await supabaseClient
                            .from('user_progress')
                            .select('data')
                            .eq('user_id', user.id)
                            .maybeSingle();
                        
                        const currentData = data ? data.data : {};
                        currentData['my_vocab_list'] = localStorage.getItem('my_vocab_list');
                        currentData['my_vocab_meta'] = localStorage.getItem('my_vocab_meta');
                        
                        await supabaseClient
                            .from('user_progress')
                            .upsert({ 
                                user_id: user.id, 
                                data: currentData,
                                updated_at: new Date().toISOString() 
                            });
                    } catch (e) { console.error(e); }
                }
            }
        }

        function markReviewed(word, btn) {
            const meta = vocabMeta[word];
            if(!meta) return;
            meta.level = Math.min(meta.level + 1, REVIEW_INTERVALS.length);
            meta.nextReview = Date.now() + (REVIEW_INTERVALS[meta.level] || 30*24*60*60*1000);
            saveMeta(true); 
            btn.classList.add('checked');
            btn.innerHTML = '<i class="fas fa-check"></i> OK';
            btn.disabled = true;
            setTimeout(render, 500); 
        }
        
        function saveUserNote(word, el) { 
            if(vocabMeta[word]) { 
                vocabMeta[word].note = el.value; 
                saveMeta(true); 
            } 
        }

        function filterList(type, btn) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(document.getElementById('reader-modal')) document.getElementById('reader-modal').style.display = 'none';
if(document.getElementById('library-view')) document.getElementById('library-view').style.display = 'none';
    btn.classList.add('active');
    currentFilter = type;

    // ğŸ”´ å…³é”®ï¼šæŠŠå‰§æœ¬é¦†å½»åº•è—èµ·æ¥
    const libView = document.getElementById('library-view');
    if (libView) libView.style.display = 'none';

    // ğŸŸ¢ æŠŠç”Ÿè¯æœ¬çš„é›¶ä»¶ä¸€ä¸ªä¸ªå…¨éƒ½æ˜¾ç¤ºå›æ¥
    document.querySelector('.header-area').style.display = 'flex';
    document.querySelector('.chart-card').style.display = 'block';
    document.querySelector('.list-header').style.display = 'flex';
    document.getElementById('grid').style.display = 'grid';

    render();
}
        function render() {
            const container = document.getElementById('grid');
            container.innerHTML = '';
            const now = Date.now();
            let countTotal = 0, countDue = 0, countMaster = 0;

            const listToShow = myVocab.filter(word => {
                const meta = vocabMeta[word];
                if (!meta) return false; 
                countTotal++;
                const isDue = meta.nextReview <= now;
                const isMaster = meta.level >= 4; 
                if (isDue) countDue++;
                if (isMaster) countMaster++;
                if (currentFilter === 'due') return isDue;
                if (currentFilter === 'master') return isMaster;
                return true;
            });

            document.getElementById('badge-all').innerText = countTotal;
            document.getElementById('badge-due').innerText = countDue;
            document.getElementById('badge-master').innerText = countMaster;

            const titleKey = 'list_title_' + currentFilter;
            document.getElementById('list-title').innerText = uiDict[currentLang][titleKey] || "List";

            if (listToShow.length === 0) {
                const emptyText = uiDict[currentLang].msg_empty;
                container.innerHTML = `<div class="empty">${emptyText}</div>`;
                return;
            }

            listToShow.forEach(word => {
                const meta = vocabMeta[word];
                const isDue = meta.nextReview <= now;
                const isMaster = meta.level >= 4;
                
                let details = { py: "", mean: "" };
                if (window.lessonDatabase) {
                    for (let id in window.lessonDatabase) {
                        const dict = window.lessonDatabase[id].dictionary;
                        if (dict && dict[word]) { details = dict[word]; break; }
                    }
                }

                const card = document.createElement('div');
                let statusClass = 'status-new';
                if (isDue) statusClass = 'status-due';
                if (isMaster) statusClass = 'status-master';
                card.className = `word-card ${statusClass}`;
                
                const unit = uiDict[currentLang].times_label; 
                const countDisplay = `<i class="fas fa-check-double"></i> ${meta.level} ${unit}`;

                // ğŸŸ¢ å¸ƒå±€ä¼˜åŒ–ï¼šå·¦è¾¹æ±‰å­—æ‹¼éŸ³ï¼Œå³è¾¹å–‡å­
                // ğŸ”´ åº•éƒ¨å·¦è¾¹ï¼šæ¬¡æ•°+åƒåœ¾æ¡¶
                card.innerHTML = `
                    <div class="wc-top">
                        <div style="display:flex; align-items:baseline;">
                            <span class="wc-hz">${word}</span>
                            <span class="wc-py">${details.py || ''}</span>
                        </div>
                        <i class="fas fa-volume-up icon-btn" onclick="speak('${word}')"></i>
                    </div>

                    <div class="wc-mean">${details.mean || '...'}</div>
                    <textarea class="note-area" placeholder="âœï¸..." onchange="saveUserNote('${word}', this)">${meta.note || ''}</textarea>
                    
                    <div class="wc-foot">
                        <!-- æ¬¡æ•°å’Œåƒåœ¾æ¡¶æ”¾åœ¨ä¸€èµ· -->
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span style="color:#888; font-size:11px;">${countDisplay}</span>
                            <i class="fas fa-trash-alt icon-btn btn-trash" onclick="deleteWord('${word}')" title="åˆ é™¤"></i>
                        </div>

                        ${isDue ? 
                            `<button class="btn-check" onclick="markReviewed('${word}', this)">${uiDict[currentLang].btn_check}</button>` 
                            : 
                            `<span style="color:#ccc; font-size:11px;">${new Date(meta.nextReview).getMonth()+1}/${new Date(meta.nextReview).getDate()}</span>`
                        }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function speak(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-CN'; speechSynthesis.speak(u); }
        
        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en'; else if (currentLang === 'en') currentLang = 'cn'; else currentLang = 'ru';
            updateLanguage();
            initChart(); 
            render();
        }

        function updateLanguage() {
            let label = 'ğŸ‡·ğŸ‡º RU'; if (currentLang === 'en') label = 'ğŸ‡ºğŸ‡¸ EN'; if (currentLang === 'cn') label = 'ğŸ‡¨ğŸ‡³ CN';
            document.getElementById('langLabel').innerText = label;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (uiDict[currentLang][key]) el.innerText = uiDict[currentLang][key];
            });
        }

        function initChart() {
            const ctx = document.getElementById('ebbinghausChart').getContext('2d');
            const labels = [
                uiDict[currentLang].axis_0, uiDict[currentLang].axis_1, uiDict[currentLang].axis_2,
                uiDict[currentLang].axis_3, uiDict[currentLang].axis_4, uiDict[currentLang].axis_5,
                uiDict[currentLang].axis_6, uiDict[currentLang].axis_7, uiDict[currentLang].axis_15
            ];

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Mine',
                            data: [100, 65, 55, 48, 42, 38, 36, 35, 33],
                            borderColor: '#6CAD9C',
                            backgroundColor: 'rgba(108, 173, 156, 0.1)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#6CAD9C',
                            pointRadius: 5,
                            tension: 0.4, fill: true
                        },
                        {
                            label: 'Standard',
                            data: [100, 40, 30, 25, 23, 21, 20, 19, 18],
                            borderColor: '#E5CC84',
                            borderWidth: 2,
                            pointRadius: 0,
                            borderDash: [5, 5],
                            tension: 0.4, fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        async function deleteWord(word) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${word}" å—ï¼Ÿ`)) return;
            myVocab = myVocab.filter(w => w !== word);
            delete vocabMeta[word];
            localStorage.setItem('my_vocab_list', JSON.stringify(myVocab));
            localStorage.setItem('my_vocab_meta', JSON.stringify(vocabMeta));
            await saveMeta(true);
            render();
        }
        let currentReadingLessonId = null;


// æ˜¾ç¤ºå‰§æœ¬é¦†
function showLibrary(btn) {
    // 1. æŒ‰é’®é«˜äº®
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    // 2. ğŸŸ¢ æ–°å¢ï¼šéšè—åŸæœ¬é‚£ä¸ªæ˜¾ç¤ºâ€œè‰¾å®¾æµ©æ–¯æ›²çº¿â€æ ‡é¢˜çš„åŒºåŸŸ
    if(document.querySelector('.main > .header-area')) {
        document.querySelector('.main > .header-area').style.display = 'none';
    }

    // 3. éšè—å…¶ä»–è§†å›¾
    document.querySelector('.chart-card').style.display = 'none';
    document.getElementById('grid').style.display = 'none';
    document.querySelector('.list-header').style.display = 'none';

    // 4. æ˜¾ç¤ºå‰§æœ¬é¦†
    const libraryView = document.getElementById('library-view');
    libraryView.style.display = 'block';

    // 5. ğŸŸ¢ æ–°å¢ï¼šæ ¹æ®å½“å‰è¯­è¨€æ›´æ–°æ ‡é¢˜å’Œå¼¹çª—å†…çš„ç¿»è¯‘æ ‡ç­¾
    document.querySelector('.page-title span').innerText = uiDict[currentLang].menu_library;
    if(document.getElementById('readerTransLabel')) {
        document.getElementById('readerTransLabel').innerText = uiDict[currentLang].trans_label || "RU";
    }

    renderLibraryGrid();
}

// æ¸²æŸ“å°é¢åˆ—è¡¨
function renderLibraryGrid() {
    const grid = document.getElementById('library-grid');
    const searchTerm = document.getElementById('librarySearchInput').value.toLowerCase(); // è·å–æœç´¢è¯
    grid.innerHTML = '';
    
    if (!window.lessonDatabase) return;

    const userAccess = JSON.parse(localStorage.getItem('my_access_tags') || '["season_1"]');

    for (const id in window.lessonDatabase) {
        const lesson = window.lessonDatabase[id];
        
        // ğŸŸ¢ æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæœç´¢æ¡†æœ‰è¯ï¼Œä¸”æ ‡é¢˜/æè¿°é‡Œä¸åŒ…å«è¿™ä¸ªè¯ï¼Œå°±è·³è¿‡ä¸æ˜¾ç¤º
        const lessonSearchStr = (lesson.title + (lesson.desc || "")).toLowerCase();
        if (searchTerm && !lessonSearchStr.includes(searchTerm)) {
            continue; 
        }

        const isLocked = lesson.batch && !userAccess.includes(lesson.batch);
        const coverImg = lesson.cover.includes('.') ? lesson.cover : lesson.cover + ".jpg";

        const card = document.createElement('div');
        card.className = 'library-card'; // ä½¿ç”¨ç´§å‡‘æ ·å¼ç±»å
        card.style.opacity = isLocked ? '0.6' : '1';
        
        card.innerHTML = `
            <div style="position:relative;">
                <img src="${coverImg}">
                ${isLocked ? '<div style="position:absolute; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-lock"></i></div>' : ''}
            </div>
            <div class="library-card-info">
                <div class="library-card-title">${lesson.title}</div>
                <div style="font-size:11px; color:#aaa; margin-top:5px;">
                    <i class="far fa-file-alt"></i> ${lesson.subs ? lesson.subs.length : 0} ${uiDict[currentLang].reader_sentences || 'sentences'}
                </div>
            </div>
        `;
        
        if (!isLocked) {
            card.onclick = () => openReader(id);
        } else {
            card.onclick = () => alert("ğŸ”’ æ­¤å‰§æœ¬éœ€è¦è§£é”æƒé™");
        }
        grid.appendChild(card);
    }

    // å¦‚æœæœç´¢ç»“æœä¸ºç©º
    if (grid.innerHTML === '') {
        grid.innerHTML = `<div style="grid-column: 1/-1; text-align:center; color:#999; padding:40px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯¾ç¨‹</div>`;
    }
}

// æ‰“å¼€ç²¾è¯»é˜…è¯»å™¨
// ä¿®æ”¹ openReader å‡½æ•°
function openReader(id) {
    currentReadingLessonId = id;
    const lesson = window.lessonDatabase[id];
    const scriptDiv = document.getElementById('script-content');
    document.getElementById('reader-title').innerText = lesson.title;
    
    // æ¸²æŸ“æ–‡æœ¬å†…å®¹
    scriptDiv.innerHTML = lesson.subs.map((s, idx) => `
        <div class="script-item" style="margin-bottom:30px; border-bottom: 1px solid #f9f9f9; padding-bottom:15px;">
            <div class="script-num">#${idx+1}</div>
            <div class="script-py">${s.py}</div>
            <div class="script-cn">${s.cn}</div>
            <div class="script-trans">${currentLang === 'ru' ? s.ru : (s.en || s.ru)}</div>
        </div>
    `).join('');
    
    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿æ‰“å¼€æ—¶ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€æ–°ç¬”è®°
    const savedMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
    const noteKey = `note_lesson_${id}`;
    document.getElementById('lesson-note-area').value = savedMeta[noteKey] || "";
    
    document.getElementById('reader-modal').style.display = 'flex';
}

// ä¿®æ”¹ä¿å­˜å‡½æ•°
async function saveCurrentNote() {
    const note = document.getElementById('lesson-note-area').value;
    if (!currentReadingLessonId) return;

    // 1. è·å–æœ¬åœ°æ—§æ•°æ®å¹¶åˆå¹¶æ–°ç¬”è®°
    let localMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
    localMeta[`note_lesson_${currentReadingLessonId}`] = note;
    
    // 2. å­˜å› localStorage
    localStorage.setItem('my_vocab_meta', JSON.stringify(localMeta));
    
    // 3. è¿™é‡Œçš„ vocabMeta æ˜¯å…¨å±€å˜é‡ï¼Œä¹Ÿè¦åŒæ­¥æ›´æ–°ï¼Œé˜²æ­¢å…¶ä»–å‡½æ•°è¯»å–æ—§å€¼
    if (typeof vocabMeta !== 'undefined') {
        vocabMeta = localMeta; 
    }

    // 4. è°ƒç”¨åŒæ­¥å‡½æ•°ä¸Šä¼  Supabase
    if (typeof saveMeta === 'function') {
        try {
            await saveMeta(true);
            alert("âœ… ç¬”è®°å·²æ°¸ä¹…ä¿å­˜è‡³äº‘ç«¯");
        } catch(e) {
            alert("âš ï¸ ç¬”è®°å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        }
    }
}
function toggleReaderVisibility(type, btn) {
    const content = document.getElementById('script-content');
    const className = 'hide-reader-' + type;
    
    if (content.classList.contains(className)) {
        content.classList.remove(className);
        btn.classList.add('on');
    } else {
        content.classList.add(className);
        btn.classList.remove('on');
    }
}
// ğŸŸ¢ ä¸“é—¨å¤„ç†æ‰“å°é€»è¾‘çš„å‡½æ•°ï¼ˆå»ºè®®æ”¾åœ¨ saveCurrentNote å‡½æ•°ä¸‹é¢ï¼‰
function printLibrary(mode) {
    // 1. åŒæ­¥æ–‡å­—
    const noteArea = document.getElementById('lesson-note-area');
    const clone = document.getElementById('note-print-clone');
    
    if (!noteArea || !clone) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¬”è®°åŒºåŸŸï¼Œè¯·æ£€æŸ¥ä»£ç IDæ˜¯å¦æ­£ç¡®");
        return;
    }

    clone.innerText = noteArea.value || "ï¼ˆæœ¬æ¬¡ç²¾è¯»æš‚æ— ç¬”è®°ï¼‰";

    // 2. æ¨¡å¼åˆ‡æ¢
    if (mode === 'notes') {
        document.body.classList.add('print-notes-only');
    } else {
        document.body.classList.remove('print-notes-only');
    }
    
    // 3. æ‰§è¡Œæ‰“å°
    setTimeout(() => {
        window.print();
        document.body.classList.remove('print-notes-only');
    }, 150);
}
    </script>
</body>
</html>
