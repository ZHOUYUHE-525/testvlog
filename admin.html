<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­ Vlog | å¤‡è¯¾åå° (AI é¢„åˆ¶è¯å…¸ç‰ˆ)</title>
    
    <!-- 1. å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #6CAD9C; --bg: #f3f4f6; --white: #ffffff; --text: #374151; --border: #e5e7eb; --red: #ef4444; --yellow: #f59e0b; }
        body { font-family: "PingFang SC", sans-serif; background: var(--bg); color: var(--text); padding: 30px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 16px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 25px; }
        .step-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; }
        .step-title { font-size: 18px; font-weight: 800; }
        .step-num { background: var(--primary); color: white; padding: 2px 10px; border-radius: 20px; font-size: 12px; margin-right: 8px; }
        .input-row { display: flex; gap: 20px; }
        .input-group { margin-bottom: 10px; flex: 1; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #666; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; font-family: monospace; }
        .btn { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: inline-flex; align-items: center; gap: 5px; font-size: 14px; }
        .btn:hover { opacity: 0.9; } .btn-green { background: #10b981; } .btn-yellow { background: var(--yellow); color: #4a3b32; } .btn-blue { background: #3b82f6; } .btn-purple { background: #8b5cf6; }
        
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .editor-list { display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .sentence-row { display: flex; gap: 10px; padding: 10px; border: 1px solid white; background: #f9fafb; border-radius: 8px; }
        .sentence-row.is-target { background: #fffbeb; border-color: var(--yellow); }
        .flashcard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 15px; }
        .fc-item { border: 1px solid #e5e7eb; padding: 12px; border-radius: 8px; background: #fff; position: relative; }
        .fc-input { width: 100%; border: none; border-bottom: 1px solid #eee; padding: 4px 0; margin-bottom: 4px; background: transparent; }
        
        /* è¯å…¸çŠ¶æ€æ ‡è®° */
        .dict-status { font-size: 10px; color: #aaa; position: absolute; bottom: 5px; right: 10px; }
        .dict-status.done { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h2 style="color:var(--text)">ğŸ”’ æ•™å¸ˆèº«ä»½éªŒè¯</h2>
        <input type="email" id="adminEmail" placeholder="é‚®ç®±" style="width:300px; margin-bottom:10px;">
        <input type="password" id="adminPwd" placeholder="å¯†ç " style="width:300px; margin-bottom:20px;">
        <button class="btn" onclick="adminLogin()">ç™»å½•åå°</button>
        <p style="margin-top:20px; color:red; font-size:12px;" id="loginStatus"></p>
    </div>

    <h1><i class="fas fa-cloud-upload-alt"></i> æ±‰è¯­ Vlog | äº‘ç«¯å¤‡è¯¾å°</h1>

    <!-- 0. è®¾ç½® -->
    <div class="card" style="background:#e0f2fe;">
        <div class="input-row">
            <div class="input-group">
                <label>DeepSeek API Key (ç”Ÿæˆè¯å…¸å¿…é¡»)</label>
                <input type="password" id="apiKey" placeholder="sk-...">
            </div>
        </div>
    </div>


    <!-- 1. å¯¼å…¥ -->
    <div class="card">
        <div class="step-header"><div class="step-title"><span class="step-num">1</span> å¯¼å…¥å­—å¹•</div></div>
        <div class="input-row">
            <div class="input-group"><label>è¯¾ç¨‹ ID</label><input id="lessonId" placeholder="ä¾‹å¦‚: 001"></div>
            <div class="input-group"><label>è¯¾ç¨‹æ ‡é¢˜</label><input id="lessonTitle"></div>
            <div class="input-group"><label>è§†é¢‘æ–‡ä»¶(Cloudinaryé“¾æ¥)</label><input id="videoFile" placeholder="https://res.cloudinary.com/..."></div>
        </div>
        <textarea id="srtInput" placeholder="åœ¨æ­¤ç²˜è´´ SRT å­—å¹•..." style="height: 100px; margin-bottom:10px;"></textarea>
        <button class="btn" onclick="parseSRT()">ğŸš€ è§£æå­—å¹•</button>
    </div>

    <!-- 2. è¯¦æƒ… -->
    <div class="card" id="detailSection" style="display:none;">
        <div class="step-header">
            <div class="step-title"><span class="step-num">2</span> è§†é¢‘è¯¦æƒ… & ç¿»è¯‘</div>
            <button class="btn btn-blue" onclick="aiTranslateScript()" id="transBtn"><i class="fas fa-language"></i> AI å…¨æ–‡ç¿»è¯‘</button>
        </div>
        <div class="input-row">
            <div class="input-group"><label>ä½œè€…</label><input id="vAuthor"></div>
            <div class="input-group"><label>éš¾åº¦</label><input id="vHSK" placeholder="HSK 4"></div>
            <div class="input-group"><label>åˆ†ç±»</label><input id="vTopic" list="topicList" placeholder="job">
                <datalist id="topicList"><option value="job"><option value="life"><option value="food"><option value="culture"></datalist>
            </div>
            <div class="input-group"><label>æ—¶é•¿</label><input id="vDuration" placeholder="02:30"></div>
            <div class="input-group"><label>å°é¢</label><input id="vCover" placeholder="cover.jpg"></div>
        </div>
        <div class="input-group"><label>ç®€ä»‹</label><input id="vDesc"></div>
        <div style="margin-top:15px;">
            <label>å¹³è¡Œèµ„æº (JSON)</label>
            <textarea id="parallelJson" style="height:60px;" placeholder='[]'></textarea>
            <button class="btn btn-yellow" onclick="formatParallel()" style="margin-top:5px;font-size:12px;">æ ¼å¼åŒ–æ¨¡ç‰ˆ</button>
        </div>
    </div>

    <!-- 3. åˆ’è¯ -->
    <div class="card" id="step3" style="display:none;">
        <div class="step-header"><div class="step-title"><span class="step-num">3</span> åˆ’è¯å‡ºé¢˜</div></div>
        <div class="editor-list" id="sentList"></div>
    </div>

    <!-- 4. è¯å¡ä¸è¯å…¸ç”Ÿæˆ -->
    <div class="card" id="step2" style="display:none;">
        <div class="step-header">
            <div class="step-title"><span class="step-num">4</span> è¯å¡ & é¢„åˆ¶è¯å…¸</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-green" onclick="aiAutoFill()" id="aiBtn"><i class="fas fa-magic"></i> AI è¡¥å…¨è¯å¡</button>
                <!-- ğŸ”´ æ–°å¢æŒ‰é’® -->
                <button class="btn btn-purple" onclick="aiBatchDict()" id="dictBtn"><i class="fas fa-book"></i> AI æ‰¹é‡ç”Ÿæˆè¯å…¸</button>
            </div>
        </div>
        <div class="flashcard-grid" id="fcList"></div>
    </div>

    <!-- 5. å¯¼å‡º -->
    <div class="card" id="step4" style="display:none; text-align:center;">
        <button class="btn btn-green" onclick="uploadToCloud()" id="uploadBtn">
            <i class="fas fa-cloud-upload-alt"></i> å¤‡ä»½åˆ° Supabase (ä»…ç®¡ç†å‘˜)
        </button>
        <button class="btn btn-blue" onclick="downloadDataJs()" style="margin-left:10px;">
            <i class="fas fa-file-download"></i> å¯¼å‡º data.js (ç»™å­¦ç”Ÿç”¨)
        </button>
    </div>

    <script>
        // === å…¨å±€å˜é‡ ===
        let parsedSentences = [], flashcards = [];
        // ğŸŸ¢ æ–°å¢ï¼šé¢„åˆ¶è¯å…¸å¯¹è±¡
        let preCookedDictionary = {}; 
        let dbClient = null; 

        // ğŸ”´ğŸ”´ğŸ”´ è¯·å¡«å…¥ä½ çš„ Supabase URL å’Œ Key ğŸ”´ğŸ”´ğŸ”´
        const SUPABASE_URL = 'https://bwweaohahsafbecogist.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3d2Vhb2hhaHNhZmJlY29naXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTk3MjMsImV4cCI6MjA4NDMzNTcyM30.ZqViPiwlvzzaqkWLMzejjpgHXeztkD0K0ne32kfGhWw'; 

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof window.supabase === 'undefined') return alert("Supabase åº“æœªåŠ è½½");
            try {
                dbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data } = await dbClient.auth.getSession();
                if (data && data.session) document.getElementById('loginOverlay').style.display = 'none';
            } catch (e) { console.error(e); }
        });

        // === ç™»å½• ===
        async function adminLogin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPwd').value;
            try {
                const { error } = await dbClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                document.getElementById('loginOverlay').style.display = 'none';
            } catch (err) { alert("ç™»å½•å¤±è´¥: " + err.message); }
        }


        // 2. ä¿å­˜å…¬å‘Š
        async function saveNotice() {
            const text = document.getElementById('noticeInput').value;
            if(!dbClient) return alert("æ•°æ®åº“æœªè¿æ¥");
            
            const btn = event.target; // è·å–ç‚¹å‡»çš„æŒ‰é’®
            btn.innerText = "ä¿å­˜ä¸­...";
            
            const { error } = await dbClient
                .from('app_settings')
                .upsert({ id: 1, notice: text });

            if (error) {
                alert("ä¿å­˜å¤±è´¥: " + error.message);
            } else {
                alert("âœ… å…¬å‘Šå·²æ›´æ–°ï¼å­¦ç”Ÿåˆ·æ–°é¦–é¡µå³å¯çœ‹åˆ°ã€‚");
            }
            btn.innerHTML = "ğŸ’¾ ä¿å­˜å…¬å‘Š";
        }

        // ğŸŸ¢ è®°å¾—åœ¨åˆå§‹åŒ–é‡Œè°ƒç”¨ loadNotice()
        // æ‰¾åˆ° document.addEventListener('DOMContentLoaded', ...) 
        // åœ¨é‡Œé¢çš„ if (data && data.session) ä¸‹é¢åŠ ä¸€è¡Œï¼š
        // loadNotice();

        // === å­—å¹•è§£æ ===
        function parseSRT() {
            const raw = document.getElementById('srtInput').value;
            if (!raw.trim()) return alert("è¯·ç²˜è´´å†…å®¹");
            const regex = new RegExp("(\\d+)\\n(\\d{2}:\\d{2}:\\d{2},\\d{3}) --> (\\d{2}:\\d{2}:\\d{2},\\d{3})\\n([\\s\\S]*?)(?=\\n\\n|\\n$|$)", "g");
            let match; parsedSentences = [];
            while ((match = regex.exec(raw + "\n\n")) !== null) {
                parsedSentences.push({ start: timeToSec(match[2]), end: timeToSec(match[3]), cn: match[4].replace(/\n/g, ' ').trim(), target: null });
            }
            if (parsedSentences.length === 0) {
                 const lines = raw.split('\n').filter(l => l.trim());
                 parsedSentences = lines.map((l, i) => ({ start: i*3, end: i*3+3, cn: l.trim(), target: null }));
            }
            renderSentenceList();
            document.getElementById('detailSection').style.display = 'block';
            document.getElementById('step2').style.display = 'block';
            document.getElementById('step3').style.display = 'block';
            document.getElementById('step4').style.display = 'block';
        }
        function timeToSec(timeStr) {
            const [h, m, s] = timeStr.split(':'); const [sec, ms] = s.split(',');
            return parseInt(h)*3600 + parseInt(m)*60 + parseInt(sec) + parseInt(ms)/1000;
        }

        // === æ¸²æŸ“åˆ—è¡¨ ===
        function renderSentenceList() {
            const list = document.getElementById('sentList'); list.innerHTML = '';
            parsedSentences.forEach((sent, i) => {
                const div = document.createElement('div');
                div.className = `sentence-row ${sent.target ? 'is-target' : ''}`;
                div.innerHTML = `
                    <div style="font-size:12px;color:#999;width:50px;">${sent.start.toFixed(1)}s</div>
                    <div style="flex:1;">
                        <div onmouseup="checkSelection(${i})">${sent.cn}</div>
                        ${sent.target ? `<div style="color:#b45309;font-size:12px;font-weight:bold;">[${sent.target}]</div>` : ''}
                    </div>
                    <div style="display:flex;flex-direction:column;gap:5px;">
                        <button class="btn btn-yellow" style="padding:2px 8px;font-size:10px;" onclick="setTarget(${i})">å¡«ç©º</button>
                        <button class="btn btn-green" style="padding:2px 8px;font-size:10px;" onclick="extractCard(${i})">è¯å¡</button>
                    </div>`;
                list.appendChild(div);
            });
        }
        
        let currentSelection = "";
        function checkSelection(i) { currentSelection = window.getSelection().toString().trim(); }
        
        function setTarget(i) {
            if(!currentSelection) return alert("è¯·å…ˆåˆ’é€‰æ–‡å­—");
            parsedSentences[i].target = currentSelection; renderSentenceList(); currentSelection = "";
        }
        function extractCard(i) {
            if(!currentSelection) return alert("è¯·å…ˆåˆ’é€‰æ–‡å­—");
            if(flashcards.find(f => f.cn === currentSelection)) return alert("å·²å­˜åœ¨");
            // åˆå§‹åŒ–è¯å¡
            flashcards.push({ cn: currentSelection, py:"", ru:"", en:"", ex:"", time: parsedSentences[i].start, video_ex: parsedSentences[i].cn });
            renderFlashcards(); currentSelection = "";
        }

        function renderFlashcards() {
            const container = document.getElementById('fcList'); container.innerHTML = '';
            flashcards.forEach((fc, i) => {
                const hasDict = preCookedDictionary[fc.cn] ? "âœ… AIè¯å…¸å·²ç”Ÿæˆ" : "";
                const div = document.createElement('div'); div.className = 'fc-item';
                div.innerHTML = `
                    <input class="fc-input" style="font-weight:bold;" value="${fc.cn}" onchange="flashcards[${i}].cn=this.value">
                    <input class="fc-input" placeholder="æ‹¼éŸ³" value="${fc.py}" onchange="flashcards[${i}].py=this.value">
                    <input class="fc-input" placeholder="ä¿„è¯­" value="${fc.ru}" onchange="flashcards[${i}].ru=this.value">
                    <input class="fc-input" placeholder="è‹±è¯­" value="${fc.en}" onchange="flashcards[${i}].en=this.value">
                    <span class="dict-status ${hasDict?'done':''}">${hasDict}</span>
                    <i class="fas fa-trash" style="position:absolute;top:10px;right:10px;color:#f87171;cursor:pointer;" onclick="removeCard(${i})"></i>`;
                container.appendChild(div);
            });
        }
        function removeCard(i) { flashcards.splice(i, 1); renderFlashcards(); }

        // === AI åŠŸèƒ½ (ä¾èµ– node server.js) ===
        async function callDeepSeek(prompt) {
            const key = document.getElementById('apiKey').value; 
            if(!key) throw new Error("è¯·å¡«å…¥ API Key");
            
            const res = await fetch("http://localhost:3000/api/chat", {
                method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                body: JSON.stringify({ model: "deepseek-chat", messages: [{ role: "user", content: prompt }] })
            });
            const data = await res.json();
            return data.choices[0].message.content.replace(/```json|```/g, '').trim();
        }

        // 1. å…¨æ–‡ç¿»è¯‘
        async function aiTranslateScript() {
            const btn = document.getElementById('transBtn'); btn.innerText = "ç¿»è¯‘ä¸­..."; btn.disabled = true;
            try {
                // 1. å‡†å¤‡å¸¦IDçš„æ•°æ®ï¼ˆç»™AIé˜²é”™ä½ç”¨ï¼‰
            const simpleSubs = parsedSentences.map((s, i) => ({
                id: i,
                cn: s.cn
            }));

            // 2. å¼ºåŠ›é˜²é”™ä½æç¤ºè¯
            const prompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­—å¹•ç¿»è¯‘ä¸“å®¶ã€‚
ä»»åŠ¡ï¼šå°† JSON ä¸­çš„ "cn" (ä¸­æ–‡) ç¿»è¯‘æˆ "ru" (ä¿„è¯­) å’Œ "en" (è‹±è¯­)ï¼Œå¹¶ç”Ÿæˆ "py" (æ‹¼éŸ³)ã€‚

âš ï¸âš ï¸âš ï¸ æ ¸å¿ƒè§„åˆ™ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
1. **ä¿æŒæ•°ç»„é•¿åº¦ä¸€è‡´**ï¼šè¾“å…¥æœ‰ ${simpleSubs.length} æ¡ï¼Œè¾“å‡ºå¿…é¡»ä¸¥æ ¼è¿”å› ${simpleSubs.length} æ¡ã€‚
2. **å¤„ç†æ–­å¥ï¼ˆåˆå¹¶ä¸ç•™ç©ºï¼‰**ï¼š
   - å¦‚æœé‡åˆ°å‰ªæ˜ æŠŠä¸€å¥è¯åˆ‡æˆäº†ä¸¤è¡Œï¼ˆä¾‹å¦‚ç¬¬1è¡Œæ˜¯å‰åŠå¥ï¼Œç¬¬2è¡Œæ˜¯ååŠå¥ï¼‰ã€‚
   - è¯·å°†**å®Œæ•´å¥å­çš„ç¿»è¯‘**æ”¾åœ¨**ç¬¬1è¡Œ**ã€‚
   - ç„¶åï¼Œ**å¿…é¡»**å°†**ç¬¬2è¡Œ**çš„ "ru", "en", "py" å…¨éƒ¨è®¾ä¸º**ç©ºå­—ç¬¦ä¸² ""**ã€‚
   - **ç»å¯¹ä¸è¦**æŠŠä¸‹ä¸€å¥çš„ç¿»è¯‘å¡«åˆ°è¿™ä¸ªç©ºä½é‡Œï¼

### ç¤ºä¾‹å­¦ä¹ ï¼ˆè¯·ä¸¥æ ¼æ¨¡ä»¿ï¼‰ï¼š
**è¾“å…¥**ï¼š
[{"id":0,"cn":"å› ä¸ºæˆ‘å­¦å®Œå“²å­¦"},{"id":1,"cn":"è·Ÿå¤§å®¶å­¦ä»»ä½•ä¸“ä¸šä¸€æ ·"},{"id":2,"cn":"è¿˜æ˜¯è¦å‡ºæ¥æ‰¾å·¥ä½œçš„"}]

**æ­£ç¡®çš„è¾“å‡º**ï¼š
[
  {"ru": "ĞŸĞ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ„Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„Ğ¸Ğ¸, ĞºĞ°Ğº Ğ¸ Ñƒ Ğ²ÑĞµÑ…...", "en": "...", "py": "..."}, 
  {"ru": "", "en": "", "py": ""},  <-- âœ… å¿…é¡»ç•™ç©ºï¼
  {"ru": "Ğ’ĞµĞ´ÑŒ Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ...", "en": "...", "py": "..."}
]

### å¾…ç¿»è¯‘æ•°æ®ï¼š
${JSON.stringify(simpleSubs)}
            `;
                const content = await callDeepSeek(prompt);
                const aiData = JSON.parse(content);
                parsedSentences.forEach((s, i) => { if(aiData[i]){ s.en = aiData[i].en; s.ru = aiData[i].ru; s.py = aiData[i].py; }});
                alert("ç¿»è¯‘æˆåŠŸï¼");
            } catch(e) { alert("AI é”™è¯¯: " + e.message); }
            btn.innerText = "AI å…¨æ–‡ç¿»è¯‘"; btn.disabled = false;
        }

        // 2. è¯å¡è¡¥å…¨ (ç®€å•çš„)
        async function aiAutoFill() { 
             const btn = document.getElementById('aiBtn'); btn.innerHTML = 'â³...'; btn.disabled = true;
             try {
                const words = flashcards.map(f => f.cn);
                const prompt = `è¯æ±‡åˆ—è¡¨ï¼š[${words.join(', ')}]ã€‚è¿”å›JSONæ•°ç»„å«ï¼šcn, py, ru, en, exã€‚`;
                const content = await callDeepSeek(prompt);
                JSON.parse(content).forEach(item => {
                    const idx = flashcards.findIndex(f => f.cn === item.cn);
                    if (idx !== -1) { flashcards[idx].py = item.py; flashcards[idx].ru = item.ru; flashcards[idx].en = item.en; flashcards[idx].ex = item.ex; }
                });
                renderFlashcards(); alert("è¡¥å…¨æˆåŠŸ");
            } catch (e) { alert("AI å‡ºé”™ï¼š" + e.message); } 
            btn.innerHTML = '<i class="fas fa-magic"></i> AI è¡¥å…¨'; btn.disabled = false;
        }

        // ğŸ”´ğŸ”´ğŸ”´ 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ‰¹é‡ç”Ÿæˆé¢„åˆ¶è¯å…¸ (æœ€é‡è¦ï¼) ğŸ”´ğŸ”´ğŸ”´
        // === ğŸŸ¢ æ ¸å¿ƒå‡çº§ï¼šç”Ÿæˆå…¨æ–‡æœ¬è¯å…¸ ===
        
        // 1. è¾…åŠ©å‡½æ•°ï¼šä»å­—å¹•æå–æ‰€æœ‰ä¸é‡å¤çš„ä¸­æ–‡è¯
        function getAllWordsFromScript() {
            if (parsedSentences.length === 0) return [];
            
            // ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„åˆ†è¯å™¨
            const segmenter = new Intl.Segmenter('zh-CN', { granularity: 'word' });
            const allText = parsedSentences.map(s => s.cn).join(' ');
            const segments = segmenter.segment(allText);
            
            const uniqueWords = new Set();
            
            for (const seg of segments) {
                // è¿‡æ»¤æ‰æ ‡ç‚¹ç¬¦å·ã€ç©ºæ ¼ã€éä¸­æ–‡
                if (seg.isWordLike && /^[\u4e00-\u9fa5]+$/.test(seg.segment)) {
                    uniqueWords.add(seg.segment);
                }
            }
            
            // æŠŠåŸæœ¬çš„æ‰‹åŠ¨è¯å¡ä¹ŸåŠ è¿›å»ï¼Œç¡®ä¿ä¸æ¼
            flashcards.forEach(f => uniqueWords.add(f.cn));
            
            return Array.from(uniqueWords);
        }

        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šAI æ‰¹é‡ç”Ÿæˆè¯å…¸ (é˜²å¡æ­» + åŒè¯­) ===
        async function aiBatchDict() {
            // 1. è·å–æ‰€æœ‰è¯
            const allWords = getAllWordsFromScript();
            if(allWords.length === 0) return alert("è¯·å…ˆè§£æå­—å¹•ï¼");
            
            const btn = document.getElementById('dictBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;

            if(!confirm(`æ£€æµ‹åˆ° ${allWords.length} ä¸ªç”Ÿè¯ã€‚\nAI å°†é€ä¸ªç”Ÿæˆä¸­/è‹±/ä¿„è¯¦è§£ã€‚\nç¡®å®šè¦å¼€å§‹å—ï¼Ÿ`)) {
                btn.disabled = false;
                return;
            }

            let successCount = 0;
            let failCount = 0;

            // ğŸŸ¢ æ”¹ä¸ºé€ä¸ªç”Ÿæˆï¼Œè™½ç„¶æ…¢ä¸€ç‚¹ç‚¹ï¼Œä½†æ˜¯æœ€ç¨³å®šï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªæŠ¥é”™å¯¼è‡´å…¨å´©
            for (let i = 0; i < allWords.length; i++) {
                const word = allWords[i];
                
                // è·³è¿‡å·²å­˜åœ¨çš„
                if(preCookedDictionary[word]) { successCount++; continue; }

                btn.innerHTML = `â³ è¿›åº¦: ${i+1}/${allWords.length} (æ­£åœ¨å¤„ç†: ${word})`;

                // ğŸŸ¢ åŒè¯­ Prompt
                const prompt = `è§£é‡Šä¸­æ–‡è¯æ±‡ï¼šâ€œ${word}â€ã€‚
                è¯·è¿”å›çº¯ JSON æ ¼å¼ï¼Œä¸è¦ Markdownã€‚
                æ ¼å¼è¦æ±‚ï¼š
                {
                    "py": "æ‹¼éŸ³", 
                    "mean": "ä¿„è¯­å«ä¹‰ (è¯æ€§)", 
                    "mean_en": "è‹±è¯­å«ä¹‰", 
                    "phrases": ["å¸¸ç”¨è¯ç»„1", "è¯ç»„2"], 
                    "ex": "ä¸­æ–‡ä¾‹å¥\\nä¿„è¯­ç¿»è¯‘\\nEnglish translation"
                }`;

                try {
                    const content = await callDeepSeek(prompt);
                    // å°è¯•è§£æ JSONï¼Œå¦‚æœ AI è¿”å›äº†å¤šä½™çš„ ```jsonï¼Œè¿™é‡Œä¼šè‡ªåŠ¨å¤„ç†
                    const cleanContent = content.replace(/```json|```/g, '').trim();
                    const result = JSON.parse(cleanContent);
                    
                    // å­˜å…¥å¤§è¯å…¸
                    preCookedDictionary[word] = result;
                    successCount++;
                    
                } catch (e) {
                    console.error(`âŒ ç”Ÿæˆ ${word} å¤±è´¥:`, e);
                    failCount++;
                    // é‡åˆ°é”™è¯¯ä¸åœæ­¢ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªï¼
                }
                
                // ä¼‘æ¯ 0.5 ç§’ï¼Œé˜²æ­¢ API é€Ÿç‡é™åˆ¶
                await new Promise(r => setTimeout(r, 500));
            }

            // ç»“æŸ
            renderFlashcards(); 
            btn.innerHTML = originalText;
            btn.disabled = false;
            
            alert(`âœ… ç”Ÿæˆå®Œæ¯•ï¼\næˆåŠŸ: ${successCount}\nå¤±è´¥: ${failCount}\n\nè¯·ç‚¹å‡»â€œå¯¼å‡ºâ€ä¿å­˜æ•°æ®ã€‚`);
        }

        // === å¯¼å‡ºä¸ä¸Šä¼  ===
        function getFullLessonData() {
            return {
                title: document.getElementById('lessonTitle').value,
                video: document.getElementById('videoFile').value,
                desc: document.getElementById('vDesc').value,
                author: document.getElementById('vAuthor').value,
                hsk: document.getElementById('vHSK').value,
                topic: document.getElementById('vTopic').value,
                duration: document.getElementById('vDuration').value,
                cover: document.getElementById('vCover').value,
                date: new Date().toLocaleDateString(),
                subs: parsedSentences.map(s => ({ start: s.start, end: s.end, cn: s.cn, py: s.py||"", ru: s.ru||"", en: s.en||"" })),
                script: parsedSentences.map(s => ({ start: s.start, end: s.end, cn: s.cn, target: s.target })),
                flashcards: flashcards,
                parallel: JSON.parse(document.getElementById('parallelJson').value || "[]"),
                // ğŸ”´ å…³é”®ï¼šæŠŠç”Ÿæˆçš„è¯å…¸ä¹Ÿæ‰“åŒ…è¿›å»ï¼
                dictionary: preCookedDictionary 
            };
        }

        async function uploadToCloud() {
            if (!dbClient) return alert("æœªè¿æ¥æ•°æ®åº“");
            const id = document.getElementById('lessonId').value;
            if(!id) return alert("å¿…é¡»å¡«å†™ ID");
            
            const btn = document.getElementById('uploadBtn'); btn.innerText = 'ä¸Šä¼ ä¸­...';
            const { error } = await dbClient.from('lessons').upsert({ id: id, data: getFullLessonData() });
            if (error) alert("å¤±è´¥: " + error.message); else alert("âœ… å¤‡ä»½æˆåŠŸï¼");
            btn.innerText = 'å¤‡ä»½åˆ° Supabase';
        }

        function downloadDataJs() {
            const id = document.getElementById('lessonId').value;
            if(!id) return alert("è¯·å…ˆå¡«å†™è¯¾ç¨‹ ID");
            
            const data = getFullLessonData();
            
            // æ£€æŸ¥æ˜¯å¦åŒ…å«è¯å…¸
            if(Object.keys(data.dictionary).length === 0) {
                if(!confirm("âš ï¸ è­¦å‘Šï¼šä½ è¿˜æ²¡æœ‰ç”Ÿæˆ AI è¯å…¸ï¼\nå­¦ç”Ÿç‚¹å‡»å•è¯å°†æ— æ³•æŸ¥è¯ã€‚\nç¡®å®šè¦ç»§ç»­å¯¼å‡ºå—ï¼Ÿ")) return;
            }

            const fileContent = `
if (!window.lessonDatabase) window.lessonDatabase = {};
window.lessonDatabase["${id}"] = ${JSON.stringify(data, null, 2)};
console.log("è¯¾ç¨‹ ${id} åŠ è½½å®Œæ¯• (å«ç¦»çº¿è¯å…¸)");
`;
            const blob = new Blob([fileContent], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `lesson_${id}.js`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function formatParallel() { document.getElementById('parallelJson').value = '[{"title":"æ ‡é¢˜","type":"xhs","url":"é“¾æ¥","tag":"å°çº¢ä¹¦"}]'; }
    </script>
</body>
</html>
