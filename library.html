<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê±âËØ≠ Vlog ËØæÂ†Ç | ‰∫ëÁ´ØÂõæ‰π¶È¶Ü</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="auth.js"></script>
    <script src="libraryData.js"></script>

    <style>
        :root {
            --primary: #6CAD9C; --primary-light: #e0f2fe;
            --red: #8B3A3A; --bg: #F9F7F2; --white: #FFFFFF;
            --yellow: #E5CC84; --text: #4A3B32; --gray: #9ca3af;
        }

        html { scroll-behavior: smooth; }
        body { margin: 0; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* --- ‰æßËæπÊ†è --- */
        .sidebar { width: 300px; background: var(--white); border-right: 1px solid rgba(139, 58, 58, 0.1); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 25px; border-bottom: 3px solid var(--yellow); }
        .logo { font-size: 22px; font-weight: 800; color: var(--red); display: flex; align-items: center; gap: 10px; cursor: pointer; text-decoration: none; }
        
        .nav-section { flex: 1; overflow-y: auto; padding: 15px; }
        .nav-cat-title { font-size: 11px; font-weight: 800; color: var(--red); background: rgba(139, 58, 58, 0.05); padding: 8px 12px; border-radius: 6px; margin: 15px 0 8px 0; text-transform: uppercase; }
        .series-nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; border-radius: 8px; cursor: pointer; color: var(--text); font-size: 13px; margin-bottom: 2px; transition: 0.2s; margin-left: 10px; }
        .series-nav-item:hover { background: var(--primary-light); color: var(--primary); }
        .series-nav-item.active { background: var(--primary); color: white; font-weight: bold; }
        .back-btn { margin: 15px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; color: #666; cursor: pointer; text-decoration: none; font-size: 13px; }

        /* --- ‰∏ªÂå∫Âüü --- */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 25px 40px; background: var(--bg); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .page-title { font-size: 26px; font-weight: 800; color: var(--red); margin: 0; flex-shrink: 0; }
        
        .top-tools { display: flex; align-items: center; gap: 15px; flex: 1; justify-content: flex-end; }
        .search-box { position: relative; width: 100%; max-width: 300px; }
        .search-input { width: 100%; padding: 10px 15px 10px 40px; border-radius: 25px; border: 1px solid #ddd; outline: none; background: white; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 12px; color: #999; }
        
        .lang-switch { cursor: pointer; padding: 6px 12px; border-radius: 15px; background: white; border: 1px solid #ddd; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; flex-shrink: 0; }

        /* --- ÊªöÂä®‰π¶Êû∂ --- */
        .content-scroll { flex: 1; overflow-y: auto; padding: 0 40px 60px 40px; }
        .series-section { margin-top: 40px; scroll-margin-top: 30px; }
        .series-header { display: flex; align-items: baseline; gap: 10px; margin-bottom: 20px; border-left: 6px solid var(--red); padding-left: 15px; }
        .series-header h2 { margin: 0; font-size: 22px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 30px; }

        /* --- ‰π¶Á±çÂç°Áâá --- */
        .book-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 18px; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.3); display: flex; flex-direction: column; transition: 0.3s; }
        .book-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(139, 58, 58, 0.1); }
        .book-cover-wrap { width: 100%; aspect-ratio: 1 / 1.41; border-radius: 10px; overflow: hidden; position: relative; box-shadow: 3px 3px 10px rgba(0,0,0,0.1); }
        .book-cover { width: 100%; height: 100%; object-fit: cover; }
        .level-badge { position: absolute; top: 8px; right: 8px; background: var(--primary); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        .book-title { font-size: 14px; font-weight: bold; margin: 12px 0 8px 0; min-height: 40px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .download-btn { background: var(--red); color: white; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; }

        @media (max-width: 768px) { 
            .sidebar { display: none; } 
            header { padding: 15px; gap: 10px; }
            .page-title { display: none; } /* ÊâãÊú∫Á´ØÈöêËóèÊ†áÈ¢òÁúÅÁ©∫Èó¥ */
            .book-grid { grid-template-columns: 1fr 1fr; gap: 12px; } 
            .content-scroll { padding: 0 15px; } 
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <a href="learning.html" class="logo"><i class="fas fa-book-reader"></i> Ê±âËØ≠ Vlog</a>
        </div>
        <a href="learning.html" class="back-btn"><i class="fas fa-arrow-left"></i> <span data-i18n="back_to_course">ËøîÂõû</span></a>
        <div class="nav-section" id="sidebarNav"></div>
    </div>

    <div class="main-content">
        <header>
            <h1 class="page-title" data-i18n="page_title">‰∫ëÁ´ØÂõæ‰π¶È¶Ü</h1>
            <div class="top-tools">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchBar" oninput="renderLibrary()">
                </div>
                <div class="lang-switch" onclick="toggleLang()">
                    <i class="fas fa-globe"></i> <span id="langLabel">RU</span>
                </div>
            </div>
        </header>
        <div class="content-scroll" id="libraryBody"></div>
    </div>

    <script>
        // --- 1. Â§öËØ≠Ë®ÄÂ≠óÂÖ∏ ---
        const uiDict = {
            ru: { page_title: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞", back_to_course: "–ù–∞–∑–∞–¥", cat_exam: "–≠–ö–ó–ê–ú–ï–ù–´", cat_classic: "–ö–õ–ê–°–°–ò–ö–ê", cat_oral: "–†–ê–ó–ì–û–í–û–†", cat_kids: "–î–ï–¢–Ø–ú", cat_other: "–î–†–£–ì–û–ï", download: "–°–∫–∞—á–∞—Ç—å PDF", search_place: "–ü–æ–∏—Å–∫...", count_unit: "–∫–Ω–∏–≥" },
            en: { page_title: "Library", back_to_course: "Back", cat_exam: "EXAMS", cat_classic: "CLASSIC", cat_oral: "ORAL", cat_kids: "KIDS", cat_other: "OTHERS", download: "Download PDF", search_place: "Search...", count_unit: "books" },
            cn: { page_title: "‰∫ëÁ´ØÂõæ‰π¶È¶Ü", back_to_course: "ËøîÂõûËßÜÈ¢ëËØæÁ®ã", cat_exam: "ËÄÉËØï/ÊïôÂ∏àÁ≥ªÂàó", cat_classic: "ÁªèÂÖ∏ÁªºÂêàÁ≥ªÂàó", cat_oral: "Âè£ËØ≠/ÂïÜÂä°‰∏ìÈ°π", cat_kids: "Â∞ëÂÑø/ÈùíÂ∞ëÂπ¥ÊïôÊùê", cat_other: "ÂÖ∂‰ªñËµÑÊ∫ê", download: "‰∏ãËΩΩ PDF", search_place: "ÊêúÁ¥¢‰π¶Âêç...", count_unit: "Êú¨" }
        };

        // --- 2. ÂàÜÁ±ªÂØπÂ∫îË°® (‰∏•Ê†ºÂåπÈÖçÊÇ®ÁöÑ libraryData.js ‰∏≠ÁöÑ series ÂêçÂ≠ó) ---
        const CATEGORY_MAP = {
            exam: [
                "HSK 3.0 Ê†áÂáÜÊïôÁ®ãÁ≥ªÂàó", 
                "HSK 2.0 Ê†áÂáÜÊïôÁ®ãÁ≥ªÂàó", 
                "YCTÁ≥ªÂàó", 
                "ÂõΩÈôÖÊ±âËØ≠ÊïôÂ∏àÊâãÂÜå"
            ],
            classic: [
                "ÂèëÂ±ïÊ±âËØ≠ Developing Chinese", 
                "ÂçöÈõÖÊ±âËØ≠ Boya Chinese(en/ru)", 
                "Ëµ∞ÈÅç‰∏≠ÂõΩ Discover China", 
                "ÊàêÂäü‰πãË∑Ø Road to Success", 
                "‰ΩìÈ™åÊ±âËØ≠ Experience Chinese", 
                "Ê±âËØ≠ÊïôÁ®ã HANYU JIAOCHENG(en/ru)", 
                "Êñ∞ÂÆûÁî®Ê±âËØ≠ËØæÊú¨ New Practical Chinese TextbookÔºàen/ru)", 
                "Ê±âËØ≠Êñ∞Ëµ∑ÁÇπ", 
                "Ê±âËØ≠Êñ∞ÁõÆÊ†á–ù–æ–≤—ã–π –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã –∫–∏—Ç–∞–π—Å–∫–æ–≥–æ —è–∑—ã–∫–∞"
            ],
            oral: [
                "Êñ∞ÁõÆÊ†áÊ±âËØ≠Âè£ËØ≠ New Target CHinese Spoken Language", 
                "Êñ∞Êó∂‰ª£Ê±âËØ≠Âè£ËØ≠ New era Spoken Chinese Series", 
                "ÂïÜÂä°Ê±âËØ≠ Business Chinese"
            ],
            kids: [
                "ËΩªÊùæÂ≠¶Ê±âËØ≠", 
                "Ë∑üÊàëÂ≠¶Ê±âËØ≠", 
                "Áà±Ê±âËØ≠ i Chinese", 
                "Âø´‰πêÊ±âËØ≠"
            ],
            other: [
                "ÂÖ∂‰ªñËµÑÊñô"
            ]
        };

        let currentLang = 'ru';

        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en';
            else if (currentLang === 'en') currentLang = 'cn';
            else currentLang = 'ru';
            updateUI();
        }

        function updateUI() {
            document.getElementById('langLabel').innerText = currentLang.toUpperCase();
            document.getElementById('searchBar').placeholder = uiDict[currentLang].search_place;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                el.innerText = uiDict[currentLang][el.getAttribute('data-i18n')];
            });
            renderLibrary();
        }

        function renderLibrary() {
            const container = document.getElementById('libraryBody');
            const nav = document.getElementById('sidebarNav');
            const query = document.getElementById('searchBar').value.toLowerCase();
            
            container.innerHTML = '';
            nav.innerHTML = '';

            // 1. Êï∞ÊçÆÂàÜÁªÑ
            const groups = {};
            libraryData.forEach(book => {
                const bookTitle = book.title || "";
                const seriesTitle = book.series || "";
                if (bookTitle.toLowerCase().includes(query) || seriesTitle.toLowerCase().includes(query)) {
                    if (!groups[seriesTitle]) groups[seriesTitle] = [];
                    groups[seriesTitle].push(book);
                }
            });

            // 2. Êò†Â∞ÑÂ§ßÁ±ªÂêç
            const catKeys = { exam: 'cat_exam', classic: 'cat_classic', oral: 'cat_oral', kids: 'cat_kids', other: 'cat_other' };

            // 3. ÊåâÂ§ßÁ±ªÈÄªËæëÊ∏≤Êüì
            for (const catID in CATEGORY_MAP) {
                const subSeries = CATEGORY_MAP[catID];
                const activeSeries = subSeries.filter(s => groups[s]);

                if (activeSeries.length > 0) {
                    // Ê∏≤Êüì‰æßËæπÊ†èÂàÜÁ±ªÊ†áÈ¢ò
                    const catTitle = document.createElement('div');
                    catTitle.className = 'nav-cat-title';
                    catTitle.innerText = uiDict[currentLang][catKeys[catID]];
                    nav.appendChild(catTitle);

                    activeSeries.forEach(sName => {
                        const safeId = "s-" + sName.replace(/[^\w\u4e00-\u9fa5]/g, '-');
                        
                        // ‰æßËæπÊ†èÁ¥¢Âºï
                        const navItem = document.createElement('div');
                        navItem.className = 'series-nav-item';
                        navItem.innerHTML = `<i class="fas fa-book"></i> ${sName}`;
                        navItem.onclick = () => {
                            document.getElementById(safeId).scrollIntoView({ behavior: 'smooth' });
                            document.querySelectorAll('.series-nav-item').forEach(el => el.classList.remove('active'));
                            navItem.classList.add('active');
                        };
                        nav.appendChild(navItem);

                        // ‰π¶Êû∂Âå∫Âüü
                        const section = document.createElement('div');
                        section.className = 'series-section';
                        section.id = safeId;
                        section.innerHTML = `
                            <div class="series-header">
                                <h2>${sName}</h2>
                                <span style="color:#999;font-size:14px;">(${groups[sName].length} ${uiDict[currentLang].count_unit})</span>
                            </div>
                            <div class="book-grid">
                                ${groups[sName].map(b => `
                                    <div class="book-card">
                                        <div class="book-cover-wrap">
                                            <img src="${b.cover}" class="book-cover" loading="lazy">
                                            <div class="level-badge">${b.level}</div>
                                        </div>
                                        <div class="book-title">${b.title}</div>
                                        <button class="download-btn" onclick="handleDownload('${b.id}')">
                                            <i class="fas fa-download"></i> ${uiDict[currentLang].download}
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        container.appendChild(section);
                    });
                }
            }

            if (Object.keys(groups).length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:100px; color:#999;">No books found.</div>`;
            }
        }

        async function handleDownload(id) {
            const book = libraryData.find(b => b.id === id);
            const userTags = JSON.parse(localStorage.getItem('my_access_tags') || '[]');
            const hasAccess = book.tags.some(tag => userTags.includes(tag));

            if (!hasAccess) {
                const msg = currentLang === 'ru' ? "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞. –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ?" : "üîí ËØ•ÊïôÊùêÈúÄË¥≠‰π∞ÊùÉÈôê„ÄÇÊòØÂê¶ÂâçÂæÄ„Äê‰ª∑Ê†ºÈ°µ„ÄëÔºü";
                if(confirm(msg)) window.location.href = 'price.html';
                return;
            }
            alert(`‚úÖ ${book.title} OK!`);
        }

        document.addEventListener('DOMContentLoaded', updateUI);
    </script>
</body>
</html>