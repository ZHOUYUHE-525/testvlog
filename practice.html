<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­ Vlog è¯¾å ‚ | æ²‰æµ¸ç»ƒä¹ </title>
    
    <!-- 1. å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 2. ğŸ”´ åŠ ä¸Šè¿™è¡Œï¼ -->
    <script src="auth.js"></script>
    
    <!-- 3. å¼•å…¥è¯¾ç¨‹æ•°æ® -->
    <script src="lesson_001.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #6CAD9C; --primary-light: #e0f2fe; --red: #8B3A3A; --bg: #F9F7F2; --white: #FFFFFF; --yellow: #E5CC84; --text: #4A3B32; --gray: #9ca3af; }
        body { margin: 0; font-family: "PingFang SC", sans-serif; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; display: flex; flex-direction: column; overflow: hidden; }
        .top-fixed-area { height: 38vh; width: 100%; background: #000; flex-shrink: 0; display: flex; flex-direction: column; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .video-container { flex: 1; width: 100%; position: relative; background: black; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; outline: none; }
        .nav-bar { height: 50px; background: var(--white); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .back-btn { cursor: pointer; color: var(--gray); font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 5px; } .back-btn:hover { color: var(--primary); }
        .lang-switch { cursor: pointer; padding: 4px 10px; border-radius: 15px; background: #eee; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .tabs-wrapper { background: var(--bg); padding: 15px 20px 5px 20px; flex-shrink: 0; }
        .mode-tabs { display: flex; gap: 10px; background: #e5e7eb; padding: 5px; border-radius: 12px; overflow-x: auto; }
        .tab { flex: 1; min-width: 80px; text-align: center; padding: 10px 0; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 800; color: #666; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap;}
        .tab.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .scroll-content { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .content-inner { max-width: 700px; margin: 0 auto; padding-bottom: 60px; }
        .module { display: none; animation: fadeIn 0.3s ease; } .module.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* è¯å¡ */
        .flashcard-stage { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .card-scene { perspective: 1000px; width: 100%; max-width: 380px; height: 320px; cursor: pointer; }
        .card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .card.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; background: var(--white); border: 2px solid var(--primary); padding: 20px; box-sizing: border-box; }
        .card-back { transform: rotateY(180deg); background: #fffdf5; border-color: var(--yellow); }
        .card-front .hanzi { font-size: 42px; font-weight: bold; color: var(--red); margin-bottom: 20px; }
        .audio-btn { width: 44px; height: 44px; border-radius: 50%; background: var(--primary-light); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 20px; transition: transform 0.2s; }
        .back-py { font-family: "Courier New"; font-size: 18px; color: #A77046; font-weight: bold; margin-bottom: 5px; }
        .back-mean { font-size: 16px; color: #333; margin-bottom: 15px; font-weight: bold; text-align: center; line-height: 1.5; }
        .video-ctx-box { background: rgba(108, 173, 156, 0.1); padding: 8px 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; text-align: center; }
        .video-sent { font-size: 13px; color: #333; margin-bottom: 5px; font-weight: bold; }
        .video-jump { display: inline-flex; align-items: center; gap: 5px; font-size: 12px; background: var(--primary); color: white; padding: 4px 12px; border-radius: 15px; cursor: pointer; }
        .example-box { font-size: 13px; color: #666; text-align: center; border-top: 1px solid #eee; padding-top: 8px; width: 100%; line-height: 1.4; }
        .card-controls { display: flex; gap: 15px; margin-top: 10px; }
        .ctrl-btn { padding: 8px 24px; border-radius: 30px; border: 1px solid #ddd; background: white; cursor: pointer; color: var(--text); font-weight: bold; font-size: 14px;}
        .add-btn { background: var(--yellow); border: none; color: #4a3b32; }
        /* åˆ—è¡¨ä¸æ‹“å±• */
        .list-container { display: flex; flex-direction: column; gap: 12px; }
        .list-item { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border-left: 4px solid transparent; transition: all 0.2s; }
        .list-item:hover { border-left-color: var(--yellow); transform: translateX(2px); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .play-icon { width: 28px; height: 28px; border-radius: 50%; border: 1px solid #eee; color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 12px; }
        .text-content { font-size: 16px; line-height: 1.6; color: #333; }
        .cloze-input { border: none; border-bottom: 2px solid #9ca3af; background: #e5e7eb; width: 80px; text-align: center; font-size: 16px; color: var(--text); outline: none; border-radius: 4px; padding: 4px 6px; margin: 0 4px; font-weight: bold; }
        .cloze-input.correct { color: #10b981; border-bottom-color: #10b981; background: #ecfdf5; }
        .cloze-input.wrong { color: #ef4444; border-bottom-color: #ef4444; background: #fef2f2; }
        .shadow-actions { display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #f9f9f9; padding-top: 10px; justify-content: center;}
        .circle-action { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .act-listen { color: var(--primary); } .act-rec { color: var(--red); border-color: #fee2e2; } 
        /* === ğŸ”´ å½•éŸ³æ—¶çš„å£°æ³¢åŠ¨ç”» === */
.act-rec.recording {
    background: #ef4444 !important;
    color: white !important;
    border-color: #ef4444 !important;
    /* æ ¸å¿ƒï¼šå¤šé‡é˜´å½±æ‰©æ•£åŠ¨ç”» */
    animation: recording-wave 1.5s infinite;
}

@keyframes recording-wave {
    0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        transform: scale(1);
    }
    70% {
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); /* æ‰©æ•£å‡º15pxçš„å…‰åœˆ */
        transform: scale(1.1); /* æŒ‰é’®ç¨å¾®å˜å¤§ */
    }
    100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        transform: scale(1);
    }
}

/* å½•éŸ³ç»“æœæ’­æ”¾å™¨å®¹å™¨ */
.player-box {
    margin-top: 10px;
    width: 100%;
    display: none; /* é»˜è®¤éšè—ï¼Œå½•å®Œæ˜¾ç¤º */
    animation: fadeIn 0.5s;
}
/* ç¾åŒ–åŸç”Ÿæ’­æ”¾å™¨ */
audio {
    width: 100%;
    height: 36px;
    border-radius: 18px;
    background: #f3f4f6;
}
        .resource-card { display: flex; gap: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; border: 1px solid #eee; cursor: pointer; transition: all 0.2s; align-items: center; }
        .resource-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .res-icon { width: 50px; height: 50px; border-radius: 10px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .res-info { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .res-title { font-weight: bold; color: var(--text); font-size: 15px; }
        .res-tag { font-size: 12px; color: #999; display: flex; align-items: center; gap: 5px; }
        .icon-xhs { color: #ff2442; background: #ffe6eb; } .icon-bili { color: #23ade5; background: #e0f2fe; } .icon-article { color: #f59e0b; background: #fef3c7; }
        /* === ğŸ“± æ‰‹æœºç«¯é€‚é… (æŠŠè¿™æ®µåŠ åˆ° style æœ€ä¸‹é¢) === */
        @media (max-width: 768px) {
            /* 1. å¸ƒå±€å˜ç«–æ’ */
            body { flex-direction: column; height: auto; overflow-y: auto; }
            
            /* 2. ä¾§è¾¹æ è—èµ·æ¥ (å˜æˆåº•éƒ¨å¯¼èˆªæˆ–æŠ˜å èœå•) */
            .sidebar { 
                width: 100%; height: auto; 
                position: relative; 
                border-right: none; border-bottom: 1px solid #eee;
                display: none; /* æš‚æ—¶éšè—ä¾§è¾¹æ ï¼Œæˆ–è€…æ”¹æˆç‚¹å‡»å±•å¼€ */
            }
            /* å¦‚æœæƒ³æ˜¾ç¤ºä¾§è¾¹æ ï¼Œå¯ä»¥åšä¸€ä¸ªæ±‰å ¡èœå•æŒ‰é’®æ¥æ§åˆ¶ */

            /* 3. ä¸»å†…å®¹å¡«æ»¡ */
            .main-container { flex-direction: column; padding: 10px; }
            .video-section { width: 100%; max-width: 100%; margin-bottom: 20px; }
            .subtitle-section { width: 100%; height: 300px; } /* å­—å¹•åŒºå®šé«˜ */

            /* 4. é¦–é¡µå¡ç‰‡ */
            .grid { grid-template-columns: 1fr; } /* å¡ç‰‡ä¸€åˆ—æ’ */
            
            /* 5. æŸ¥è¯å¼¹çª— */
            .dict-modal { width: 90%; top: 20%; transform: translate(-50%, 0); }
        }
        /* === ğŸ¨ è‡ªå®šä¹‰å½•éŸ³æ’­æ”¾å™¨æ ·å¼ === */
.custom-player {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f0f4f8; /* æµ…ç°èƒŒæ™¯ */
    padding: 8px 15px;
    border-radius: 30px; /* èƒ¶å›Šå½¢çŠ¶ */
    margin-top: 10px;
    border: 1px solid #e5e7eb;
    animation: fadeIn 0.5s;
    width: 100%;
    box-sizing: border-box;
}

/* æ’­æ”¾æŒ‰é’® */
.custom-play-btn {
    width: 32px;
    height: 32px;
    background: var(--primary); /* ä½¿ç”¨ä½ çš„ä¸»é¢˜è‰² */
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
    transition: transform 0.1s;
}
.custom-play-btn:active { transform: scale(0.9); }

/* è¿›åº¦æ¡å®¹å™¨ */
.custom-progress-box {
    flex: 1;
    height: 6px;
    background: #d1d5db;
    border-radius: 3px;
    position: relative;
    cursor: pointer;
    overflow: hidden; /* å…³é”®ï¼šæŠŠè¶…å‡ºçš„éƒ¨åˆ†åˆ‡æ‰ */
}

/* è¿›åº¦æ¡å¡«å…… */
.custom-progress-bar {
    height: 100%;
    background: var(--yellow); /* è¿›åº¦æ¡é¢œè‰² */
    width: 0%; /* åˆå§‹å®½åº¦ */
    border-radius: 3px;
    transition: width 0.1s linear;
}

/* æ—¶é—´æ–‡å­— */
.custom-time {
    font-size: 12px;
    color: #666;
    font-family: monospace;
    font-weight: bold;
    min-width: 35px;
}
    </style>
</head>
<body>

    <div class="top-fixed-area">
        <div class="video-container">
            <video id="practiceVideo" controls><source src="" type="video/mp4"></video>
        </div>
        <div class="nav-bar">
            <div class="back-btn" onclick="goBack()"><i class="fas fa-chevron-left"></i> <span data-i18n="back">è¿”å›</span></div>
            <div class="lang-switch" onclick="toggleLang()">
                <i class="fas fa-globe"></i> <span id="langLabel">RU</span>
            </div>
        </div>
    </div>

    <div class="tabs-wrapper">
        <div class="mode-tabs">
            <div class="tab active" onclick="switchMode('flashcard')"><i class="fas fa-clone"></i> <span data-i18n="tab_card">é‡ç‚¹è¯å¡</span></div>
            <div class="tab" onclick="switchMode('cloze')"><i class="fas fa-pen"></i> <span data-i18n="tab_cloze">å¬éŸ³å¡«ç©º</span></div>
            <div class="tab" onclick="switchMode('shadow')"><i class="fas fa-microphone"></i> <span data-i18n="tab_speak">å…¨æ–‡è·Ÿè¯»</span></div>
            <div class="tab" onclick="switchMode('parallel')"><i class="fas fa-link"></i> <span data-i18n="tab_extend">æ‹“å±•</span></div>
        </div>
    </div>

    <div class="scroll-content">
        <div class="content-inner">
            <!-- A: è¯å¡ -->
            <div id="flashcard" class="module active">
                <div class="flashcard-stage">
                    <div class="card-scene" onclick="flipCard()">
                        <div class="card" id="cardEl">
                            <div class="card-face card-front">
                                <div class="hanzi" id="fc-cn">...</div>
                                <div class="audio-btn" onclick="playWordAudio(event)"><i class="fas fa-volume-up"></i></div>
                                <div style="font-size:12px; color:#999; margin-top:15px;" data-i18n="tip_flip">(ç‚¹å‡»å¡ç‰‡ç¿»é¢)</div>
                            </div>
                            <div class="card-face card-back">
                                <div class="back-py" id="fc-py">...</div>
                                <div class="back-mean" id="fc-mean">...</div>
                                <div class="video-ctx-box">
                                    <div class="video-sent" id="fc-video-sent">...</div>
                                    <div class="video-jump" onclick="jumpToVideoContext(event)"><i class="fas fa-play"></i> <span data-i18n="btn_play">æ’­æ”¾æ­¤å¥</span></div>
                                </div>
                                <div class="example-box" id="fc-ex">...</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-controls">
                        <button class="ctrl-btn" onclick="prevCard()"><i class="fas fa-arrow-left"></i></button>
                        <button class="ctrl-btn add-btn" onclick="addToLib()"><i class="fas fa-plus"></i> <span data-i18n="btn_add">åŠ å…¥ç”Ÿè¯åº“</span></button>
                        <button class="ctrl-btn" onclick="nextCard()"><i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
            </div>
            <!-- B: å¡«ç©º -->
            <div id="cloze" class="module">
                <div style="margin-bottom:15px; color:#666; font-size:13px; text-align:center;">
                    <i class="fas fa-info-circle"></i> <span data-i18n="tip_cloze">ç‚¹å‡»å°å–‡å­å¬åŸå¥ï¼Œå¡«å…¥ç¼ºå¤±çš„è¯ã€‚</span>
                </div>
                <div class="list-container" id="clozeList"></div>
            </div>
            <!-- C: è·Ÿè¯» -->
            <div id="shadow" class="module">
                <div style="margin-bottom:15px; color:#666; font-size:13px; text-align:center;">
                    <i class="fas fa-microphone"></i> <span data-i18n="tip_shadow">å¬åŸéŸ³(è“) -> æŒ‰ä½å½•(çº¢) -> å¬å›æ”¾(é»„)</span>
                </div>
                <div class="list-container" id="shadowList"></div>
            </div>
            <!-- D: å¹³è¡Œ -->
            <div id="parallel" class="module">
                <div style="margin-bottom:15px; color:#666; font-size:13px; text-align:center;">
                    <i class="fas fa-external-link-alt"></i> <span data-i18n="tip_extend">æ¨èé˜…è¯»ä¸ç›¸å…³è§†é¢‘</span>
                </div>
                <div id="parallelList"></div>
            </div>
        </div>
    </div>

    <!-- 1. å¼•å…¥æ•°æ®åº“ -->
    <!-- 1. å¼•å…¥ Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 2. å¼•å…¥äº‘ç«¯åŠ è½½å™¨ -->
    <script src="lesson_001.js"></script>
    <script src="lesson_002.js"></script> 

    <script>
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id') || "1";
        
        let lesson = null;
        if (window.lessonDatabase) lesson = window.lessonDatabase[id];
        else alert("Error: data.js not found!");

        const video = document.getElementById('practiceVideo');
        let currentCardIdx = 0;
        let currentLang = 'ru'; 

        const uiDict = {
            ru: { back: "ĞĞ°Ğ·Ğ°Ğ´", tab_card: "Ğ¡Ğ»Ğ¾Ğ²Ğ°", tab_cloze: "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ", tab_speak: "Ğ“Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ", tab_extend: "Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ", tip_flip: "(ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ĞµÑ€ĞµĞ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ)", btn_play: "Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ", btn_add: "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ", tip_cloze: "Ğ¡Ğ»ÑƒÑˆĞ°Ğ¹Ñ‚Ğµ Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¸.", tip_shadow: "Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ(Ğ¡Ğ¸Ğ½Ğ¸Ğ¹) -> Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ(ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹) -> ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°(Ğ–ĞµĞ»Ñ‚Ñ‹Ğ¹)", tip_extend: "Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğµ Ğ¼Ğ°Ñ‚ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹", check: "ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ" },
            en: { back: "Back", tab_card: "Words", tab_cloze: "Cloze", tab_speak: "Speaking", tab_extend: "Extend", tip_flip: "(Click to flip)", btn_play: "Play", btn_add: "Add to list", tip_cloze: "Listen and fill in the blanks.", tip_shadow: "Listen(Blue) -> Record(Red) -> Playback(Yellow)", tip_extend: "Recommended Reading", check: "Check" },
            cn: { back: "è¿”å›", tab_card: "é‡ç‚¹è¯å¡", tab_cloze: "å¬éŸ³å¡«ç©º", tab_speak: "å…¨æ–‡è·Ÿè¯»", tab_extend: "æ‹“å±•é˜…è¯»", tip_flip: "(ç‚¹å‡»å¡ç‰‡ç¿»é¢)", btn_play: "æ’­æ”¾æ­¤å¥", btn_add: "åŠ å…¥ç”Ÿè¯åº“", tip_cloze: "ç‚¹å‡»å°å–‡å­å¬åŸå¥ï¼Œå¡«å…¥ç¼ºå¤±çš„è¯ã€‚", tip_shadow: "å¬åŸéŸ³(è“) -> æŒ‰ä½å½•(çº¢) -> å¬å›æ”¾(é»„)", tip_extend: "æ¨èé˜…è¯»ä¸ç›¸å…³è§†é¢‘", check: "æ£€æŸ¥" }
        };

        if(lesson) {
            video.src = lesson.video;
            initFlashcards(); initCloze(); initShadow(); initParallel();
            updateLanguage();
        }

        function goBack() { location.href = 'index.html?id=' + id; }
        function switchMode(modeName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.getElementById(modeName).classList.add('active');
        }
        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en'; else if (currentLang === 'en') currentLang = 'cn'; else currentLang = 'ru';
            updateLanguage();
        }
        function updateLanguage() {
            let label = 'ğŸ‡·ğŸ‡º RU'; if (currentLang === 'en') label = 'ğŸ‡ºğŸ‡¸ EN'; if (currentLang === 'cn') label = 'ğŸ‡¨ğŸ‡³ CN';
            document.getElementById('langLabel').innerText = label;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (uiDict[currentLang][key]) el.innerText = uiDict[currentLang][key];
            });
            loadCardData(currentCardIdx); initCloze(); // åˆ·æ–°å†…å®¹
        }

        function initFlashcards() { loadCardData(0); }
        function loadCardData(idx) {
            const word = lesson.flashcards[idx];
            document.getElementById('fc-cn').innerText = word.cn;
            document.getElementById('fc-py').innerText = word.py;
            document.getElementById('fc-video-sent').innerText = word.video_ex || "";
            document.getElementById('fc-ex').innerHTML = "ğŸ“ " + (word.ex || "");
            
            const meanDiv = document.getElementById('fc-mean');
            if (currentLang === 'ru') meanDiv.innerHTML = word.ru;
            else if (currentLang === 'en') meanDiv.innerHTML = word.en || word.ru;
            else meanDiv.innerHTML = `<div style="font-size:14px; font-weight:normal; color:#666;">ğŸ‡·ğŸ‡º ${word.ru}<br>ğŸ‡ºğŸ‡¸ ${word.en || '-'}</div>`;
            document.getElementById('cardEl').classList.remove('flipped');
        }
        function flipCard() { document.getElementById('cardEl').classList.toggle('flipped'); }
        function nextCard() { currentCardIdx = (currentCardIdx + 1) % lesson.flashcards.length; loadCardData(currentCardIdx); }
        function prevCard() { currentCardIdx = (currentCardIdx - 1 + lesson.flashcards.length) % lesson.flashcards.length; loadCardData(currentCardIdx); }
        function playWordAudio(e) { e.stopPropagation(); const u = new SpeechSynthesisUtterance(lesson.flashcards[currentCardIdx].cn); u.lang = 'zh-CN'; speechSynthesis.speak(u); }
        function jumpToVideoContext(e) { e.stopPropagation(); video.currentTime = lesson.flashcards[currentCardIdx].time; video.play(); setTimeout(() => video.pause(), 4000); }
        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šçœŸå®åŠ å…¥ç”Ÿè¯æœ¬ (å¸¦åŠ¨ç”»åé¦ˆ) ===
        function addToLib() {
            // 1. è·å–å½“å‰å¡ç‰‡ä¸Šçš„å•è¯
            if (!lesson || !lesson.flashcards) return;
            const currentWordObj = lesson.flashcards[currentCardIdx];
            if (!currentWordObj) return;
            
            const word = currentWordObj.cn; // è·å–æ±‰å­—

            // 2. è¯»å–å¹¶æ›´æ–°åˆ—è¡¨ (List)
            let vocabList = JSON.parse(localStorage.getItem('my_vocab_list') || '[]');
            if (!vocabList.includes(word)) {
                vocabList.push(word);
                localStorage.setItem('my_vocab_list', JSON.stringify(vocabList));
            }

            // 3. åˆå§‹åŒ–å¤ä¹ è¿›åº¦ (Meta) - è¿™ä¸€æ­¥è®©å¤ä¹ é¡µèƒ½è¯†åˆ«å®ƒ
            let vocabMeta = JSON.parse(localStorage.getItem('my_vocab_meta') || '{}');
            if (!vocabMeta[word]) {
                vocabMeta[word] = {
                    created: Date.now(),
                    nextReview: Date.now(), // ç«‹å³åŠ å…¥å¤ä¹ é˜Ÿåˆ—
                    level: 0,
                    note: ""
                };
                localStorage.setItem('my_vocab_meta', JSON.stringify(vocabMeta));
            }

            // 4. UI è§†è§‰åé¦ˆ (æŒ‰é’®å˜ç»¿ï¼Œæå‡ä½“éªŒ)
            const btn = document.querySelector('.add-btn');
            const originalHTML = btn.innerHTML; // è®°ä½åŸæ¥çš„æ–‡å­—
            
            btn.innerHTML = '<i class="fas fa-check"></i> å·²åŠ å…¥';
            btn.style.background = '#4ade80'; // å˜ç»¿è‰²
            btn.style.color = 'white';
            btn.disabled = true; // é˜²æ­¢é‡å¤ç‚¹å‡»

            // 1.5ç§’åæ¢å¤åŸæ ·
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.background = ''; // æ¢å¤ CSS é‡Œçš„é»˜è®¤é»„è‰²
                btn.style.color = '';
                btn.disabled = false;
            }, 1500);
        }

        function initCloze() {
            const list = document.getElementById('clozeList'); list.innerHTML = '';
            const btnText = uiDict[currentLang].check;
            lesson.script.forEach((sent, index) => {
                let html = sent.cn;
                if(sent.target) { html = sent.cn.replace(sent.target, `<input class="cloze-input" data-ans="${sent.target}">`); }
                const div = document.createElement('div'); div.className = 'list-item';
                div.innerHTML = `<div class="item-header"><span class="item-idx">#${index+1}</span><div class="play-icon" onclick="playSegment(${sent.start}, ${sent.end})"><i class="fas fa-volume-up"></i></div></div><div class="text-content">${html}</div>${sent.target ? `<div style="text-align:right; margin-top:5px;"><button class="ctrl-btn" style="padding:4px 12px; font-size:12px; border:1px solid #ddd; background:white; border-radius:10px; cursor:pointer;" onclick="checkOne(this)">${btnText}</button></div>` : ''}`;
                list.appendChild(div);
            });
        }
        function checkOne(btn) {
            const container = btn.parentElement.parentElement; const input = container.querySelector('input'); const ans = input.getAttribute('data-ans');
            if (input.value.trim() === ans) { input.classList.add('correct'); input.classList.remove('wrong'); } else { input.classList.add('wrong'); }
        }

        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šè·Ÿè¯»åˆ—è¡¨ç”Ÿæˆï¼ˆé¢„ç•™æ’­æ”¾å™¨ä½ç½®ï¼‰ ===
        function initShadow() {
            const list = document.getElementById('shadowList'); 
            list.innerHTML = '';
            
            lesson.script.forEach((sent, index) => {
                const div = document.createElement('div'); 
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="text-content" style="font-weight:bold; margin-bottom:5px;">
                        ${sent.cn}
                    </div>
                    
                    <div class="shadow-actions">
                        <!-- å¬åŸéŸ³ -->
                        <div class="circle-action act-listen" onclick="playSegment(${sent.start}, ${sent.end})">
                            <i class="fas fa-volume-up"></i>
                        </div>
                        
                        <!-- å½•éŸ³æŒ‰é’® (æŒ‰ä½è¯´è¯) -->
                        <div class="circle-action act-rec" 
                             onmousedown="startRec(this, ${index})" 
                             onmouseup="stopRec(this, ${index})" 
                             ontouchstart="startRec(this, ${index})" 
                             ontouchend="stopRec(this, ${index})">
                            <i class="fas fa-microphone"></i>
                        </div>
                    </div>

                    <!-- ğŸ§ å½•éŸ³ç»“æœå±•ç¤ºåŒº (é»˜è®¤éšè—ï¼Œå½•å®Œåæ˜¾ç¤ºæ’­æ”¾å™¨) -->
                    <div id="player-box-${index}" class="player-box"></div>
                `;
                list.appendChild(div);
            });
        }

        // === ğŸŸ¢ æœ€ç»ˆä¿®æ­£ç‰ˆï¼šåŸç”Ÿé“¾æ¥ + ä¸å¼ºåˆ¶HTTPS ===
        function initParallel() {
            const list = document.getElementById('parallelList');
            
            if (!lesson.parallel || lesson.parallel.length === 0) { 
                list.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">æš‚æ— æ‹“å±•å†…å®¹</div>'; 
                return; 
            }
            
            list.innerHTML = ''; 

            lesson.parallel.forEach(item => {
                let iconClass = "icon-article";
                let iconName = "fa-file-alt";
                if (item.type === 'xhs') { iconClass = "icon-xhs"; iconName = "fa-hashtag"; }
                if (item.type === 'bili') { iconClass = "icon-bili"; iconName = "fa-play-circle"; }
                
                // --- ğŸ”— URL å¤„ç† ---
                let targetUrl = item.url ? item.url.trim() : "";
                
                // 1. å¦‚æœæ²¡æœ‰åè®®å¤´ï¼Œæ‰é»˜è®¤è¡¥ http (æ³¨æ„ï¼šä¸æ˜¯https)
                // è¿™æ ·æ—¢å…¼å®¹äº† http çš„çŸ­é“¾ï¼Œä¹Ÿå…¼å®¹äº† https çš„æ­£è§„é“¾
                if (targetUrl && !targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
                    targetUrl = 'http://' + targetUrl;
                }
                
                // 2. å¦‚æœé“¾æ¥æ— æ•ˆï¼Œè®©å®ƒå¤±æ•ˆ
                if (!targetUrl || targetUrl === "é“¾æ¥") {
                    targetUrl = "javascript:alert('âš ï¸ é“¾æ¥é…ç½®é”™è¯¯');";
                }
                // ----------------

                // ä½¿ç”¨ a æ ‡ç­¾ï¼Œç¡®ä¿èƒ½è·³
                const linkCard = document.createElement('a'); 
                linkCard.className = 'resource-card'; 
                linkCard.href = targetUrl; 
                linkCard.target = "_blank"; // å¿…å¼€æ–°çª—å£
                // æ ·å¼ä¿®æ­£ï¼šç¡®ä¿ a æ ‡ç­¾åƒä¸ªå—çº§å…ƒç´ 
                linkCard.style.textDecoration = "none"; 
                linkCard.style.color = "inherit"; 
                linkCard.style.display = "flex"; // å…³é”®ï¼ä¿æŒå¡ç‰‡å¸ƒå±€

                linkCard.innerHTML = `
                    <div class="res-icon ${iconClass}"><i class="fas ${iconName}"></i></div>
                    <div class="res-info">
                        <div class="res-title">${item.title}</div>
                        <div class="res-tag"><i class="fas fa-external-link-alt"></i> ${item.tag || 'æ‹“å±•èµ„æº'}</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color:#ddd;"></i>
                `;
                
                list.appendChild(linkCard);
            });
        }
        
        function playSegment(start, end) { video.currentTime = start; video.play(); setTimeout(() => video.pause(), (end - start) * 1000); }

        // === ğŸŸ¢ ç»ˆæç¾åŒ–ç‰ˆï¼šå½•éŸ³é€»è¾‘ + è‡ªå®šä¹‰æ’­æ”¾å™¨ ===
        
        let mediaRecorder = null;
        let audioChunks = [];
        let activeStream = null;

        // 1. å¼€å§‹å½•éŸ³
        async function startRec(btn, index) {
            if (btn.classList.contains('recording')) return;
            const video = document.getElementById('practiceVideo');
            if(video) video.pause();

            try {
                if (!activeStream) activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                let options = {};
                if (MediaRecorder.isTypeSupported('audio/webm')) options = { mimeType: 'audio/webm' };
                else if (MediaRecorder.isTypeSupported('audio/mp4')) options = { mimeType: 'audio/mp4' };

                mediaRecorder = new MediaRecorder(activeStream, options);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };

                // ğŸ›‘ æ ¸å¿ƒä¿®æ”¹ï¼šç”Ÿæˆç¾åŒ–çš„æ’­æ”¾å™¨
                mediaRecorder.onstop = () => {
                    const mimeType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // æ¸²æŸ“è‡ªå®šä¹‰æ’­æ”¾å™¨
                    renderCustomPlayer(index, audioUrl);
                };

                mediaRecorder.start();
                btn.classList.add('recording');
                if(window.getSelection) window.getSelection().removeAllRanges();

            } catch (err) {
                console.error(err);
                alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥");
                btn.classList.remove('recording');
            }
        }

        // 2. åœæ­¢å½•éŸ³
        function stopRec(btn, index) {
            if (btn.classList.contains('recording')) {
                btn.classList.remove('recording');
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
                }, 200);
            }
        }

        // === ğŸŸ¢ æ–°å¢ï¼šæ¸²æŸ“è‡ªå®šä¹‰æ’­æ”¾å™¨å‡½æ•° ===
        function renderCustomPlayer(index, audioUrl) {
            const playerBox = document.getElementById(`player-box-${index}`);
            if (!playerBox) return;

            // 1. ç”Ÿæˆ HTML ç»“æ„
            playerBox.innerHTML = `
                <div class="custom-player">
                    <div class="custom-play-btn" onclick="toggleCustomPlay(${index})">
                        <i class="fas fa-play" id="icon-${index}"></i>
                    </div>
                    <div class="custom-progress-box" onclick="seekAudio(event, ${index})">
                        <div class="custom-progress-bar" id="bar-${index}"></div>
                    </div>
                    <div class="custom-time" id="time-${index}">0:00</div>
                    <!-- éšè—çš„åŸç”Ÿ audio æ ‡ç­¾ï¼Œè´Ÿè´£å®é™…æ’­æ”¾ -->
                    <audio id="audio-${index}" src="${audioUrl}" style="display:none"></audio>
                </div>
            `;
            playerBox.style.display = 'block';

            // 2. ç»‘å®šæ’­æ”¾äº‹ä»¶ (æ›´æ–°è¿›åº¦æ¡)
            const audio = document.getElementById(`audio-${index}`);
            const bar = document.getElementById(`bar-${index}`);
            const timeDisplay = document.getElementById(`time-${index}`);
            const icon = document.getElementById(`icon-${index}`);

            // ç›‘å¬æ—¶é—´æ›´æ–°
            audio.ontimeupdate = () => {
                if (audio.duration) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    bar.style.width = percent + '%';
                    // æ ¼å¼åŒ–æ—¶é—´ 0:05
                    let s = Math.floor(audio.currentTime);
                    timeDisplay.innerText = "0:" + (s < 10 ? "0" + s : s);
                }
            };

            // æ’­æ”¾ç»“æŸï¼Œå›¾æ ‡å˜å›æš‚åœ
            audio.onended = () => {
                icon.className = 'fas fa-play';
                bar.style.width = '0%'; // å¯é€‰ï¼šæ’­å®Œå½’é›¶
            };
        }

        // === ğŸŸ¢ æ–°å¢ï¼šæ§åˆ¶è‡ªå®šä¹‰æ’­æ”¾å™¨ ===
        function toggleCustomPlay(index) {
            const audio = document.getElementById(`audio-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            
            // æš‚åœå…¶ä»–æ‰€æœ‰éŸ³é¢‘ (äº’æ–¥)
            document.querySelectorAll('audio').forEach(a => {
                if (a !== audio) { 
                    a.pause(); 
                    // æ‰¾åˆ°å¯¹åº”çš„å›¾æ ‡å¤ä½
                    const otherId = a.id.split('-')[1];
                    const otherIcon = document.getElementById(`icon-${otherId}`);
                    if(otherIcon) otherIcon.className = 'fas fa-play';
                }
            });

            if (audio.paused) {
                audio.play();
                icon.className = 'fas fa-pause'; // å˜æˆæš‚åœå›¾æ ‡
            } else {
                audio.pause();
                icon.className = 'fas fa-play'; // å˜æˆæ’­æ”¾å›¾æ ‡
            }
        }

        // ç‚¹å‡»è¿›åº¦æ¡è·³è½¬
        function seekAudio(e, index) {
            const audio = document.getElementById(`audio-${index}`);
            if (!audio || !audio.duration) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left; // ç‚¹å‡»ä½ç½®
            const width = rect.width;
            const percent = x / width;
            
            audio.currentTime = percent * audio.duration;
        }
    </script>
</body>
</html>
