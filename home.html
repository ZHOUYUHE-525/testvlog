<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­ Vlog è¯¾å ‚ | å­¦ä¹ ä¸­å¿ƒ</title>
    <!-- 1. ç”µè„‘æµè§ˆå™¨æ ‡ç­¾é¡µå›¾æ ‡ -->
<link rel="icon" type="image/png" href="logo.png">

<!-- 2. è‹¹æœ/å®‰å“æ‰‹æœºâ€œæ·»åŠ åˆ°æ¡Œé¢â€åçš„å›¾æ ‡ -->
<link rel="apple-touch-icon" href="logo.png">

<!-- 3. è®¾ç½®ç§»åŠ¨ç«¯çŠ¶æ€æ é¢œè‰²ï¼ˆè®©å®ƒæ›´åƒ Appï¼‰ -->
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- 1. å¼•å…¥å¿…è¦åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="auth.js"></script>

    <!-- ğŸŸ¢ 2. å¼•å…¥ä½ çš„æœ¬åœ°è¯¾ç¨‹æ•°æ® (ç¡®ä¿æ–‡ä»¶åæ­£ç¡®) -->
    <script src="lesson_001.js"></script>
    <script src="lesson_002.js"></script> 
    <script src="lesson_003.js"></script> 
    <script src="lesson_004.js"></script> 
    <script src="lesson_005.js"></script> 
    <script src="lesson_006.js"></script> 
    <script src="lesson_007.js"></script>
    <script src="lesson_008.js"></script>
    <script src="lesson_009.js"></script>
    <script src="lesson_010.js"></script>
    <script src="lesson_011.js"></script>
    <script src="lesson_012.js"></script>
    <script src="lesson_013.js"></script>
    <script src="lesson_014.js"></script>
    <script src="lesson_015.js"></script>
    <script src="lesson_016.js"></script>
    <script src="lesson_017.js"></script>
    <script src="lesson_018.js"></script>
    <script src="lesson_019.js"></script>
    <script src="lesson_020.js"></script>
    
    <script src="lesson_401.js"></script>
    <script src="lesson_402.js"></script>
    <script src="lesson_403.js"></script>
    <script src="lesson_404.js"></script>
    <script src="lesson_405.js"></script>
    <script src="lesson_406.js"></script>
    <script src="lesson_407.js"></script>
    <script src="lesson_408.js"></script>
    <script src="lesson_409.js"></script>

    <style>
        :root {
            --primary: #6CAD9C; --primary-light: #e0f2fe;
            --red: #8B3A3A; --bg: #F9F7F2; --white: #FFFFFF;
            --yellow: #E5CC84; --yellow-light: #fffbeb;
            --text: #4A3B32; --gray: #9ca3af;
        }
        body { margin: 0; font-family: "PingFang SC", "Microsoft YaHei", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* === ä¾§è¾¹æ æ•´ä½“å¸ƒå±€ === */
        .sidebar { 
            width: 320px; 
            background: var(--white); 
            border-right: 1px solid rgba(139, 58, 58, 0.1); 
            display: flex; 
            flex-direction: column; /* ç¡®ä¿å‚ç›´æ’åˆ— */
            position: relative; 
            z-index: 100; 
            box-shadow: 4px 0 15px rgba(0,0,0,0.02); 
            overflow-y: auto; 
            flex-shrink: 0;
        }
        .sidebar.collapsed { margin-left: -320px; transition: margin 0.3s ease; }
        .sidebar-toggle { position: absolute; right: -40px; top: 20px; width: 40px; height: 40px; background: var(--white); border: 1px solid #ddd; border-left: none; border-radius: 0 8px 8px 0; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--primary); }
        .sidebar-header { padding: 25px; border-bottom: 3px solid var(--yellow); flex-shrink: 0; }
        .logo { font-size: 22px; font-weight: 800; color: var(--red); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        
        /* æ•°æ®ç»Ÿè®¡å¡ç‰‡ */
        .stats-box { margin: 20px; padding: 20px; background: #fff8f0; border-radius: 12px; border: 1px solid var(--yellow); flex-shrink: 0; }
        .stats-title { font-size: 14px; font-weight: bold; color: var(--red); margin-bottom: 15px; display: flex; justify-content: space-between; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { text-align: center; }
        .stat-num { font-size: 20px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 11px; color: #888; margin-top: 4px; }

        /* === ğŸ“… æ–°ç‰ˆæœˆå†çƒ­åŠ›å›¾æ ·å¼ === */
        .calendar-section { padding: 0 20px; margin-bottom: 25px; flex-shrink: 0; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-title { font-size: 12px; font-weight: bold; color: #999; }
        .cal-month-label { font-size: 12px; color: var(--primary); font-weight: 800; background: var(--primary-light); padding: 2px 8px; border-radius: 10px; }
        .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 5px; text-align: center; }
        .cal-weekday { font-size: 10px; color: #999; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { aspect-ratio: 1; border-radius: 6px; background-color: #f3f4f6; position: relative; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #ccc; }
        .cal-day:hover { transform: scale(1.15); border: 1px solid var(--primary); z-index: 10; color: var(--text); }
        .cal-day:hover::after { content: attr(data-date); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; pointer-events: none; }
        .lvl-0 { background-color: #f3f4f6; } 
        .lvl-1 { background-color: #d1fae5; color: #065f46; font-weight: bold; } 
        .lvl-2 { background-color: #6CAD9C; color: white; font-weight: bold; } 
        .lvl-3 { background-color: #3b7566; color: white; font-weight: bold; }
        .cal-legend { display: flex; align-items: center; justify-content: space-between; margin-top:10px; }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }

        /* èœå•åŒºåŸŸ */
        .menu-section { padding: 0 20px; margin-bottom: 20px; flex-shrink: 0; }
        .menu-title { font-size: 12px; color: #999; margin-bottom: 10px; font-weight: bold; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; color: var(--text); font-size: 14px; margin-bottom: 5px; transition: all 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--bg); color: var(--red); }

        /* å³ä¾§ä¸»å†…å®¹ */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); }
        header { padding: 20px 40px; background: var(--bg); display: flex; flex-direction: column; gap: 15px; }
        .welcome-row { display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 26px; font-weight: 800; color: var(--red); }
        .top-tools { display: flex; align-items: center; gap: 15px; }
        .search-box { position: relative; width: 250px; }
        .search-input { width: 100%; padding: 8px 15px 8px 35px; border-radius: 20px; border: 1px solid #ddd; outline: none; transition: border 0.2s; }
        .search-input:focus { border-color: var(--primary); }
        .search-icon { position: absolute; left: 12px; top: 9px; color: #999; font-size: 14px; }
        .lang-switch { cursor: pointer; padding: 6px 12px; border-radius: 15px; background: #eee; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .lang-switch:hover { background: #e0f2fe; color: var(--primary); }
        .filter-row { 
            display: flex; 
            flex-direction: column; /* å…³é”®ï¼šç«–æ’ */
            gap: 15px; 
            align-items: flex-start; 
            margin-top: 10px;
        }

        .filter-group { 
            display: flex; 
            gap: 10px; /* æŒ‰é’®ä¹‹é—´çš„é—´è·å¤§ä¸€ç‚¹ */
            align-items: center; 
            flex-wrap: wrap; /* å…³é”®ï¼šå¦‚æœå±å¹•å¤ªçª„ï¼ŒæŒ‰é’®è‡ªåŠ¨æ¢è¡Œï¼Œä¸ç¡¬æŒ¤ */
            width: 100%;
        }

        .filter-label { 
            font-size: 13px; 
            color: #888; 
            font-weight: bold; 
            white-space: nowrap; /* ç¦æ­¢æ–‡å­—æ¢è¡Œ */
            min-width: 60px; /* ç»™å®ƒç•™å¤Ÿä½ç½® */
        }
        .filter-btn { 
            padding: 6px 16px; 
            border-radius: 20px; 
            border: 1px solid #ddd; 
            background: white; 
            color: #666; 
            cursor: pointer; 
            font-size: 13px; 
            transition: all 0.2s; 
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«æŒ¤æ‰ */
        }
        .filter-btn:hover, .filter-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
        }
        .sort-select { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; outline: none; color: #555; cursor: pointer; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 0 40px 40px 40px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }

        /* å¡ç‰‡ */
        .card { background: var(--white); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; border: 1px solid rgba(139, 58, 58, 0.08); display: flex; flex-direction: column; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card-cover { height: 170px; background-color: #ddd; background-size: cover; background-position: center; position: relative; }
        .duration-tag { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; }
        .fav-btn { position: absolute; top: 10px; left: 10px; width: 32px; height: 32px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 16px; transition: all 0.2s; z-index: 10; }
        .fav-btn.active { color: #ff4757; }
        .progress-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.4); position: absolute; bottom: 0; left: 0; z-index: 5; }
        .progress-bar-fill { height: 100%; background: #ff4757; box-shadow: 0 0 5px rgba(255, 71, 87, 0.5); transition: width 0.3s ease; }
        .progress-badge { position: absolute; top: 10px; right: 50px; background: rgba(0, 0, 0, 0.8); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; gap: 3px; }
        .card-body { padding: 16px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 4px; line-height: 1.4; color: var(--text); display: -webkit-box; line-clamp: 2; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .status-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; font-weight: bold; height: 20px;}
        .review-badge { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; padding: 1px 6px; border-radius: 4px; font-size: 10px; }
        .status-text.done { color: var(--primary); } 
        .status-text.watching { color: #f59e0b; }
        .card-desc { font-size: 13px; color: #888; margin-bottom: 15px; display: -webkit-box; line-clamp: 2; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 36px; }
        .card-footer { margin-top: auto; }
        .tag-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
        .pill-tag { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 12px; background: #f0f4f8; color: #555; }
        .pill-topic { background: var(--primary-light); color: #0369a1; }
        .bottom-row { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #999; }
        .level-badge { display: flex; align-items: center; gap: 4px; background: var(--yellow-light); color: #b45309; padding: 2px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #fcd34d; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px; color: #999; }
        /* === ä¸ªäººä¸­å¿ƒå¼¹çª—æ ·å¼ === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .profile-card { background: white; width: 320px; border-radius: 20px; padding: 25px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; }
        .modal-close:hover { color: var(--red); }

        /* å¤´éƒ¨ */
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .avatar-circle { width: 60px; height: 60px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--primary); border: 2px solid var(--white); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .user-email { font-weight: 800; color: var(--text); font-size: 16px; margin-bottom: 4px; }
        .user-role { font-size: 12px; color: #888; background: #f3f4f6; padding: 2px 8px; border-radius: 10px; display: inline-block; }

        /* ä¼šå‘˜å¡ */
        .vip-card { background: linear-gradient(135deg, #333 0%, #555 100%); color: #fcd34d; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .vip-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .vip-row:last-child { margin-bottom: 0; font-size: 12px; opacity: 0.8; }
        .vip-status.active { font-weight: bold; color: #4ade80; }

        /* æ“ä½œåˆ—è¡¨ */
        .action-list { margin-bottom: 20px; }
        .action-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #555; font-size: 14px; transition: all 0.2s; }
        .action-item:hover { padding-left: 5px; color: var(--primary); }
        .act-left { display: flex; align-items: center; gap: 10px; }

        /* é€€å‡ºæŒ‰é’® */
        .logout-btn { width: 100%; padding: 12px; border: 1px solid var(--red); background: white; color: var(--red); border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .logout-btn:hover { background: var(--red); color: white; }
        /* === ğŸ“± æ‰‹æœºç«¯æ•´å®¹çº§é€‚é… (ä»¿å°çº¢ä¹¦) === */
        @media (max-width: 768px) {
            /* 1. å…¨å±€å®¹å™¨ */
            body { flex-direction: column; overflow-x: hidden; background: #f8f8f8; }
            .main-content { width: 100vw; padding: 0; }

            /* 2. ä¾§è¾¹æ  (ä¿æŒæŠ½å±‰é€»è¾‘) */
            .sidebar { 
                position: fixed; top: 0; left: -320px; 
                width: 280px; height: 100vh; z-index: 2500; 
                display: flex !important; transition: left 0.3s ease; 
                box-shadow: 10px 0 20px rgba(0,0,0,0.2);
            }
            .sidebar.mobile-open { left: 0 !important; }
            .sidebar-toggle { display: none; }

            /* 3. æ‚¬æµ®èœå•æŒ‰é’® */
            .mobile-fab {
                position: fixed; bottom: 30px; right: 20px;
                width: 45px; height: 45px;
                background: var(--primary); color: white;
                border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3);
                z-index: 3000; font-size: 20px;
            }

            /* 4. é¡¶éƒ¨ Header (å¤§æ”¹ï¼) */
            header { 
                padding: 10px 15px; 
                height: auto; 
                flex-direction: column; /* å˜æˆç«–æ’ */
                gap: 12px; 
                background: white;
                position: sticky; top: 0; z-index: 2000; /* å¸é¡¶ */
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }
            
            /* ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ + è¯­è¨€åˆ‡æ¢ */
            .welcome-row { 
                width: 100%; 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
            }
            .page-title { font-size: 20px; margin: 0; color: #333; }
            .lang-switch { background: #f5f5f5; padding: 4px 10px; font-size: 12px; }

            /* ç¬¬äºŒè¡Œï¼šæœç´¢æ¡† (ç‹¬å ä¸€è¡Œ) */
            .top-tools { 
                width: 100%; 
                gap: 10px; 
                display: flex;
            }
            .search-box { 
                width: 100%; 
                flex: 1; 
            }
            .search-input { 
                width: 100%; 
                box-sizing: border-box; 
                background: #f5f5f5; 
                border: none; /* å»æ‰è¾¹æ¡†ï¼ŒåƒAPP */
                padding: 8px 10px 8px 35px;
                height: 36px;
            }
            .search-icon { top: 10px; }
            
            /* éšè—æ’åºä¸‹æ‹‰æ¡† (æ‰‹æœºä¸Šä¸å¤ªå¸¸ç”¨ï¼Œçœç©ºé—´) */
            .sort-select { display: none; }

            /* 5. ç­›é€‰åŒº (æ ¸å¿ƒï¼å¼ºåˆ¶æ¨ªæ»‘) */
            .filter-row {
                width: 100%;
                padding: 5px 15px;
                background: white;
                margin-top: 0;
                border-bottom: 1px solid #f0f0f0;
                gap: 8px;
            }
            .filter-group {
                display: flex;
                gap: 8px;
                width: 100%;
                overflow-x: auto !important; /* å¼ºåˆ¶å…è®¸æ»‘åŠ¨ */
                white-space: nowrap !important; /* å¼ºåˆ¶ä¸æ¢è¡Œ */
                flex-wrap: nowrap !important; /* ç¦æ­¢æ¢è¡Œ */
                padding-bottom: 0;
                align-items: center;
                /* éšè—æ»šåŠ¨æ¡ */
                -ms-overflow-style: none;  
                scrollbar-width: none;  
            }
            .filter-group::-webkit-scrollbar { display: none; }

            /* éšè— "Topic:" è¿™äº›æ–‡å­—æ ‡ç­¾ */
            .filter-label { display: none; } 

            .filter-btn {
                flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤æ‰ */
                padding: 6px 14px;
                font-size: 13px;
                background: #f5f5f5;
                border: none;
                color: #666;
                border-radius: 16px;
            }
            .filter-btn.active {
                background: var(--primary-light);
                color: var(--primary);
                font-weight: bold;
                border: 1px solid var(--primary);
            }

            /* 6. å†…å®¹åŒº (åŒåˆ—ç€‘å¸ƒæµ) */
            .content-scroll { 
                padding: 10px; 
                padding-bottom: 80px; 
            }
            .grid { 
                display: grid;
                grid-template-columns: 1fr 1fr; /* ä¸¤åˆ—ï¼ */
                gap: 10px; 
            }
            
            /* å¡ç‰‡æ ·å¼å¾®è°ƒ */
            .card {
                border-radius: 8px;
                box-shadow: none;
                border: 1px solid #f0f0f0;
            }
            .card-cover { height: 100px; } /* å°é¢å˜çŸ®ä¸€ç‚¹é€‚é…åŒåˆ— */
            .card-body { padding: 10px; }
            .card-title { font-size: 13px; line-height: 1.4; margin-bottom: 4px; }
            .card-desc { display: none; } /* æ‰‹æœºåˆ—è¡¨é¡µéšè—æè¿°ï¼Œå¤ªæŒ¤äº† */
            .status-row { font-size: 10px; margin-bottom: 4px; }
            .tag-row { display: none; } /* åˆ—è¡¨é¡µéšè—æ ‡ç­¾ï¼Œæ¸…çˆ½ç‚¹ */
            
            /* å¼¹çª— */
            .profile-card { width: 85%; }
        }
    </style>
</head>
<body>
<!-- æ‚¬æµ®æŒ‰é’® -->
<div class="mobile-fab" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
        <div class="sidebar-header"><div class="logo"><i class="fas fa-book-reader"></i> æ±‰è¯­ Vlog</div></div>
        
        <!-- ç»Ÿè®¡ -->
        <div class="stats-box">
            <div class="stats-title"><span data-i18n="my_data">æˆ‘çš„å­¦ä¹ æ•°æ®</span><i class="fas fa-chart-line"></i></div>
            <div class="stats-grid">
                <!-- ç»™æ•°å­—åŠ ä¸Š id="stat-xxx" -->
                <div class="stat-item">
                    <div class="stat-num" id="stat-days">1</div>
                    <div class="stat-label" data-i18n="days">å¤©æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-hours">0h</div>
                    <div class="stat-label" data-i18n="hours">æ—¶é•¿</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-videos">0</div>
                    <div class="stat-label" data-i18n="videos">å·²çœ‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-num" id="stat-vocab">0</div>
                    <div class="stat-label" data-i18n="vocab">è¯æ±‡</div>
                </div>
            </div>
        </div>

        <!-- ğŸ“… æ–°ç‰ˆæœˆå† -->
        <div class="calendar-section">
            <div class="cal-header">
                <div class="cal-title"><span data-i18n="heatmap">å­¦ä¹ æ‰“å¡</span></div>
                <div class="cal-month-label" id="currentMonthStr">...</div>
            </div>
            <div class="cal-weekdays">
                <div class="cal-weekday">æ—¥</div><div class="cal-weekday">ä¸€</div><div class="cal-weekday">äºŒ</div>
                <div class="cal-weekday">ä¸‰</div><div class="cal-weekday">å››</div><div class="cal-weekday">äº”</div>
                <div class="cal-weekday">å…­</div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
            <div class="cal-legend">
                <span style="font-size:10px; color:#ccc">Less</span>
                <div style="display:flex; gap:3px;">
                    <div class="legend-dot lvl-0" style="background:#f3f4f6"></div>
                    <div class="legend-dot lvl-1" style="background:#d1fae5"></div>
                    <div class="legend-dot lvl-2" style="background:#6CAD9C"></div>
                    <div class="legend-dot lvl-3" style="background:#3b7566"></div>
                </div>
                <span style="font-size:10px; color:#ccc">More</span>
            </div>
        </div>

        <!-- èœå• -->
        <div class="menu-section">
            <div class="menu-title" data-i18n="menu_records">å­¦ä¹ è®°å½•</div>
            <!-- æŒ‰é’® 1: ç¬¬ä¸€å­£ -->
            <div class="menu-item" onclick="filterByBatch('season_1', this)">
                <i class="fas fa-folder"></i> 
                <!-- ğŸŸ¢ åŠ ä¸Š data-i18n -->
                <span data-i18n="batch_s1">ç¬¬ 1-100 æœŸ</span>
            </div>

            <!-- æŒ‰é’® 2: ç¬¬äºŒå­£ -->
            <div class="menu-item" onclick="filterByBatch('season_2', this)">
                <i class="fas fa-folder-open"></i> 
                <!-- ğŸŸ¢ åŠ ä¸Š data-i18n -->
                <span data-i18n="batch_s2">ç¬¬ 101-200 æœŸ</span>
            </div>

            <!-- ğŸŸ¢ æ–°å¢ï¼šç”µè§†å‰§ (æ¢ä¸ªç”µè§†å›¾æ ‡ fa-tv) -->
             <div class="menu-item" onclick="filterByBatch('tv_drama', this)">
                <i class="fas fa-tv"></i> 
                <span data-i18n="batch_drama">ç”µè§†å‰§</span>
            </div>

            <!-- ğŸŸ¢ æ–°å¢ï¼šç»¼è‰º (æ¢ä¸ªéº¦å…‹é£å›¾æ ‡ fa-microphone-alt) -->
            <div class="menu-item" onclick="filterByBatch('talk_show', this)">
               <i class="fas fa-microphone-alt"></i> 
               <span data-i18n="batch_talk_show">è„±å£ç§€</span>
            </div>

            <div class="menu-item active" onclick="filterByMenu('all', this)"><i class="fas fa-history"></i> <span data-i18n="menu_all">å…¨éƒ¨è¯¾ç¨‹</span></div>
            <div class="menu-item" onclick="filterByMenu('fav', this)"><i class="fas fa-bookmark"></i> <span data-i18n="menu_fav">æˆ‘çš„æ”¶è—</span></div>
            <div class="menu-item" onclick="filterByMenu('done', this)"><i class="fas fa-check-circle"></i> <span data-i18n="menu_done">å·²å®Œæˆ</span></div>
            <div class="menu-item" onclick="location.href='review.html'" style="color: var(--primary); font-weight:bold; background: var(--primary-light);">
                <i class="fas fa-brain"></i> <span data-i18n="menu_review">è‰¾å®¾æµ©æ–¯å¤ä¹ </span>
            </div>
            <!-- ğŸŸ¢ ä¿®æ”¹ï¼šæ”¹ä¸ºâ€œå­¦ä¹ å·¥å…·â€å…¥å£ -->
            <div class="menu-item" onclick="location.href='tools.html'">
                <i class="fas fa-toolbox"></i> 
                <span data-i18n="menu_tools">å­¦ä¹ å·¥å…·</span>
            </div>
            <!-- è·³è½¬åˆ°è§„åˆ™é¡µ -->
            <div class="menu-item" onclick="location.href='rules.html'">
                <i class="fas fa-info-circle"></i> 
                <!-- ğŸŸ¢ åŠ ä¸Š data-i18n="menu_rules" -->
                <span data-i18n="menu_rules">ä½¿ç”¨é¡»çŸ¥</span>
            </div>
            
            
        


        <div class="menu-section">
            <div class="menu-title" data-i18n="menu_account">è´¦æˆ·</div>
            <div class="menu-item" onclick="openProfile()">
                
    <i class="fas fa-user-circle"></i> 
    <span data-i18n="menu_profile">ä¸ªäººä¸­å¿ƒ</span>
</div>
            <!-- 4. é€€å‡ºæŒ‰é’® (ä¿®å¤æ ·å¼ç‰ˆ) -->
<button class="logout-btn" onclick="forceLogout()">
    <i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_logout">é€€å‡ºç™»å½•</span>
</button>
</div>
        </div>
    </div>

    <!-- å³ä¾§å†…å®¹ -->
    <div class="main-content">
        <header>
            <div class="welcome-row">
                <div class="page-title" data-i18n="video_lib">è§†é¢‘å†…å®¹å±•ç¤º</div>
                <div class="top-tools">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input class="search-input" id="searchBox" placeholder="Search..." oninput="searchVideo(this.value)">
                    </div>
                    <select class="sort-select" id="sortSelect" onchange="sortVideos(this.value)">
                        <option value="new">Sort: Newest</option>
                        <option value="progress">Sort: Progress</option>
                    </select>
                    <div class="lang-switch" onclick="toggleLang()">
                        <i class="fas fa-globe"></i> <span id="langLabel">RU</span>
                    </div>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <span class="filter-label" data-i18n="filter_level">éš¾åº¦:</span>
                    <button class="filter-btn active" data-type="hsk" data-val="all" onclick="applyFilter('hsk', 'all', this)">æ‰€æœ‰</button>
                    <button class="filter-btn" data-type="hsk" data-val="HSK 3" onclick="applyFilter('hsk', 'HSK 3', this)">HSK 3</button>
                    <button class="filter-btn" data-type="hsk" data-val="HSK 4" onclick="applyFilter('hsk', 'HSK 4', this)">HSK 4</button>
                    <button class="filter-btn" data-type="hsk" data-val="HSK 5" onclick="applyFilter('hsk', 'HSK 5', this)">HSK 5</button>
                    <button class="filter-btn" data-type="hsk" data-val="HSK 6" onclick="applyFilter('hsk', 'HSK 6', this)">HSK 6</button>
                    <button class="filter-btn" data-type="hsk" data-val="HSK 6+" onclick="applyFilter('hsk', 'HSK 6+', this)">HSK 6+</button>
                </div>
                <div class="filter-group">
    <span class="filter-label" data-i18n="filter_topic">ä¸»é¢˜:</span>
    <button class="filter-btn active" data-type="topic" data-val="all" data-i18n="topic_all" onclick="applyFilter('topic', 'all', this)">æ‰€æœ‰</button>
    <button class="filter-btn" data-type="topic" data-val="job" data-i18n="topic_job" onclick="applyFilter('topic', 'job', this)">å·¥ä½œ</button>
    <button class="filter-btn" data-type="topic" data-val="life" data-i18n="topic_life" onclick="applyFilter('topic', 'life', this)">ç”Ÿæ´»</button>
    <button class="filter-btn" data-type="topic" data-val="food" data-i18n="topic_food" onclick="applyFilter('topic', 'food', this)">é£Ÿç‰©</button>
    <button class="filter-btn" data-type="topic" data-val="culture" data-i18n="topic_culture" onclick="applyFilter('topic', 'culture', this)">æ–‡åŒ–</button>
    
    <!-- ğŸ‘‡ æ³¨æ„è¿™é‡ŒåŠ äº† data-i18nï¼Œå¹¶ä¸” data-val å»ºè®®é¦–å­—æ¯å°å†™ -->
    <button class="filter-btn" data-type="topic" data-val="thoughts" data-i18n="topic_thoughts" onclick="applyFilter('topic', 'thoughts', this)">æ„Ÿæƒ³</button>
    <button class="filter-btn" data-type="topic" data-val="shopping" data-i18n="topic_shopping" onclick="applyFilter('topic', 'shopping', this)">è´­ç‰©</button>
    <button class="filter-btn" data-type="topic" data-val="fashion" data-i18n="topic_fashion" onclick="applyFilter('topic', 'fashion', this)">ç©¿æ­</button>
    <button class="filter-btn" data-type="topic" data-val="travel" data-i18n="topic_travel" onclick="applyFilter('topic', 'travel', this)">æ—…è¡Œ</button>
    <button class="filter-btn" data-type="topic" data-val="beauty" data-i18n="topic_beauty" onclick="applyFilter('topic', 'beauty', this)">æŠ¤è‚¤åŒ–å¦†</button>
    <button class="filter-btn" data-type="topic" data-val="sports" data-i18n="topic_sports" onclick="applyFilter('topic', 'sports', this)">è¿åŠ¨</button>
    <button class="filter-btn" data-type="topic" data-val="study" data-i18n="topic_study" onclick="applyFilter('topic', 'study', this)">å­¦ä¹ </button>
</div>
            </div>
        </header>

        <div class="content-scroll">
            <div class="grid" id="videoGrid"></div>
        </div>
    </div>

    <!-- === ä¸ªäººä¸­å¿ƒå¼¹çª— (å·²æ·»åŠ å¤šè¯­è¨€æ ‡ç­¾) === -->
    <div id="profileModal" class="modal-overlay" style="display: none;">
        <div class="profile-card">
            <div class="modal-close" onclick="closeProfile()">Ã—</div>
            
            <!-- 1. å¤´éƒ¨ -->
            <div class="profile-header">
                <div class="avatar-circle">
                    <i class="fas fa-user-astronaut"></i> <!-- æ¢äº†ä¸ªå®‡èˆªå‘˜å›¾æ ‡ï¼Œæ›´åƒå­¦ä¹ è€… -->
                </div>
                <div class="profile-info">
                    <div class="user-email" id="p-email">student@vip.com</div>
                    <!-- åŠ ä¸Š data-i18n -->
                    <div class="user-role" data-i18n="p_role">HSK 4 å­¦ä¹ è€…</div>
                </div>
            </div>

            <!-- 2. ä¼šå‘˜çŠ¶æ€å¡ -->
            <div class="vip-card">
                <div class="vip-row">
                    <!-- åŠ ä¸Š data-i18n -->
                    <span class="vip-label"><i class="fas fa-crown"></i> <span data-i18n="p_status_label">ä¼šå‘˜çŠ¶æ€</span></span>
                    <span class="vip-status active" id="p-status" data-i18n="p_active">ç”Ÿæ•ˆä¸­</span>
                </div>
                <div class="vip-row">
                    <!-- åŠ ä¸Š data-i18n -->
                    <span class="vip-label" data-i18n="p_expire_label">åˆ°æœŸæ—¶é—´</span>
                    <span class="vip-date" id="p-expire">2025-12-31</span>
                </div>
            </div>

            <!-- 3. æ“ä½œåˆ—è¡¨ -->
            <div class="action-list">
                <div class="action-item" onclick="syncData()">
                    <!-- åŠ ä¸Š data-i18n -->
                    <div class="act-left"><i class="fas fa-cloud-upload-alt" style="color:#3b82f6;"></i> <span data-i18n="p_sync">åŒæ­¥è¿›åº¦åˆ°äº‘ç«¯</span></div>
                    <i class="fas fa-chevron-right"></i>
                </div>
                <div class="action-item" onclick="downloadData()">
    <div class="act-left">
        <!-- æ¢äº†ä¸ªç»¿è‰²çš„ä¸‹è½½å›¾æ ‡ -->
        <i class="fas fa-cloud-download-alt" style="color:#10b981;"></i> 
        <span data-i18n="p_download">ä»äº‘ç«¯æ¢å¤è¿›åº¦</span>
    </div>
    <i class="fas fa-chevron-right"></i>
</div>
                <div class="action-item" onclick="alert('è¯·è”ç³»è€å¸ˆé‡ç½®å¯†ç ')">
                    <!-- åŠ ä¸Š data-i18n -->
                    <div class="act-left"><i class="fas fa-lock" style="color:#f59e0b;"></i> <span data-i18n="p_password">ä¿®æ”¹å¯†ç </span></div>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <!-- 4. é€€å‡ºæŒ‰é’® -->
            <div class="menu-item" onclick="forceLogout()" style="color:var(--red); cursor:pointer;">
    <i class="fas fa-sign-out-alt"></i> <span data-i18n="menu_logout">é€€å‡ºç™»å½•</span>
</div>
    </div>

    <script>
        // ğŸ”´ğŸ”´ğŸ”´ 1. è¡¥å…¨äº‘ç«¯é…ç½® (å¿…é¡»æ”¾åœ¨æœ€å‰é¢ï¼) ğŸ”´ğŸ”´ğŸ”´
        const SUPABASE_URL = 'https://bwweaohahsafbecogist.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ3d2Vhb2hhaHNhZmJlY29naXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTk3MjMsImV4cCI6MjA4NDMzNTcyM30.ZqViPiwlvzzaqkWLMzejjpgHXeztkD0K0ne32kfGhWw';

        // ğŸŸ¢ ä¿®æ”¹ç‚¹ï¼šå°†å˜é‡å supabase æ”¹ä¸º supabaseClientï¼Œé¿å…å’Œåº“åå†²çª
        let supabaseClient = null;
        
        // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½
        if (window.supabase && window.supabase.createClient) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("âœ… äº‘ç«¯æœåŠ¡å·²è¿æ¥");
        } else {
            console.error("âŒ Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ CDN");
        }


        // === 1. åˆå§‹åŒ–å˜é‡ ===
        let allVideos = [];
        let currentFilters = { hsk: 'all', topic: 'all', menu: 'all', search: '', batch: 'all' };
        let currentLang = 'ru'; 

        // === 2. åŠ è½½æ•°æ® ===
        document.addEventListener('DOMContentLoaded', () => {
            console.log("è¯»å–æœ¬åœ°æ•°æ®...");
            
            if (typeof updateUserAccess === 'function') {
                updateUserAccess();
    }

            if (window.lessonDatabase) {
                allVideos = Object.keys(window.lessonDatabase).map(id => {
                    const item = window.lessonDatabase[id];
                    item.id = id;
                    item.searchStr = (item.title + item.desc + item.author + (item.topic||'')).toLowerCase();
                    return item;
                });
                updateLanguage();
                
                // ğŸŸ¢ æ–°å¢ï¼šè®¡ç®—çœŸå®æ•°æ®
                calculateStats();
                
                // æ¸²æŸ“æ—¥å†
                renderMonthCalendar();
            } else {
                alert("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æœ¬åœ°è¯¾ç¨‹æ•°æ®ï¼è¯·æ£€æŸ¥ lesson_001.js");
            }
                
        });

        // === ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½ï¼šè®¡ç®—çœŸå®å­¦ä¹ æ•°æ® ===
        function calculateStats() {
            // ğŸŸ¢ ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨ YYYY-M-D æ ¼å¼ï¼Œä¸ä¾èµ–æµè§ˆå™¨è¯­è¨€
            const now = new Date();
            const todayKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            
            let studyDates = JSON.parse(localStorage.getItem('my_study_days') || '[]');
            if (!studyDates.includes(todayKey)) {
                studyDates.push(todayKey);
                localStorage.setItem('my_study_days', JSON.stringify(studyDates));
            }
            document.getElementById('stat-days').innerText = studyDates.length;

            // ... (ä¸‹é¢çš„ä»£ç ä¿æŒä¸å˜) ...
            let startedVideos = 0, totalSeconds = 0, totalVocab = 0;
            allVideos.forEach(v => {
                // ... (ä¿æŒä¸å˜) ...
                const progress = parseInt(localStorage.getItem('progress_' + v.id) || 0);
                if (progress > 0) {
                    startedVideos++;
                    if (v.flashcards) totalVocab += v.flashcards.length;
                    if (v.duration && v.duration.includes(':')) {
                        const parts = v.duration.split(':');
                        totalSeconds += (parseInt(parts[0]) * 60 + parseInt(parts[1])) * (progress / 100);
                    }
                }
            });
            document.getElementById('stat-videos').innerText = startedVideos;
            document.getElementById('stat-hours').innerText = (totalSeconds / 3600).toFixed(1) + 'h';
            document.getElementById('stat-vocab').innerText = totalVocab;
        }
        
        // === ä¸ªäººä¸­å¿ƒé€»è¾‘ ===
        
        function openProfile() {
            // 1. è·å–ç”¨æˆ·ä¿¡æ¯ (ç›®å‰å…ˆç”¨å‡æ•°æ®æ¼”ç¤ºæ•ˆæœ)
            // ç­‰ä½ æ¢å¤ auth.js åï¼Œè¿™é‡Œä¼šä» Supabase è¯»å–çœŸå®æ•°æ®
            const user = {
                email: "student@vip.com", 
                expire: "2025-12-31" 
            };
            
            // 2. å¡«å…¥æ•°æ®
            document.getElementById('p-email').innerText = user.email;
            document.getElementById('p-expire').innerText = user.expire;
            
            // 3. æ˜¾ç¤ºå¼¹çª—
            document.getElementById('profileModal').style.display = 'flex';
        }

        function closeProfile() {
            document.getElementById('profileModal').style.display = 'none';
        }

        // === ğŸŸ¢ å®Œç¾ç‰ˆï¼šåŒæ­¥è¿›åº¦åˆ° user_progress è¡¨ ===
window.syncData = async function() {
    console.log("ç‚¹å‡»äº†åŒæ­¥...");

    // 1. æ£€æŸ¥å®¢æˆ·ç«¯ (æ³¨æ„è¿™é‡Œç”¨ supabaseClient)
    if (!supabaseClient) return alert("âŒ æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•");
    
    // 2. è·å–ç”¨æˆ·
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return alert("âš ï¸ è¯·å…ˆç™»å½•è´¦å·");

    // 3. æ‰“åŒ…æœ¬åœ°æ•°æ® (æ›´èªæ˜çš„ç­›é€‰)
    const dataToUpload = {};
    let count = 0;
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        
        // ğŸš¨ å…³é”®ä¿®æ”¹ï¼šæ’é™¤æ‰ 'my_session' å’Œ 'sb-' å¼€å¤´çš„ç³»ç»Ÿæ•°æ®ï¼Œåªä¼ å­¦ä¹ è®°å½•
        if (key.includes('session') || key.includes('sb-') || key.includes('token')) {
    continue; 
}

// ğŸŸ¢ 2. æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯ 'my_access_tags' (æƒé™)ï¼Œç»å¯¹ä¸è¦ä¸Šä¼ ï¼
if (key === 'my_access_tags') {
    continue;
}

// 3. ä¿å­˜å…¶ä»–æ•°æ®
if (key.startsWith('progress_') || key.startsWith('done_') || key.startsWith('my_')) {
    dataToUpload[key] = localStorage.getItem(key);
    count++;
}

        // åªæå–è¿›åº¦ã€å®ŒæˆçŠ¶æ€ã€ç”Ÿè¯æœ¬ã€æƒé™æ ‡ç­¾
        if (key.startsWith('progress_') || key.startsWith('done_') || key.startsWith('my_')) {
            dataToUpload[key] = localStorage.getItem(key);
            count++;
        }
    }

    if (count === 0) return alert("æœ¬åœ°æ²¡æœ‰å­¦ä¹ è®°å½•ï¼Œæ— éœ€åŒæ­¥ã€‚");

    // UI åé¦ˆ
    const btnText = document.querySelector('.action-item span[data-i18n="p_sync"]');
    const originalText = btnText ? btnText.innerText : "åŒæ­¥";
    if(btnText) btnText.innerText = "â³ ä¸Šä¼ ä¸­...";

    try {
        // 4. ä¸Šä¼ åˆ° user_progress è¡¨
        // ä½¿ç”¨ upsertï¼šå¦‚æœ user_id å­˜åœ¨å°±æ›´æ–°ï¼Œä¸å­˜åœ¨å°±æ–°å»º
        const { error } = await supabaseClient
            .from('user_progress')
            .upsert({ 
                user_id: user.id, 
                data: dataToUpload,
                updated_at: new Date().toISOString() // å¦‚æœä½ çš„è¡¨æœ‰è¿™ä¸ªå­—æ®µæœ€å¥½ï¼Œæ²¡æœ‰ä¹Ÿæ²¡äº‹
            }, { onConflict: 'user_id' }); // æ ¹æ® user_id æŸ¥é‡

        if (error) throw error;
        
        alert(`âœ… åŒæ­¥æˆåŠŸï¼\nå·²å¤‡ä»½ ${count} æ¡æ•°æ®åˆ°ä¸“å±è®°å½•è¡¨ã€‚`);
    } catch (e) {
        console.error(e);
        alert("âŒ åŒæ­¥å¤±è´¥: " + e.message);
    } finally {
        if(btnText) btnText.innerText = originalText;
    }
};
        
// === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šæ™ºèƒ½åˆå¹¶ä¸‹è½½ (Smart Merge) ===
        window.downloadData = async function(isSilent = false) {
            if (!supabaseClient) return;
            
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                if(!isSilent) alert("è¯·å…ˆç™»å½•ï¼");
                return;
            }

            const btnSpan = document.querySelector('.action-item span[data-i18n="p_download"]');
            const originalText = btnSpan ? btnSpan.innerText : "æ¢å¤è¿›åº¦";
            if(!isSilent && btnSpan) btnSpan.innerText = "â³ ä¸‹è½½ä¸­...";

            try {
                // 1. ä»äº‘ç«¯æ‹‰å–æ•°æ®
                const { data, error } = await supabaseClient
                    .from('user_progress')
                    .select('data')
                    .eq('user_id', user.id)
                    .maybeSingle();

                if (error) throw error;

                if (data && data.data) {
                    const cloudData = data.data;
                    let count = 0;

                    // 2. å¼€å§‹æ™ºèƒ½åˆå¹¶
                    for (const key in cloudData) {
                        const cloudVal = cloudData[key];
                        const localVal = localStorage.getItem(key);

                        // ğŸš¨ ç»å¯¹è·³è¿‡ï¼šæƒé™æ•°æ® (ä»¥æœ¬åœ°å®æ—¶è·å–çš„ profiles ä¸ºå‡†)
                        if (key === 'my_access_tags') continue;

                        // ğŸ§  æƒ…å†µ Aï¼šæ•°ç»„ç±»å‹æ•°æ® (ç”Ÿè¯æœ¬ã€æ—¥å†) -> åˆå¹¶å¹¶å»é‡
                        if (key === 'my_vocab_list' || key === 'my_study_days') {
                            try {
                                const localArr = localVal ? JSON.parse(localVal) : [];
                                const cloudArr = JSON.parse(cloudVal || '[]');
                                // Set å»é‡åˆå¹¶
                                const mergedArr = [...new Set([...localArr, ...cloudArr])];
                                localStorage.setItem(key, JSON.stringify(mergedArr));
                                count++;
                            } catch(e) { console.warn("æ•°ç»„åˆå¹¶å¤±è´¥", e); }
                            continue;
                        }

                        // ğŸ§  æƒ…å†µ Bï¼šè¿›åº¦æ•°æ® (progress_xxx) -> å–æœ€å¤§å€¼
                        if (key.startsWith('progress_')) {
                            const localNum = parseInt(localVal || 0);
                            const cloudNum = parseInt(cloudVal || 0);
                            if (cloudNum > localNum) {
                                localStorage.setItem(key, cloudNum);
                                count++;
                            }
                            continue;
                        }

                        // ğŸ§  æƒ…å†µ Cï¼šå®ŒæˆçŠ¶æ€ (done_xxx) -> åªè¦æœ‰ä¸€ä¸ªæ˜¯ true å°± true
                        if (key.startsWith('done_')) {
                            if (cloudVal === 'true' && localVal !== 'true') {
                                localStorage.setItem(key, 'true');
                                count++;
                            }
                            continue;
                        }

                        // ğŸ§  æƒ…å†µ Dï¼šå…¶ä»–æ™®é€šæ•°æ® -> å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œæ‰å†™å…¥ï¼›å¦‚æœæœ¬åœ°æœ‰ï¼Œä¿ç•™æœ¬åœ°çš„(æœ¬åœ°ä¼˜å…ˆ)
                        if (!localVal) {
                            localStorage.setItem(key, cloudVal);
                            count++;
                        }
                    }

                    // 3. åˆ·æ–°ç•Œé¢
                    if (typeof calculateStats === 'function') calculateStats();
                    if (typeof renderMonthCalendar === 'function') renderMonthCalendar();
                    if (typeof renderVideos === 'function' && typeof getFilteredVideos === 'function') {
                        renderVideos(getFilteredVideos());
                    }
                    
                    if(!isSilent) alert(`âœ… æ¢å¤æˆåŠŸï¼\nå·²æ™ºèƒ½åˆå¹¶ ${count} é¡¹æ–°è¿›åº¦ã€‚`);
                } else {
                    if(!isSilent) alert("â˜ï¸ äº‘ç«¯æš‚æ— å¤‡ä»½æ•°æ®");
                }
            } catch (e) {
                console.error(e);
                if(!isSilent) alert("âŒ ä¸‹è½½å¤±è´¥: " + e.message);
            } finally {
                if(!isSilent && btnSpan) btnSpan.innerText = originalText;
            }
        };

        
        // ç‚¹å‡»é®ç½©å±‚ä¹Ÿå¯ä»¥å…³é—­
        document.getElementById('profileModal').addEventListener('click', function(e) {
            if (e.target === this) closeProfile();
        });

        // === 3. è¯­è¨€å­—å…¸ ===
        const uiDict = {
            ru: {
                // åŸæœ‰è¯æ¡
                my_data: "ĞœĞ¾Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ", days: "Ğ”Ğ½ĞµĞ¹", hours: "Ğ§Ğ°ÑĞ¾Ğ²", videos: "Ğ’Ğ¸Ğ´ĞµĞ¾", vocab: "Ğ¡Ğ»Ğ¾Ğ²",
                heatmap: "ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ", today: "Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ",
                menu_records: "Ğ—Ğ°Ğ¿Ğ¸ÑĞ¸", menu_all: "Ğ’ÑĞµ Ğ²Ğ¸Ğ´ĞµĞ¾", menu_fav: "Ğ˜Ğ·Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğµ", menu_done: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾", menu_review: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ĞµĞ½Ğ¸Ğµ", menu_account: "ĞĞºĞºĞ°ÑƒĞ½Ñ‚", menu_profile: "ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ", menu_logout: "Ğ’Ñ‹Ğ¹Ñ‚Ğ¸",
                video_lib: "Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ°", filter_level: "Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ:", filter_topic: "Ğ¢ĞµĞ¼Ğ°:",
                status_done: "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾", status_watch: "ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€", status_new: "ĞĞ¾Ğ²Ğ¾Ğµ", review: "ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ",
                topic_job: "Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°", topic_life: "Ğ–Ğ¸Ğ·Ğ½ÑŒ", topic_food: "Ğ•Ğ´Ğ°", topic_culture: "ĞšÑƒĞ»ÑŒÑ‚ÑƒÑ€Ğ°", topic_thoughts: "ĞœÑ‹ÑĞ»Ğ¸", topic_shopping: "ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ¸",
                sort_new: "Ğ¡Ğ¾Ñ€Ñ‚: ĞĞ¾Ğ²Ñ‹Ğµ", sort_prog: "Ğ¡Ğ¾Ñ€Ñ‚: ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ",
                
                // ğŸŸ¢ æ–°å¢ï¼šä¸ªäººä¸­å¿ƒè¯æ¡
                p_role: "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚ HSK 4",
                p_status_label: "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ",
                p_active: "ĞĞºÑ‚Ğ¸Ğ²ĞµĞ½",
                p_expire_label: "Ğ˜ÑÑ‚ĞµĞºĞ°ĞµÑ‚",
                p_sync: "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°",
                p_password: "Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ",
                sidebar_batch: "Ğ¡ĞµĞ·Ğ¾Ğ½Ñ‹",
                batch_s1: "Ğ¡ĞµĞ·Ğ¾Ğ½ 1(20/120)",
                batch_s2: "Ğ¡ĞµĞ·Ğ¾Ğ½ 2(-)",
                status_lock: "Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¾",
                msg_lock: "Ğ­Ñ‚Ğ¾Ñ‚ ĞºÑƒÑ€Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸. Ğ¡Ğ²ÑĞ¶Ğ¸Ñ‚ĞµÑÑŒ Ñ ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»ĞµĞ¼!",
                menu_rules: "âš ï¸Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ• Ğ¸ Ğ¡ĞĞ’Ğ•Ğ¢Ğ«âš ï¸", // ğŸŸ¢ æ–°å¢
                p_sync: "Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Upload)",
                p_download: "Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ (Download)",
                batch_s3: "201-300 (ĞĞ¾Ğ²Ñ‹Ğ¹)",
                batch_drama: "Ğ¡ĞµÑ€Ğ¸Ğ°Ğ»Ñ‹",
                batch_talk_show: "Ğ¡Ñ‚ĞµĞ½Ğ´Ğ°Ğ¿ï¼ˆ9/30ï¼‰",
                topic_fashion: "ĞœĞ¾Ğ´Ğ°",
                topic_travel: "ĞŸÑƒÑ‚ĞµÑˆĞµÑÑ‚Ğ²Ğ¸Ñ",
                topic_beauty: "ĞšÑ€Ğ°ÑĞ¾Ñ‚Ğ°",
                topic_sports: "Ğ¡Ğ¿Ğ¾Ñ€Ñ‚",
                topic_study: "Ğ£Ñ‡Ñ‘Ğ±Ğ°",
                menu_tools: "Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ (Tools)",
               
            },
            en: {
                // åŸæœ‰è¯æ¡
                my_data: "My Data", days: "Days", hours: "Hours", videos: "Videos", vocab: "Vocab",
                heatmap: "Heatmap", today: "Today",
                menu_records: "Records", menu_all: "All Courses", menu_fav: "Favorites", menu_done: "Completed", menu_review: "Review", menu_account: "Account", menu_profile: "Profile", menu_logout: "Logout",
                video_lib: "Video Library", filter_level: "Level:", filter_topic: "Topic:",
                status_done: "Done", status_watch: "Watched", status_new: "New", review: "Review",
                topic_job: "Work", topic_life: "Life", topic_food: "Food", topic_culture: "Culture", topic_thoughts: "Thoughts", topic_shopping: "Shopping",

                sort_new: "Sort: Newest", sort_prog: "Sort: Progress",

                // ğŸŸ¢ æ–°å¢ï¼šä¸ªäººä¸­å¿ƒè¯æ¡
                p_role: "HSK 4 Student",
                p_status_label: "Membership",
                p_active: "Active",
                p_expire_label: "Expires",
                p_sync: "Sync Learning Progress to Cloud",
                p_password: "Change Password",
                sidebar_batch: "Seasons",
                batch_s1: "Season 1ï¼ˆ20/120ï¼‰",
                batch_s2: "Season 2ï¼ˆ-)",
                status_lock: "Locked",
                msg_lock: "This course is locked. Please contact the teacher to unlock!",
                menu_rules: "âš ï¸Rules & Tipsâš ï¸", // ğŸŸ¢ æ–°å¢
                p_sync: "Sync to Cloud",
                p_download: "Restore from Cloud", 
                batch_s3: "201-300 (New)",
                batch_drama: "TV Series",
                batch_talk_show: "Stand-upï¼ˆ9/30ï¼‰",
                topic_fashion: "Fashion",
                topic_travel: "Travel",
                topic_beauty: "Beauty",
                topic_sports: "Sports",
                topic_study: "Study",
                menu_tools: "Learning Tools",
            },
            cn: {
                // åŸæœ‰è¯æ¡
                my_data: "æˆ‘çš„å­¦ä¹ æ•°æ®", days: "å¤©æ•°", hours: "æ—¶é•¿", videos: "å·²çœ‹", vocab: "è¯æ±‡",
                heatmap: "å­¦ä¹ çƒ­åŠ›å›¾", today: "ä»Šå¤©",
                menu_records: "å­¦ä¹ è®°å½•", menu_all: "å…¨éƒ¨è¯¾ç¨‹", menu_fav: "æˆ‘çš„æ”¶è—", menu_done: "å·²å®Œæˆ", menu_review: "è‰¾å®¾æµ©æ–¯å¤ä¹ ", menu_account: "è´¦æˆ·", menu_profile: "ä¸ªäººä¸­å¿ƒ", menu_logout: "é€€å‡ºç™»å½•",
                video_lib: "è§†é¢‘å†…å®¹å±•ç¤º", filter_level: "éš¾åº¦:", filter_topic: "ä¸»é¢˜:",
                status_done: "å·²å®Œæˆ", status_watch: "å·²çœ‹", status_new: "æœªå¼€å§‹", review: "éœ€å¤ä¹ ",
                topic_job: "èŒåœº", topic_life: "ç”Ÿæ´»", topic_food: "ç¾é£Ÿ", topic_culture: "æ–‡åŒ–", topic_thoughts: "æ„Ÿæƒ³", topic_shopping: "è´­ç‰©",
                sort_new: "æ’åºï¼šæœ€æ–°", sort_prog: "æ’åºï¼šè¿›åº¦",
               

                // ğŸŸ¢ æ–°å¢ï¼šä¸ªäººä¸­å¿ƒè¯æ¡
                p_role: "HSK 4 å­¦ä¹ è€…",
                p_status_label: "ä¼šå‘˜çŠ¶æ€",
                p_active: "ç”Ÿæ•ˆä¸­",
                p_expire_label: "åˆ°æœŸæ—¶é—´",
                p_sync: "åŒæ­¥è¿›åº¦åˆ°äº‘ç«¯",
                p_password: "ä¿®æ”¹å¯†ç ",
                sidebar_batch: "æŒ‰æœŸæ•°æµè§ˆ",
                batch_s1: "ç¬¬ä¸€å­£ï¼ˆ20/120ï¼‰",
                batch_s2: "ç¬¬äºŒå­£ï¼ˆ-ï¼‰",
                status_lock: "éœ€è§£é”",
                msg_lock: "ğŸ”’ è¯¥è¯¾ç¨‹éœ€è¦è§£é”ï¼Œè¯·è”ç³»è€å¸ˆè´­ä¹°ï¼",
                menu_rules: "âš ï¸ä½¿ç”¨é¡»çŸ¥âš ï¸", // ğŸŸ¢ æ–°å¢
                p_sync: "åŒæ­¥è¿›åº¦åˆ°äº‘ç«¯",
                p_download: "ä»äº‘ç«¯æ¢å¤è¿›åº¦", 
                batch_s3: "ç¬¬ä¸‰å­£ï¼ˆ-ï¼‰",
                batch_drama: "ç”µè§†å‰§",
                batch_talk_show: "è„±å£ç§€ï¼ˆ9/30ï¼‰",
                topic_fashion: "ç©¿æ­",
                topic_travel: "æ—…è¡Œ",
                topic_beauty: "ç¾å¦†æŠ¤è‚¤",
                topic_sports: "è¿åŠ¨",
                topic_study: "å­¦ä¹ ",
                menu_tools: "å­¦ä¹ å·¥å…·",
            }
        };

        // === 4. åŠŸèƒ½å‡½æ•° ===
        function toggleLang() {
            if (currentLang === 'ru') currentLang = 'en'; else if (currentLang === 'en') currentLang = 'cn'; else currentLang = 'ru';
            updateLanguage();
        }

        function updateLanguage() {
            let label = 'ğŸ‡·ğŸ‡º RU'; if (currentLang === 'en') label = 'ğŸ‡ºğŸ‡¸ EN'; if (currentLang === 'cn') label = 'ğŸ‡¨ğŸ‡³ CN';
            document.getElementById('langLabel').innerText = label;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (uiDict[currentLang][key]) el.innerText = uiDict[currentLang][key];
            });
            
            const sortSel = document.getElementById('sortSelect');
            if(sortSel && sortSel.options.length>0) {
                 sortSel.options[0].text = uiDict[currentLang].sort_new;
                 sortSel.options[1].text = uiDict[currentLang].sort_prog;
            }

            renderVideos(getFilteredVideos());
        }

        // === ğŸŸ¢ å•†ä¸šç‰ˆï¼šå¸¦é”çš„è§†é¢‘æ¸²æŸ“ ===
        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šæ˜¾ç¤º HSK å’Œ ä½œè€… ===
        function renderVideos(videos) {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = ''; 
            
            if (videos.length === 0) {
                grid.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è§†é¢‘</div>';
                return;
            }

            let userAccess = [];
            try {
                userAccess = JSON.parse(localStorage.getItem('my_access_tags') || '["season_1"]');
            } catch (e) { userAccess = ["season_1"]; }
            
            videos.forEach(v => {
                const isLocked = v.batch && !userAccess.includes(v.batch);
                
                // è¿›åº¦æ¡é€»è¾‘
                const savedProgress = localStorage.getItem('progress_' + v.id);
                if (savedProgress) v.progress = parseInt(savedProgress);
                const savedDone = localStorage.getItem('done_' + v.id);
                if (savedDone === 'true') { v.isDone = true; v.progress = 100; }

                // æ ·å¼å¤„ç†
                let coverStyle = v.cover ? `background-image: url('${v.cover}');` : `background-color: #ddd;`;
                let topicKey = 'topic_' + (v.topic || 'life'); // æš‚æ—¶ç”¨é»˜è®¤
                let topicLabel = v.topic || "Topic"; // ç›´æ¥æ˜¾ç¤ºåŸæ•°æ®ï¼Œæˆ–è€…ä½ å¯ä»¥å»å­—å…¸é‡ŒæŸ¥

                let cardClickAction = `location.href='index.html?id=${v.id}'`;
                let statusHtml = ''; 
                let lockOverlay = '';

                if (isLocked) {
                    coverStyle += 'filter: grayscale(100%);'; 
                    lockOverlay = `<div style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; color:white; font-size:40px;"><i class="fas fa-lock"></i></div>`;
                    cardClickAction = `alert('ğŸ”’ è¯¥è¯¾ç¨‹éœ€è¦è§£é” (éœ€è´­ä¹° ${v.batch})')`;
                    statusHtml = `<span style="color:#666"><i class="fas fa-lock"></i> éœ€è§£é”</span>`;
                } else {
                    if (v.isDone) statusHtml = `<span class="status-text done"><i class="fas fa-check-circle"></i> å·²å®Œæˆ</span>`;
                    else if (v.progress > 0) statusHtml = `<span class="status-text watching"><i class="far fa-clock"></i> è§‚çœ‹è‡³ ${v.progress}%</span>`;
                    else statusHtml = `<span class="status-text" style="color:#999">æœªå¼€å§‹</span>`;
                }

                // ğŸŸ¢ é‡ç‚¹ä¿®æ”¹äº†è¿™é‡Œçš„ HTML ç»“æ„
                const html = `
                <div class="card" onclick="${cardClickAction}">
                    <div class="card-cover" style="${coverStyle}">
                        ${lockOverlay}
                        ${!isLocked ? `<div class="duration-tag">${v.duration || '00:00'}</div>` : ''}
                        ${!isLocked ? `<div class="fav-btn ${v.isFav ? 'active' : ''}" onclick="toggleFav(${v.id}, this, event)"><i class="fas fa-heart"></i></div>` : ''}
                    </div>
                    <div class="card-body">
                        <div>
                            <!-- ğŸ‘‡ æ–°å¢ï¼šä½œè€…å’Œç­‰çº§æ ‡ç­¾ -->
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                <span style="font-size:11px; background:#f3f4f6; color:#666; padding:2px 6px; border-radius:4px; font-weight:bold;">
                                    ${v.hsk || 'HSK?'}
                                </span>
                                <span style="font-size:11px; color:#999;">
                                    <i class="fas fa-user"></i> ${v.author || 'Vlogger'}
                                </span>
                            </div>
                            <!-- ğŸ‘† æ–°å¢ç»“æŸ -->

                            <div class="card-title" style="${isLocked ? 'color:#999' : ''}">${v.title}</div>
                            <div class="status-row">${statusHtml}</div>
                            <div class="card-desc">${v.desc}</div>
                        </div>
                        <div class="card-footer">
                            <div class="tag-row">
                                <span class="pill-tag">${v.batch || 'å…è´¹'}</span>
                                <span class="pill-tag pill-topic">${topicLabel}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
                grid.innerHTML += html;
            });
        }

        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šç­›é€‰é€»è¾‘ ===
        
        // 1. ç‚¹å‡»æŒ‰é’®è§¦å‘
        function applyFilter(type, value, btn) {
            // UI åˆ‡æ¢ï¼šæŠŠåŒç»„çš„å…¶ä»–æŒ‰é’®æ ·å¼å»æ‰ï¼Œç»™è‡ªå·±åŠ ä¸Š
            const group = btn.parentElement;
            group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // é€»è¾‘æ›´æ–°
            currentFilters[type] = value;
            
            // ç«‹å³é‡æ–°æ¸²æŸ“
            const result = getFilteredVideos();
            renderVideos(result);
        }

        // === å‡çº§ç‰ˆï¼šæ”¯æŒåˆ†æœŸç­›é€‰ ===
        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šæ”¯æŒä¸­è‹±æ–‡+è¡¨æƒ…åŒ…çš„æ¨¡ç³ŠåŒ¹é… ===
        function getFilteredVideos() {
            // ğŸŸ¢ 1. å»ºç«‹â€œè¿‘ä¹‰è¯â€æ˜ å°„è¡¨ (è®© job èƒ½æœåˆ° å·¥ä½œ)
            // æ³¨æ„ï¼šè¿™é‡Œå·¦è¾¹çš„ key å¿…é¡»å’ŒæŒ‰é’®ä¸Šçš„ data-val ä¸€è‡´ (å°å†™)
            const topicMap = {
                'job': ['job', 'work', 'å·¥ä½œ', 'èŒåœº', 'career'],
                'life': ['life', 'daily', 'ç”Ÿæ´»', 'æ—¥å¸¸', 'vlog'],
                'food': ['food', 'cooking', 'é£Ÿç‰©', 'ç¾é£Ÿ', 'åšé¥­', 'è¶…å¸‚'],
                'culture': ['culture', 'history', 'æ–‡åŒ–', 'ä¼ ç»Ÿ'],
                'thoughts': ['thoughts', 'thinking', 'æ„Ÿæƒ³', 'è§‚ç‚¹', 'èŠå¤©'],
                'shopping': ['shopping', 'buy', 'è´­ç‰©', 'ä¹°ä¸œè¥¿', 'ğŸ›ï¸'],
                'fashion': ['fashion', 'outfit', 'clothes', 'ç©¿æ­', 'è¡£æœ', 'OOTD', 'ğŸ‘—'],
                'travel': ['travel', 'trip', 'tour', 'æ—…è¡Œ', 'æ—…æ¸¸', 'å»å“ªç©', 'âœˆï¸'],
                'beauty': ['beauty', 'makeup', 'skincare', 'æŠ¤è‚¤', 'åŒ–å¦†', 'ç¾å¦†', 'ğŸ’„'],
                'sports': ['sports', 'gym', 'exercise', 'è¿åŠ¨', 'å¥èº«', 'å‡è‚¥', 'âš½ï¸'],
                'study': ['study', 'learn', 'å­¦ä¹ ', 'ä¸­æ–‡', 'è€ƒè¯•', 'ğŸ“š']
            };

            return allVideos.filter(v => {
                // æœç´¢æ¡†é€»è¾‘
                if (currentFilters.search && !v.searchStr.includes(currentFilters.search)) return false;
                
                // HSK é€»è¾‘
                if (currentFilters.hsk !== 'all') {
                    const dataLevel = (v.hsk || '').toLowerCase().replace(/\s/g, ''); 
                    const filterLevel = currentFilters.hsk.toLowerCase().replace(/\s/g, ''); 
                    if (currentFilters.hsk === 'HSK 6+') { 
                        if (dataLevel !== 'hsk6' && dataLevel !== 'hsk6+') return false; 
                    } else { 
                        if (dataLevel !== filterLevel) return false; 
                    }
                }

                // ğŸŸ¢ Topic ç­›é€‰é€»è¾‘ (ä½¿ç”¨æ˜ å°„è¡¨)
                if (currentFilters.topic !== 'all') {
                    const videoTopic = (v.topic || '').toLowerCase(); // è§†é¢‘æ•°æ®çš„ topic è½¬å°å†™
                    const btnKey = currentFilters.topic.toLowerCase(); // æŒ‰é’®çš„å€¼è½¬å°å†™
                    
                    // æ‹¿å‡ºè¿™ä¸ªæŒ‰é’®å¯¹åº”çš„æ‰€æœ‰åŒä¹‰è¯
                    const keywords = topicMap[btnKey] || [btnKey];
                    
                    // åªè¦è§†é¢‘ topic åŒ…å«ä»»æ„ä¸€ä¸ªå…³é”®è¯ï¼Œå°±é€šè¿‡
                    const isMatch = keywords.some(k => videoTopic.includes(k.toLowerCase()));
                    
                    if (!isMatch) return false;
                }
                
                // å…¶ä»–é€»è¾‘
                if (currentFilters.menu === 'fav' && !v.isFav) return false;
                if (currentFilters.menu === 'done' && !v.isDone) return false;
                if (currentFilters.batch !== 'all' && v.batch !== currentFilters.batch) return false;

                return true;
            });
        }
        
        function searchVideo(val) { currentFilters.search = val.toLowerCase(); renderVideos(getFilteredVideos()); }
        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šèœå•ç­›é€‰ (é‡ç½®æ‰€æœ‰æ¡ä»¶) ===
        function filterByMenu(type, btn) {
            // 1. æ ·å¼åˆ‡æ¢
            document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentFilters.menu = type;
            
            // 2. å¦‚æœç‚¹å‡»çš„æ˜¯â€œå…¨éƒ¨è¯¾ç¨‹â€ï¼Œå¿…é¡»é‡ç½®æ‰€æœ‰ç»†åˆ†ç­›é€‰
            if(type === 'all') {
                currentFilters.hsk = 'all'; 
                currentFilters.topic = 'all';
                currentFilters.batch = 'all'; // ğŸŸ¢ å…³é”®ï¼æŠŠåˆ†æœŸä¹Ÿé‡ç½®å› "all"
                
                // é‡ç½®é¡¶éƒ¨çš„ç­›é€‰æŒ‰é’®æ ·å¼
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                // è®©æ¯ç»„çš„ç¬¬ä¸€ä¸ªæŒ‰é’®å˜äº® (All)
                const firstBtns = document.querySelectorAll('.filter-group .filter-btn:first-child');
                firstBtns.forEach(b => b.classList.add('active'));
            }
            
            renderVideos(getFilteredVideos());
        }
        function filterByBatch(batchName, btn) {
        // 1. UI å˜è‰²
        // å…ˆæŠŠæ‰€æœ‰ menu-item çš„æ¿€æ´»çŠ¶æ€å»æ‰
        document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
        // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®åŠ ä¸Šæ¿€æ´»çŠ¶æ€
        btn.classList.add('active');

        // 2. é‡ç½®å…¶ä»–å¤§ç±»ç­›é€‰ï¼Œé¿å…å†²çª (å¯é€‰)
        currentFilters.menu = 'all'; 

        // 3. è®¾å®šåˆ†æœŸ
        currentFilters.batch = batchName;

        // 4. åˆ·æ–°è§†é¢‘åˆ—è¡¨
        renderVideos(getFilteredVideos());
    }
        function sortVideos(sortType) {
            let result = getFilteredVideos();
            if (sortType === 'new') result.sort((a, b) => new Date(b.date) - new Date(a.date));
            else if (sortType === 'progress') result.sort((a, b) => b.progress - a.progress);
            renderVideos(result); 
        }
        function toggleFav(id, btn, event) {
            event.stopPropagation();
            const video = allVideos.find(v => v.id == id);
            if (video) { video.isFav = !video.isFav; if (video.isFav) btn.classList.add('active'); else btn.classList.remove('active'); }
        }
        // === ä¾§è¾¹æ å¼€å…³ (æ‰‹æœº/ç”µè„‘è‡ªåŠ¨è¯†åˆ«) ===
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            
            // åˆ¤æ–­å±å¹•å®½åº¦
            if (window.innerWidth <= 768) {
                // ğŸ“± æ‰‹æœºç«¯ï¼šåˆ‡æ¢ mobile-open ç±» (æ»‘å‡º/æ»‘å…¥)
                // è¿˜è¦å¼ºåˆ¶ç§»é™¤ collapsed é˜²æ­¢å†²çª
                sidebar.classList.remove('collapsed');
                sidebar.classList.toggle('mobile-open');
                
                // ç‚¹å‡»é®ç½©å±‚å…³é—­é€»è¾‘ (å¯é€‰ä¼˜åŒ–)
                // å¦‚æœæ‰“å¼€äº†ï¼Œç‚¹å‡»å†…å®¹åŒºåº”è¯¥èƒ½å…³é—­ (ç®€å•èµ·è§å…ˆä¸åš)
            } else {
                // ğŸ’» ç”µè„‘ç«¯ï¼šåˆ‡æ¢ collapsed ç±» (æŠ˜å /å±•å¼€)
                sidebar.classList.remove('mobile-open');
                sidebar.classList.toggle('collapsed');
            }
        }

        // === ğŸŸ¢ ä¿®å¤ç‰ˆï¼šåªæ˜¾ç¤ºçœŸå®æ´»è·ƒåº¦ ===
        function renderMonthCalendar() {
            const container = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('currentMonthStr');
            if(!container || !monthLabel) return;
            container.innerHTML = ''; 

            const now = new Date();
            const year = now.getFullYear(); 
            const month = now.getMonth(); 
            monthLabel.innerText = `${year}.${month + 1}`;

            const studyDates = JSON.parse(localStorage.getItem('my_study_days') || '[]');
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div'); 
                empty.style.visibility = 'hidden'; 
                container.appendChild(empty);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                let level = 0;
                
                // ğŸŸ¢ ä¿®å¤ï¼šä½¿ç”¨å’Œä¿å­˜æ—¶å®Œå…¨ä¸€æ ·çš„æ‹¼è£…é€»è¾‘
                const checkDate = `${year}-${month + 1}-${day}`;
                
                if (studyDates.includes(checkDate)) {
                    level = 3; 
                }

                div.className = `cal-day lvl-${level}`; 
                div.innerText = day; 
                div.setAttribute('data-date', `${month+1}æœˆ${day}æ—¥`);
                // æ¢å¤ä½ çš„æç¤ºæ¡†
                if(level===3) div.setAttribute('data-tip', 'å·²æ‰“å¡'); 
                
                container.appendChild(div);
            }
        }
        
        // === ğŸŸ¢ æš´åŠ›å¼ºåˆ¶é€€å‡ºå‡½æ•° (ä¸ä¾èµ– auth.js) ===
        function forceLogout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
                console.log("æ‰§è¡Œå¼ºåˆ¶é€€å‡º...");
                
                // 1. æ¸…ç©ºæ‰€æœ‰æœ¬åœ°å­˜å‚¨ (åŒ…æ‹¬ Supabase çš„ä»¤ç‰Œå’Œä½ çš„å­¦ä¹ è¿›åº¦ç¼“å­˜)
                // å¦‚æœä½ æƒ³ä¿ç•™å­¦ä¹ è¿›åº¦ï¼Œåªæ¸…ç©º Supabase ç›¸å…³çš„ key ä¹Ÿå¯ä»¥ï¼Œ
                // ä½†ä¸ºäº†å®‰å…¨ï¼Œå…¨éƒ¨æ¸…ç©ºæœ€ç¨³å¦¥ã€‚æˆ–è€…åªæ¸…ç©º sessionã€‚
                localStorage.removeItem('sb-tcrayyqmozfqrfagvusp-auth-token'); // æ¸…é™¤ Supabase token
                localStorage.removeItem('my_session_token'); // æ¸…é™¤äº’è¸¢ token
                sessionStorage.clear(); // æ¸…é™¤ä¼šè¯
                
                // 2. å¼ºåˆ¶è·³è½¬
                alert("å·²é€€å‡ºè´¦å·");
                window.location.href = 'login.html';
            }
        }

        // === ğŸŸ¢ å•†ä¸šæ ¸å¿ƒï¼šä»äº‘ç«¯è·å–ç”¨æˆ·çš„è´­ä¹°æƒé™ ===
async function updateUserAccess() {
    if (!supabaseClient) return;
    
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return; 

    try {
        // å» profiles è¡¨æŸ¥ access_tags
        const { data, error } = await supabaseClient
            .from('profiles') 
            .select('access_tags')
            .eq('id', user.id)
            .maybeSingle();

        if (error) throw error;

        if (data && data.access_tags) {
            // æ‹¿åˆ°æƒé™åˆ—è¡¨ (æ¯”å¦‚ ['season_1', 'season_2'])
            const tags = data.access_tags;
            
            // å­˜å…¥æœ¬åœ°ï¼Œä¾›æ¸²æŸ“ä½¿ç”¨
            localStorage.setItem('my_access_tags', JSON.stringify(tags));
            
            console.log("âœ… æƒé™å·²æ›´æ–°:", tags);
            
            // ç«‹å³åˆ·æ–°è§†é¢‘åˆ—è¡¨ï¼ˆæŠŠåˆšè§£é”çš„é”å¤´å»æ‰ï¼‰
            if (typeof renderVideos === 'function' && typeof getFilteredVideos === 'function') {
                renderVideos(getFilteredVideos());
            }
        }
    } catch (e) {
        console.error("æ— æ³•è·å–æƒé™:", e);
    }
}

    </script>
</body>
</html>
