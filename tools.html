<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­ Vlog | å­¦ä¹ å·¥å…·ç®±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- å¼•å…¥æ‹¼éŸ³åº“ -->
    <script src="https://unpkg.com/pinyin-pro"></script>
    <!-- å¼•å…¥ Supabase (ä¿æŒç™»å½•çŠ¶æ€ç”¨) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>

    <style>
        :root { 
            --primary: #6CAD9C; 
            --bg: #F9F7F2; 
            --white: #FFFFFF; 
            --text: #4A3B32; 
            --gray: #9ca3af; 
            --cream: #f2ecde;
            --accent-red: #d16b5b; /* å£°è°ƒé¢œè‰² */
        }
        body { margin: 0; font-family: "PingFang SC", sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* === å·¦ä¾§è¾¹æ  === */
        .sidebar { width: 240px; background: var(--white); border-right: 1px solid #eee; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .logo { font-size: 18px; font-weight: 800; color: #8B3A3A; margin-bottom: 30px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        
        .tool-nav-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 15px; 
            border-radius: 10px; cursor: pointer; color: #666; margin-bottom: 8px; transition: 0.2s; font-size: 14px;
        }
        .tool-nav-item:hover { background: #fdfdfd; color: var(--primary); }
        .tool-nav-item.active { background: var(--cream); color: #8B3A3A; font-weight: bold; }
        .badge-new { background: #ff4757; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: auto; }

        /* === å³ä¾§ä¸»å†…å®¹ === */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        /* è¯­è¨€åˆ‡æ¢ (å³ä¸Šè§’) */
        .lang-switch-box {
            position: absolute; top: 30px; right: 40px; z-index: 10;
            display: flex; gap: 5px; background: #eee; padding: 4px; border-radius: 20px;
        }
        .lang-btn {
            font-size: 12px; padding: 4px 10px; border-radius: 15px; cursor: pointer; color: #666; font-weight: bold; transition: all 0.2s;
        }
        .lang-btn.active { background: var(--white); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å·¥å…·å®¹å™¨ */
        .tool-container { 
            background: white; border-radius: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
            border: 1px solid #eee; margin-top: 40px; /* ç•™å‡ºè¯­è¨€æ ä½ç½® */
        }

        /* --- æ‹¼éŸ³åŠ©æ‰‹ç‰¹å®šæ ·å¼ --- */
        .pinyin-header {
            padding: 15px 25px; border-bottom: 1px solid #eee; background: #fffbf5;
            display: flex; justify-content: space-between; align-items: center;
        }
        .mode-switch { display: flex; gap: 15px; }
        .mode-switch label { cursor: pointer; font-size: 14px; color: #888; display: flex; align-items: center; gap: 5px; }
        .mode-switch input:checked + span { color: var(--primary); font-weight: bold; }

        /* å±•ç¤ºåŒºåŸŸ */
        .display-area {
            flex: 1; padding: 30px; overflow-y: auto; font-size: 24px; line-height: 1.8;
            font-family: "KaiTi", "æ¥·ä½“", serif; white-space: pre-wrap; color: #333;
            outline: none; /* å»æ‰ç¼–è¾‘æ—¶çš„è“æ¡† */
            scroll-behavior: smooth;
        }
        
        /* æ‹¼éŸ³æ¨¡å¼ */
        .mode-pinyin .py-text { color: #8B3A3A; margin-left: 8px; font-size: 0.8em; }

        /* å£°è°ƒæ¨¡å¼ */
        .mode-tone { display: flex; flex-wrap: wrap; align-content: flex-start; gap: 10px 0; }
        .char-box { display: inline-flex; flex-direction: column; align-items: center; justify-content: flex-end; margin: 0 2px; min-width: 30px; }
        .tone-mark { font-family: Arial, sans-serif; font-size: 20px; color: var(--accent-red); height: 26px; line-height: 26px; font-weight: bold; text-align: center; }
        .hanzi-text { font-size: 32px; line-height: 1.2; }
        .break-line { width: 100%; height: 0; margin: 5px 0; }

        /* è¾“å…¥åŒº */
        .input-area {
            height: 140px; padding: 20px; background: #f9f9f9; border-top: 1px solid #eee;
            display: flex; gap: 15px;
        }
        textarea {
            flex: 1; border: 1px solid #ddd; border-radius: 10px; padding: 15px;
            resize: none; outline: none; font-size: 16px; font-family: inherit;
        }
        textarea:focus { border-color: var(--primary); background: white; }
        
        .action-btns { display: flex; flex-direction: column; gap: 10px; width: 100px; }
        .btn-tool {
            border: none; padding: 0; border-radius: 8px; cursor: pointer; color: white; font-weight: bold;
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 14px;
        }
        .btn-copy { background: var(--primary); }
        .btn-clear { background: #e5e7eb; color: #666; }
        .btn-tool:hover { opacity: 0.9; transform: translateY(-1px); }

        /* éšè—çš„å·¥å…·æ¨¡å— */
        .tool-module { display: none; height: 100%; flex-direction: column; }
        .tool-module.active { display: flex; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { 
                width: 100%; height: auto; flex-direction: row; padding: 10px; 
                overflow-x: auto; border-bottom: 1px solid #eee; border-right: none;
            }
            .logo { display: none; }
            .lang-switch-box { top: 10px; right: 10px; }
            .tool-container { margin-top: 40px; } 
        }
    </style>
</head>
<body>

    <!-- 1. ä¾§è¾¹æ èœå• -->
    <div class="sidebar">
        <div class="logo" onclick="location.href='home.html'">
            <i class="fas fa-chevron-left"></i> <span data-i18n="back_home">è¿”å›é¦–é¡µ</span>
        </div>
        
        <!-- æŒ‰é’® A: æ‹¼éŸ³åŠ©æ‰‹ (é»˜è®¤é€‰ä¸­) -->
        <div class="tool-nav-item active" onclick="switchTool('pinyin', this)">
            <i class="fas fa-font"></i> <span data-i18n="tool_pinyin">æ‹¼éŸ³åŠ©æ‰‹</span>
        </div>

        <!-- æŒ‰é’® C: æ›´å¤š -->
        <div class="tool-nav-item" onclick="alert('Coming Soon...')">
            <i class="fas fa-plus-circle"></i> <span data-i18n="tool_more">æ›´å¤šå·¥å…·</span>
        </div>
    </div>

    <!-- 2. ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        
        <!-- è¯­è¨€åˆ‡æ¢ -->
        <div class="lang-switch-box">
            <div class="lang-btn active" onclick="setLang('cn', this)">ä¸­</div>
            <div class="lang-btn" onclick="setLang('en', this)">En</div>
            <div class="lang-btn" onclick="setLang('ru', this)">Ru</div>
        </div>

        <!-- A: æ‹¼éŸ³åŠ©æ‰‹ -->
        <div id="tool-pinyin" class="tool-container tool-module active">
            <div class="pinyin-header">
                <div style="font-weight:bold; color:#555;" data-i18n="pinyin_title">ğŸ› ï¸ æ±‰å­—è½¬æ‹¼éŸ³/å£°è°ƒ</div>
                <div class="mode-switch">
                    <label>
                        <input type="radio" name="mode" value="pinyin" checked onchange="updateDisplay()"> 
                        <span data-i18n="mode_py">ğŸ“– æ‹¼éŸ³æ¨¡å¼</span>
                    </label>
                    <label>
                        <input type="radio" name="mode" value="tone" onchange="updateDisplay()"> 
                        <span data-i18n="mode_tone">ğŸ¼ å£°è°ƒæ¨¡å¼</span>
                    </label>
                </div>
            </div>
            
            <div id="display" class="display-area mode-pinyin" contenteditable="true" spellcheck="false"></div>

            <div class="input-area">
                <textarea id="input" placeholder="..." oninput="updateDisplay()"></textarea>
                <div class="action-btns">
                    <button class="btn-tool btn-copy" onclick="copyResult()">
                        <i class="far fa-copy"></i> <span data-i18n="btn_copy">å¤åˆ¶</span>
                    </button>
                    <button class="btn-tool btn-clear" onclick="clearAll()">
                        <i class="fas fa-eraser"></i> <span data-i18n="btn_clear">æ¸…ç©º</span>
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // === 1. å¤šè¯­è¨€å­—å…¸ ===
        const uiDict = {
            cn: {
                back_home: "è¿”å›é¦–é¡µ", tool_pinyin: "æ‹¼éŸ³åŠ©æ‰‹", tool_more: "æ›´å¤šå·¥å…·",
                pinyin_title: "ğŸ› ï¸ æ±‰å­—è½¬æ‹¼éŸ³/å£°è°ƒ", mode_py: "ğŸ“– æ‹¼éŸ³æ¨¡å¼", mode_tone: "ğŸ¼ å£°è°ƒæ¨¡å¼",
                btn_copy: "å¤åˆ¶ç»“æœ", btn_clear: "æ¸…ç©º",
                input_ph: "è¯·åœ¨æ­¤è¾“å…¥æ±‰å­—...", copy_ok: "âœ… å†…å®¹å·²å¤åˆ¶ï¼"
            },
            en: {
                back_home: "Back Home", tool_pinyin: "Pinyin Helper", tool_more: "More",
                pinyin_title: "ğŸ› ï¸ Hanzi to Pinyin/Tone", mode_py: "ğŸ“– Pinyin Mode", mode_tone: "ğŸ¼ Tone Mode",
                btn_copy: "Copy", btn_clear: "Clear",
                input_ph: "Type Chinese here...", copy_ok: "âœ… Copied!"
            },
            ru: {
                back_home: "ĞĞ° Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ", tool_pinyin: "ĞŸĞ¸Ğ½ÑŒĞ¸Ğ½ÑŒ", tool_more: "Ğ•Ñ‰Ñ‘",
                pinyin_title: "ğŸ› ï¸ Ğ¥Ğ°Ğ½Ğ·Ğ¸ Ğ² ĞŸĞ¸Ğ½ÑŒĞ¸Ğ½ÑŒ", mode_py: "ğŸ“– Ğ¢ĞµĞºÑÑ‚", mode_tone: "ğŸ¼ Ğ¢Ğ¾Ğ½Ñ‹",
                btn_copy: "ĞšĞ¾Ğ¿Ğ¸Ñ", btn_clear: "Ğ¡Ğ±Ñ€Ğ¾Ñ",
                input_ph: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¸Ñ‚Ğ°Ğ¹ÑĞºĞ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚...", copy_ok: "âœ… Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾!"
            }
        };

        let curLang = 'cn';

        function setLang(lang, btn) {
            curLang = lang;
            // æŒ‰é’®å˜è‰²
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // æ–‡å­—æ›¿æ¢
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(uiDict[lang][key]) el.innerText = uiDict[lang][key];
            });

            // æ›¿æ¢ placeholder
            document.getElementById('input').placeholder = uiDict[lang].input_ph;
        }

        function switchTool(toolId, btn) {
            document.querySelectorAll('.tool-nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tool-module').forEach(el => el.classList.remove('active'));
            document.getElementById('tool-' + toolId).classList.add('active');
        }

        // === 2. æ‹¼éŸ³æ ¸å¿ƒé€»è¾‘ ===
        const input = document.getElementById('input');
        const display = document.getElementById('display');
        let currentMode = 'pinyin';
        const toneMap = { 1: 'Ë‰', 2: 'ËŠ', 3: 'Ë‡', 4: 'Ë‹', 5: 'Ë™', 0: 'Ë™' };

        function updateDisplay() {
            if (typeof pinyinPro === 'undefined') return;
            const { pinyin } = pinyinPro;

            // è·å–å½“å‰æ¨¡å¼
            const modes = document.getElementsByName('mode');
            for(let m of modes) { if(m.checked) currentMode = m.value; }

            // åˆ‡æ¢ CSS ç±»åä»¥é€‚é…ä¸åŒæ’ç‰ˆ
            display.className = "display-area " + (currentMode === 'pinyin' ? 'mode-pinyin' : 'mode-tone');

            const text = input.value;
            if (!text) { display.innerHTML = ''; return; }

            if (currentMode === 'pinyin') {
                // æ¨¡å¼ A: æ±‰å­— + æ‹¼éŸ³ (æµå¼æ–‡æœ¬)
                const lines = text.split('\n');
                const processedLines = lines.map(line => {
                    if (!line.trim()) return "";
                    const py = pinyin(line, { toneType: 'symbol', type: 'string', nonZh: 'spaced' });
                    return line + " <span class='py-text'>" + py + "</span>"; 
                });
                display.innerHTML = processedLines.join('\n');
            } else {
                // æ¨¡å¼ B: æ±‰å­—ä¸Šæ–¹æ ‡å£°è°ƒ (æ–¹å—å¸ƒå±€)
                let html = '';
                const lines = text.split('\n');
                lines.forEach((line) => {
                    if (!line) { html += '<div class="break-line"></div>'; return; }
                    const chars = line.split('');
                    chars.forEach(char => {
                        if (/[\u4e00-\u9fa5]/.test(char)) {
                            let toneSymbol = '&nbsp;'; 
                            try {
                                // è·å–å£°è°ƒæ•°å­— (1-4)
                                const pyArr = pinyin(char, { pattern: 'num', type: 'array' });
                                if (pyArr && pyArr.length > 0) {
                                    const toneNum = parseInt(pyArr[0].slice(-1));
                                    if(!isNaN(toneNum)) toneSymbol = toneMap[toneNum] || 'Ë™';
                                    else toneSymbol = 'Ë™';
                                }
                            } catch(e) {}
                            html += `<div class="char-box"><div class="tone-mark">${toneSymbol}</div><div class="hanzi-text">${char}</div></div>`;
                        } else {
                            // æ ‡ç‚¹ç¬¦å·
                            html += `<div class="char-box"><div class="tone-mark">&nbsp;</div><div class="hanzi-text">${char}</div></div>`;
                        }
                    });
                    html += '<div class="break-line"></div>';
                });
                display.innerHTML = html;
            }

            // ğŸŸ¢ è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                display.scrollTop = display.scrollHeight;
            }, 50);
        }

        // === 3. æ™ºèƒ½å¤åˆ¶é€»è¾‘ ===
        function copyResult() {
            if(!input.value) return;
            const { pinyin } = pinyinPro;

            // æƒ…å†µ A: æ‹¼éŸ³æ¨¡å¼ -> ç›´æ¥å¤åˆ¶ç½‘é¡µä¸Šçœ‹åˆ°çš„ (åŒ…å«ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹è¿‡çš„)
            if (currentMode === 'pinyin') {
                const textToCopy = display.innerText;
                navigator.clipboard.writeText(textToCopy).then(() => alert(uiDict[curLang].copy_ok));
                return;
            }

            // æƒ…å†µ B: å£°è°ƒæ¨¡å¼ -> è‡ªåŠ¨é‡ç»„ä¸º"ä¸¤è¡Œæ ¼å¼" (æ–¹ä¾¿ç²˜è´´åˆ° PPT)
            if (currentMode === 'tone') {
                let finalString = "";
                const lines = input.value.split('\n');

                lines.forEach(line => {
                    if (!line.trim()) { finalString += "\n"; return; }
                    
                    let toneLine = "";
                    let charLine = "";
                    const chars = line.split('');

                    chars.forEach(char => {
                        // æ±‰å­—è¡Œï¼šæ¯ä¸ªå­—åé¢åŠ ä¸ªç©ºæ ¼ï¼Œä¸ºäº†è§†è§‰å¯¹é½
                        charLine += char + " "; 
                        
                        let toneSymbol = " "; 
                        if (/[\u4e00-\u9fa5]/.test(char)) {
                             try {
                                const pyArr = pinyin(char, { pattern: 'num', type: 'array' });
                                if (pyArr && pyArr.length > 0) {
                                    const toneNum = parseInt(pyArr[0].slice(-1));
                                    // æ‰¾åˆ°å¯¹åº”çš„ç¬¦å·
                                    toneSymbol = toneMap[toneNum] || 'Ë™';
                                } else { toneSymbol = 'Ë™'; }
                            } catch(e) {}
                        }
                        // å£°è°ƒè¡Œï¼šç¬¦å·åé¢ä¹ŸåŠ ç©ºæ ¼
                        toneLine += toneSymbol + " "; 
                    });

                    // æ‹¼è£…ï¼šå£°è°ƒè¡Œ + æ¢è¡Œ + æ±‰å­—è¡Œ + æ¢è¡Œ
                    finalString += toneLine.trimEnd() + "\n" + charLine.trimEnd() + "\n";
                });

                navigator.clipboard.writeText(finalString).then(() => {
                    let tip = curLang === 'en' ? "Copied 2-line format!" : "å·²å¤åˆ¶åŒè¡Œæ ¼å¼ (å¯ç›´æ¥ç²˜è´´åˆ°PPT)";
                    alert("âœ… " + tip);
                });
            }
        }

        function clearAll() {
            input.value = "";
            updateDisplay();
            input.focus();
        }

        // åˆå§‹åŒ–
        window.onload = () => {
            setLang('cn'); // é»˜è®¤ä¸­æ–‡
            if(input.value) updateDisplay();
        };
    </script>
</body>
</html>
